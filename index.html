<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ENDLESS QUEST - Ë¶öÈÜí„ÅÆÂàª - (Inflation Ver)</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Noto+Serif+JP:wght@700&display=swap" rel="stylesheet">
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg-color: #000000;
            --win-bg: #000000;
            --text-main: #f0f0f0;
            --text-dim: #a0a0a0;
            --border-color: #f0f0f0;
            --border-style: 4px double var(--border-color);
            --radius: 6px;
            
            --accent-red: #e74c3c;
            --accent-blue: #3498db;
            --accent-green: #2ecc71;
            --accent-yellow: #f1c40f;
            --accent-purple: #9b59b6;
            --accent-cyan: #1abc9c;
            --accent-gold: #ffd700;
            
            --font-main: 'DotGothic16', sans-serif;
            --font-serif: 'Noto Serif JP', serif;
            
            --gauge-h: 40px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background: #111;
            color: var(--text-main);
            font-family: var(--font-main);
            margin: 0;
            height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            user-select: none;
        }

        /* --- LAYOUT STRUCTURE --- */
        .game-wrapper {
            width: 100%;
            max-width: 640px;
            height: 100%;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            position: relative;
            padding-bottom: env(safe-area-inset-bottom); 
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* --- 1. STAGE VIEW (TOP HALF) --- */
        .view-port {
            flex-grow: 1;
            position: relative;
            background: #000;
            border-bottom: var(--border-style);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)),
                linear-gradient(0deg, transparent 24%, #222 25%, #222 26%, transparent 27%, transparent 74%, #222 75%, #222 76%, transparent 77%, transparent),
                linear-gradient(90deg, transparent 24%, #222 25%, #222 26%, transparent 27%, transparent 74%, #222 75%, #222 76%, transparent 77%, transparent);
            background-size: 40px 40px;
        }
        
        .defense-mode .view-port {
            box-shadow: inset 0 0 50px var(--accent-blue);
            border-color: var(--accent-blue);
        }

        .character {
            width: 140px; height: 140px;
            position: relative;
            z-index: 10;
            filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5));
            transition: transform 0.2s, opacity 0.3s;
        }

        /* Drama Window */
        .drama-window {
            position: absolute;
            top: 10px; left: 10px; right: 10px;
            background: #000;
            border: var(--border-style);
            border-radius: var(--radius);
            padding: 10px;
            z-index: 20;
            display: none;
            flex-direction: row;
            align-items: flex-start;
            gap: 12px;
        }
        .drama-actor-box { width: 40px; height: 40px; background: #222; border: 2px solid #555; flex-shrink: 0; }
        .drama-text-box { flex-grow: 1; display: flex; flex-direction: column; text-align: left; }
        .drama-name-label { color: var(--accent-yellow); font-size: 0.8rem; margin-bottom: 4px; }
        .drama-lines { font-size: 0.95rem; line-height: 1.4; color: #fff; }

        /* Popups */
        .cutin, .chain-pop {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            pointer-events: none; z-index: 50;
            white-space: nowrap;
        }
        .cutin {
            background: rgba(0,0,0,0.9);
            border: var(--border-style);
            border-color: var(--accent-red);
            padding: 15px 30px;
            font-size: 2rem;
            color: #fff;
            font-family: var(--font-serif);
        }
        .cutin.just { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        
        .chain-pop {
            font-family: var(--font-serif);
            font-size: 3rem;
            color: var(--accent-yellow);
            text-shadow: 2px 2px 0 #000;
        }

        .damage-pop {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-size: 2rem; font-weight: bold; 
            z-index: 30; opacity: 0; pointer-events: none;
            text-shadow: 2px 2px 0 #000;
        }
        .damage-pop.deal { top: 45%; color: #fff; font-size: 3rem; }
        .damage-pop.deal.crit { color: var(--accent-yellow); font-size: 4rem; }
        .damage-pop.take { top: 60%; color: var(--accent-red); }
        .damage-pop.heal { top: 50%; color: var(--accent-green); }
        .damage-pop.block { top: 55%; color: var(--accent-blue); }
        .damage-pop.miss { top: 45%; color: #888; }
        @keyframes pop-damage { 
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 
            20% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; } 
            100% { transform: translate(-50%, -50px) scale(1); opacity: 0; } 
        }

        /* --- 2. GAUGE AREA --- */
        .gauge-container {
            height: var(--gauge-h);
            background: #000;
            border-bottom: 2px solid #333;
            position: relative;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        .gauge-area {
            width: 95%; height: 24px;
            background: #222;
            border: 2px solid #fff;
            border-radius: 4px;
            position: relative;
            display: none;
            overflow: hidden;
        }
        .gauge-bar {
            width: 100%; height: 100%;
            background: linear-gradient(90deg, 
                #3498db 0%, #3498db 40%, 
                #f1c40f 40%, #f1c40f 45%, 
                #e74c3c 45%, #e74c3c 55%, 
                #f1c40f 55%, #f1c40f 60%, 
                #3498db 60%, #3498db 100%);
        }
        .gauge-cursor {
            position: absolute; top: -2px; bottom: -2px;
            width: 4px; background: #fff;
            border: 1px solid #000;
            left: 0%;
            box-shadow: 0 0 4px #fff;
        }

        /* --- 3. CONSOLE (BOTTOM HALF) --- */
        .console-panel {
            background: #000;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            flex-shrink: 0;
        }

        /* --- UPDATED STATUS WINDOW (Grid Layout) --- */
        .status-window {
            border: var(--border-style);
            border-radius: var(--radius);
            padding: 6px 10px;
            font-size: 0.85rem;
            line-height: 1.3;
            background: #000;
        }
        /* Top Row: 3 cols */
        .status-top-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 4px;
        }
        .status-cell { display: flex; flex-direction: column; }
        .status-kv { display: flex; align-items: baseline; justify-content: space-between; margin-right: 5px; }
        
        /* Equip Row: Flex column */
        .status-equip-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 4px;
            border-top: 1px dashed #333;
            padding-top: 4px;
        }
        .equip-box {
            font-size: 0.7rem;
            color: #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .equip-icon { color: #888; font-size: 0.7rem; min-width: 14px; }

        .val-hp { color: var(--accent-green); }
        .val-mp { color: var(--accent-blue); }
        .val-gold { color: var(--accent-yellow); }
        .status-label { color: var(--text-dim); font-size: 0.7rem; margin-right: 4px; }
        
        .chain-display { font-family: var(--font-serif); font-size: 1.1rem; color: var(--accent-yellow); }
        .awakening-text { font-size: 0.8rem; color: var(--accent-blue); animation: blink 1s infinite; display: none; }
        @keyframes blink { 50% { opacity: 0.3; } }

        /* Log & Command Area */
        .action-row {
            display: flex;
            height: 140px;
            gap: 5px;
        }

        .log-window {
            flex: 1;
            border: var(--border-style);
            border-radius: var(--radius);
            padding: 8px;
            overflow-y: hidden;
            font-size: 0.85rem;
            line-height: 1.5;
            display: flex;
            flex-direction: column-reverse;
            background: #000;
        }
        .log-entry { margin-bottom: 2px; word-break: break-all; }
        .log-entry.damage { color: var(--accent-red); }
        .log-entry.critical { color: var(--accent-yellow); }
        .log-entry.revive { color: var(--accent-green); }
        .log-entry.system { color: var(--accent-cyan); }
        .log-entry.item { color: var(--accent-purple); }
        .log-entry.block { color: var(--accent-blue); }
        .log-entry.flavor { color: #666; font-size: 0.75rem; font-style: italic; }

        .command-window {
            width: 140px;
            flex-shrink: 0;
            border: var(--border-style);
            border-radius: var(--radius);
            padding: 4px;
            background: #000;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* Command Buttons */
        .cmd-btn {
            background: #000;
            color: #fff;
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 8px 4px;
            text-align: left;
            font-family: var(--font-main);
            font-size: 1rem;
            cursor: pointer;
            position: relative;
            padding-left: 15px;
            transition: transform 0.05s;
        }
        .cmd-btn::before {
            content: '‚ñ∂'; position: absolute; left: 2px; top: 50%; transform: translateY(-50%);
            opacity: 0; color: var(--accent-yellow); font-size: 0.8rem;
        }
        .cmd-btn:active { transform: translateY(2px); background: #222; }
        .cmd-btn:hover::before, .cmd-btn:active::before { opacity: 1; }
        .cmd-btn:disabled { color: #444; pointer-events: none; }
        
        /* Selected State for Shop Multiplier */
        .cmd-btn.selected {
            background: #222;
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .main-btn-full {
            width: 100%; height: 100%;
            background: #111;
            border: 2px solid #fff;
            border-radius: 4px;
            color: #fff;
            font-family: var(--font-main);
            font-size: 1.2rem;
            cursor: pointer;
        }
        .main-btn-full:active { background: #333; }

        /* STOP / GUARD BIG BUTTON */
        .btn-action-overlay {
            position: absolute; bottom: 5px; right: 5px; left: 5px;
            height: 140px; z-index: 150; display: none;
        }
        .btn-big-action {
            width: 100%; height: 100%;
            font-size: 2rem; font-weight: bold; font-family: var(--font-serif);
            border: 4px double #fff; border-radius: 8px;
            text-shadow: 2px 2px 0 #000; cursor: pointer;
        }
        .btn-stop { background: rgba(180, 0, 0, 0.9); color: #fff; border-color: #f88; }
        .btn-guard { background: rgba(0, 50, 150, 0.9); color: #0ff; border-color: #0ff; }

        /* Header */
        .header-bar {
            display: flex; gap: 5px; align-items: center; padding: 5px;
            background: #000; border-bottom: 1px solid #333;
        }
        .icon-btn {
            width: 32px; height: 32px;
            border: 2px solid #fff; border-radius: 4px;
            background: #000; color: #fff;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
            font-size: 0.9rem;
        }
        .icon-btn.active {
            background: #044; color: var(--accent-cyan); border-color: var(--accent-cyan);
        }
        .progress-container {
            flex-grow: 1; height: 12px; background: #222; border: 1px solid #555; position: relative;
        }
        .progress-fill { height: 100%; background: #e74c3c; width: 0%; transition: width 0.5s; }
        .progress-text { position: absolute; top: -18px; right: 0; font-size: 0.7rem; color: #888; }

        /* UI UPDATE: Generation Bar */
        .generation-bar {
            background: #100;
            border-bottom: var(--border-style);
            border-color: #522;
            padding: 4px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: var(--font-serif);
            font-size: 0.9rem;
            color: #ccc;
        }
        .gen-hero { color: var(--accent-cyan); }
        .gen-demon { color: var(--accent-red); }

        ruby { font-family: var(--font-main); }
        rt { font-size: 0.5em; color: var(--text-dim); text-align: center; transform: translateY(-2px); }

        /* Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 200;
            display: none; justify-content: center; align-items: center;
            padding: 20px;
        }
        .modal-window {
            width: 100%; max-width: 500px;
            background: #000;
            border: var(--border-style);
            border-radius: var(--radius);
            padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            max-height: 80vh; overflow-y: auto;
        }
        .modal-title { 
            font-size: 1.2rem; color: var(--accent-yellow); text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #555; padding-bottom: 5px;
        }
        .grid-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; }
        .list-item { 
            border: 1px solid #444; padding: 4px; text-align: center; font-size: 0.7rem; color: #666; 
            display: flex; flex-direction: column; align-items: center; min-height: 70px; justify-content: space-between;
        }
        .list-item.got { border-color: #fff; color: #fff; }
        .list-item.soul { border-color: var(--accent-purple); }

        /* Overlays */
        .overlay-center {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 40;
            display: none; flex-direction: column; justify-content: center; align-items: center;
            padding: 20px; text-align: center;
        }
        .chest-card {
            border: 2px solid #fff; padding: 10px; margin: 5px; width: 140px;
            background: #111; display: flex; flex-direction: column; align-items: center;
        }
        .chest-card.new { border-color: var(--accent-yellow); background: #221; }

        .flash, .flash-invert {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; opacity: 0;
        }
        .flash { background: #fff; z-index: 90; transition: opacity 0.1s; }
        .flash-invert { background: #fff; mix-blend-mode: difference; z-index: 91; }
        .anim-invert { animation: invert-flash 0.15s; }
        @keyframes invert-flash { 0% { opacity: 0.8; } 100% { opacity: 0; } }

        .click-start { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: #000; color: #fff; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 999; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="game-wrapper" id="game-container">
    
    <!-- HEADER -->
    <div class="header-bar">
        <button class="icon-btn" onclick="game.openHelp()">?</button>
        <!-- ADDED: Mute Button -->
        <button class="icon-btn" id="btn-mute" onclick="game.toggleMute()">üîä</button>
        <button class="icon-btn" id="btn-speed" onclick="game.toggleSpeed()" style="font-size:0.7rem; width:40px;">x1</button>
        <!-- ADDED: Auto Button -->
        <button class="icon-btn" id="btn-auto" onclick="game.toggleAutoMode()" style="font-size:0.6rem; width:44px;">AUTO</button>
        
        <div class="progress-container">
            <div class="progress-fill" id="progress-bar"></div>
            <div class="progress-text" id="progress-text">È≠îÁéãÂüé„Åæ„Åß ???</div>
        </div>
    </div>

    <!-- UI UPDATE: GENERATION INFO -->
    <div class="generation-bar">
        <span class="gen-hero">Á¨¨<span id="gen-hero-num">1</span>‰ª£ ÂãáËÄÖ</span>
        <span style="font-size:0.7rem; color:#555;">VS</span>
        <span class="gen-demon">Á¨¨<span id="gen-demon-num">1</span>‰ª£ È≠îÁéã</span>
    </div>

    <!-- MAIN STAGE -->
    <div class="view-port" id="stage">
        <div class="flash" id="flash"></div>
        <div class="flash-invert" id="flash-invert"></div>
        <div class="danger-overlay" id="danger-overlay" style="display:none; position:absolute; inset:0; box-shadow:inset 0 0 50px #500; pointer-events:none; z-index:5;"></div>
        
        <div id="drama-window" class="drama-window">
            <div id="drama-actor-box" class="drama-actor-box character" style="width:40px;height:40px;"></div>
            <div class="drama-text-box">
                <div id="drama-name" class="drama-name-label">???</div>
                <div id="drama-text" class="drama-lines">...</div>
            </div>
        </div>

        <div class="cutin" id="cutin"></div>
        <div class="chain-pop" id="chain-pop"></div>
        <div id="damage-pop" class="damage-pop">0</div>
        
        <div id="enemy-slot" class="character"></div>

        <!-- Overlays -->
        <div id="chest-display" class="overlay-center">
            <div style="display:flex; align-items:center;">
                <div class="chest-card current">
                    <div style="font-size:0.7rem; color:#888;">Ë£ÖÂÇô‰∏≠ (Â£≤Âç¥)</div>
                    <div id="cur-icon" style="width:48px;height:48px;"></div>
                    <div id="cur-name" style="font-size:0.8rem; height:2.5em; display:flex; align-items:center; justify-content:center;"></div>
                    <div id="cur-stat" style="font-weight:bold;"></div>
                    <div id="cur-sub" style="font-size:0.7rem; color:#aaa;"></div>
                    <div id="cur-effect" style="font-size:0.7rem; color:var(--accent-purple);"></div>
                </div>
                <div style="font-size:2rem; color:#666;">‚û°</div>
                <div class="chest-card new">
                    <div style="font-size:0.7rem; color:var(--accent-yellow);">NEW</div>
                    <div id="new-icon" style="width:48px;height:48px;"></div>
                    <div id="new-name" style="font-size:0.8rem; height:2.5em; display:flex; align-items:center; justify-content:center;"></div>
                    <div id="new-stat" style="font-weight:bold;"></div>
                    <div id="new-sub" style="font-size:0.7rem; color:#aaa;"></div>
                    <div id="new-effect" style="font-size:0.7rem; color:var(--accent-purple);"></div>
                </div>
            </div>
        </div>

        <div id="event-display" class="overlay-center">
            <div id="event-title" style="font-size:1.5rem; color:var(--accent-cyan); margin-bottom:15px; font-family:var(--font-serif);">EVENT</div>
            <div id="event-desc" style="margin-bottom:20px; line-height:1.6;">...</div>
            <div id="event-choices" style="display:grid; gap:10px; width:100%; max-width:240px;"></div>
        </div>

        <div id="item-pop" class="overlay-center" style="background:rgba(0,0,0,0.8);">
            <div class="item-name" style="color:var(--accent-yellow); margin-bottom:10px;">GET!</div>
            <div id="item-icon-slot" class="character" style="width:64px;height:64px; margin-bottom:10px;"></div>
            <div id="item-name-disp" style="font-size:1.2rem; margin-bottom:5px;"></div>
            <div>„ÇíÊâã„Å´ÂÖ•„Çå„ÅüÔºÅ</div>
        </div>
    </div>

    <!-- GAUGE -->
    <div class="gauge-container" id="gauge-container-wrapper">
        <div class="gauge-area" id="gauge-area">
            <div class="gauge-bar"></div>
            <div class="gauge-cursor" id="gauge-cursor"></div>
        </div>
    </div>

    <!-- CONSOLE -->
    <div class="console-panel">
        <div class="status-window">
            <div class="status-top-row">
                <div class="status-cell">
                    <div class="status-kv"><span class="status-label">HP</span><span id="disp-hp" class="val-hp">30</span></div>
                    <div class="status-kv"><span class="status-label">Êîª</span><span id="disp-atk">0</span></div>
                </div>
                <div class="status-cell">
                    <div class="status-kv"><span class="status-label">MP</span><span id="disp-mp" class="val-mp">10</span></div>
                    <div class="status-kv"><span class="status-label">ÂÆà</span><span id="disp-def">0</span></div>
                </div>
                <div class="status-cell" style="text-align:right;">
                    <div><span class="status-label">LV</span><span id="disp-lv">1</span></div>
                    <div><span class="status-label">G</span><span id="disp-gold" class="val-gold">0</span></div>
                </div>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2px;">
                <span class="chain-display"><span style="font-size:0.7rem; color:#888;">ÈÄ£ÊíÉ</span> <span id="disp-chain">0</span></span>
                <span id="awake-txt" class="awakening-text">‚â™Áµ∂ÂØæÈò≤Âæ°Áïå‚â´</span>
                <span id="disp-aura" style="font-size:0.8rem; color:#555;">READY</span>
            </div>
            <!-- Expanded Equipment Display -->
            <div class="status-equip-row">
                <div class="equip-box" title="Ê≠¶Âô®"><span class="equip-icon">‚öîÔ∏è</span><span id="disp-weapon">Á¥†Êâã</span></div>
                <div class="equip-box" title="Èò≤ÂÖ∑"><span class="equip-icon">üõ°Ô∏è</span><span id="disp-armor">Êúç</span></div>
                <div class="equip-box" title="Ë£ÖÈ£æ"><span class="equip-icon">üíç</span><span id="disp-acc">„Å™„Åó</span></div>
            </div>
            <span id="disp-title" style="display:none;"></span>
        </div>

        <div class="action-row">
            <div class="log-window" id="log">
                <div class="log-entry system">Á¨¨1‰ª£ ÂãáËÄÖ„ÄÅ<ruby>ÂÜíÈô∫„ÅÆÊõ∏<rt>„ÇØ„É≠„Éã„ÇØ„É´</rt></ruby>„ÇíÈñã„Åè</div>
            </div>

            <!-- Command Menu -->
            <div class="command-window">
                <button id="btn-main" class="main-btn-full" onclick="game.handleMainBtn()">ÈñãÂßã</button>
                
                <div id="menu-battle" style="display:none; flex-direction:column; gap:4px; height:100%;">
                    <button class="cmd-btn" onclick="game.selectAttack()">„Åü„Åü„Åã„ÅÜ</button>
                    <button class="cmd-btn" onclick="game.openSkills()">Âë™Êñá„ÉªÁâπÊäÄ</button>
                    <button class="cmd-btn" onclick="game.selectHeal()">Ëñ¨Ëçâ„ÉªÊ≤ªÁôí</button>
                    <button class="cmd-btn" style="color:var(--text-dim);" onclick="game.openLibrary()">Ë®òÈå≤„ÇíË¶ã„Çã</button>
                </div>

                <div id="menu-chest" style="display:none; flex-direction:column; gap:4px; height:100%;">
                    <div style="font-size:0.6rem; color:#888; text-align:center;">Âè§„ÅÑË£ÖÂÇô„ÅØÂ£≤Âç¥„Åï„Çå„Åæ„Åô</div>
                    <button id="btn-get" class="cmd-btn" style="color:var(--accent-yellow);" onclick="game.decideItem(true)">Êâã„Å´ÂÖ•„Çå„Çã</button>
                    <button id="btn-discard" class="cmd-btn" onclick="game.decideItem(false)">„ÅÇ„Åç„Çâ„ÇÅ„Çã</button>
                </div>

                <div id="menu-skills" style="display:none; flex-direction:column; gap:4px; height:100%; overflow-y:auto;"></div>
            </div>
        </div>
        
        <div class="btn-action-overlay" id="btn-stop-wrapper" style="display:none;">
             <button id="btn-stop" class="btn-big-action btn-stop" onmousedown="game.handleActionBtn()" ontouchstart="game.handleActionBtn()">STOP!</button>
        </div>
    </div>

    <!-- MODALS -->
    <div id="lib-modal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-title">ÂÜíÈô∫„ÅÆË®òÈå≤ <span id="lib-comp" style="font-size:0.8rem; color:#888; margin-left:10px;"></span></div>
            <div id="lib-grid" class="grid-list"></div>
            <button class="cmd-btn" style="text-align:center; margin-top:10px;" onclick="game.closeLibrary()">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <div id="help-modal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-title">ÂÜíÈô∫„ÅÆÂøÉÂæó</div>
            <div style="font-size:0.9rem; line-height:1.6; color:#ccc;">
                <p>Âú∞‰∏ã30Èöé„ÅÆÈ≠îÁéã„ÇíË®é‰ºê„Åõ„Çà„ÄÇ<br>Âë®Âõû„Åô„Çã„Åî„Å®„Å´Êïµ„ÅØÂº∑Â§ß„Å´„Å™„Çã„ÄÇ</p>
                <p><strong>[AUTO„É¢„Éº„Éâ]</strong><br>Êà¶Èóò„Å®Ë£ÖÂÇôÈÅ∏Êäû„ÇíËá™ÂãïÂåñ„Åó„Åæ„Åô„ÄÇ<br>‚ÄªÈ≠îÁéãÊà¶„Åß„ÅØËá™Âãï„ÅßËß£Èô§„Åï„Çå„Åæ„Åô„ÄÇ<br>‚ÄªÈÅã(LUCK)„ÅåÈ´ò„ÅÑ„Åª„Å©Á≤æÂ∫¶„ÅåÂêë‰∏ä„Åó„Åæ„Åô„ÄÇ</p>
                <p><strong>[Áµ∂ÂØæÈò≤Âæ°Áïå]</strong><br>ÈÄ£ÊíÉ5‰ª•‰∏ä„ÅßËá™ÂãïÁô∫Âãï„ÄÇMP„ÇíÊ∂àË≤ª„Åó„Å¶„ÉÄ„É°„Éº„Ç∏„ÇíÁÑ°ÂäπÂåñ„ÄÇ</p>
                <p><strong>[Ë¶ãÂàá„Çä (Just Guard)]</strong><br>ÊïµÊîªÊíÉ„Å´Âêà„Çè„Åõ„Å¶Èò≤Âæ°„Éú„Çø„É≥„ÇíÊäº„Åõ„ÄÇ</p>
            </div>
            <div style="display:flex; gap:5px;">
                <button class="cmd-btn" style="flex:1; text-align:center;" onclick="game.openLibrary()">Âõ≥Èëë„ÇíË¶ã„Çã</button>
                <button class="cmd-btn" style="flex:1; text-align:center;" onclick="game.closeHelp()">Èñâ„Åò„Çã</button>
            </div>
            <button style="background:#300; border:1px solid #f00; color:#f88; padding:5px; margin-top:20px;" onclick="game.resetSaveData()">Ë®òÈå≤Ê∂àÂéª</button>
        </div>
    </div>

    <!-- UI UPDATE: Shop with Multiplier -->
    <div id="shop-modal" class="modal-overlay">
        <div class="modal-window">
            <div class="modal-title">ÈóáÂ∏Ç</div>
            <div style="text-align:center; margin-bottom:5px;">ÊâÄÊåÅÈáë: <span id="shop-gold" style="color:var(--accent-yellow)">0</span> G</div>
            
            <!-- Bulk Buy Toggles -->
            <div style="display:flex; justify-content:center; gap:5px; margin-bottom:10px;">
                <button class="cmd-btn selected" id="shop-mult-1" onclick="game.setShopMultiplier(1)" style="flex:1; text-align:center;">x1</button>
                <button class="cmd-btn" id="shop-mult-10" onclick="game.setShopMultiplier(10)" style="flex:1; text-align:center;">x10</button>
                <button class="cmd-btn" id="shop-mult-max" onclick="game.setShopMultiplier('MAX')" style="flex:1; text-align:center;">MAX</button>
            </div>

            <div class="grid-list" style="grid-template-columns: 1fr 1fr;">
                <button class="cmd-btn" style="text-align:center;" onclick="game.buyBoost('hp')">HPÂº∑Âåñ<br><span id="cost-hp" style="color:var(--accent-yellow)">500G</span></button>
                <button class="cmd-btn" style="text-align:center;" onclick="game.buyBoost('mp')">MPÂº∑Âåñ<br><span id="cost-mp" style="color:var(--accent-yellow)">500G</span></button>
                <button class="cmd-btn" style="text-align:center;" onclick="game.buyBoost('atk')">ÂäõÂº∑Âåñ<br><span id="cost-atk" style="color:var(--accent-yellow)">1000G</span></button>
                <button class="cmd-btn" style="text-align:center;" onclick="game.buyBoost('def')">ÂÆà„ÇäÂº∑Âåñ<br><span id="cost-def" style="color:var(--accent-yellow)">1000G</span></button>
                <button class="cmd-btn" style="text-align:center;" onclick="game.buyBoost('luck')">ÈÅãÂº∑Âåñ<br><span id="cost-luck" style="color:var(--accent-yellow)">2000G</span></button>
            </div>
            <button class="cmd-btn" style="text-align:center; margin-top:20px; border-color:var(--accent-purple);" onclick="game.softReset()">Ê¨°„ÅÆ‰∏ñ‰ª£„Å∏Ë®ó„Åô</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal-go" style="flex-direction:column; gap:20px;">
        <h1 style="color:var(--accent-red); font-size:3rem; font-family:var(--font-serif);">Ê≠ª</h1>
        <p>Âà∞ÈÅî: Âú∞‰∏ã <span id="final-score">0</span> Èöé</p>
        <button class="cmd-btn" style="padding:10px 30px;" onclick="game.openShop()">ÈóáÂ∏Ç„Å∏</button>
    </div>

    <div class="click-start" id="click-start" onclick="game.initAudio()">
        <div style="font-size:2rem; font-family:var(--font-serif); margin-bottom:20px;">ENDLESS QUEST</div>
        <div style="font-size:0.9rem; animation:blink 1s infinite;">CLICK TO START</div>
    </div>
</div>

<script>
class SoundManager {
    constructor() { 
        this.ctx = null; 
        this.bgmOscs = []; 
        this.muted = false; // ADDED: Mute flag
    }
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
    
    // ADDED: Mute toggle method
    toggleMute() {
        this.muted = !this.muted;
        if(this.muted) this.stopBGM();
        return this.muted;
    }

    playSE(type) {
        if (!this.ctx || this.muted) return; // CHANGED: Check mute
        const t = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        if (type==='select') { o.type='square'; o.frequency.setValueAtTime(440,t); o.frequency.exponentialRampToValueAtTime(880,t+0.05); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.05); o.start(t); o.stop(t+0.05); }
        else if (type==='attack') { o.type='sawtooth'; o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(50,t+0.1); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.1); o.start(t); o.stop(t+0.1); }
        else if (type==='hit') { o.type='square'; o.frequency.setValueAtTime(100,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(t); o.stop(t+0.1); }
        else if (type==='parry') { o.type='triangle'; o.frequency.setValueAtTime(800,t); o.frequency.linearRampToValueAtTime(1600,t+0.05); g.gain.setValueAtTime(0.3,t); g.gain.linearRampToValueAtTime(0,t+0.2); o.start(t); o.stop(t+0.2); }
        else if (type==='crit') { o.type='square'; o.frequency.setValueAtTime(880,t); o.frequency.setValueAtTime(1760,t+0.1); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.3); o.start(t); o.stop(t+0.3); }
        else if (type === 'revive') {
            const freqs = [523.25, 659.25, 783.99, 1046.50, 1318.51, 2093.00]; 
            freqs.forEach((f, i) => {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination); osc.type = 'triangle'; osc.frequency.value = f;
                gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.1, t + i*0.05 + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, t + i*0.05 + 1.5);
                osc.start(t + i*0.05); osc.stop(t + i*0.05 + 1.5);
            });
            o.disconnect();
        } else if (type==='coin') { o.type='sine'; o.frequency.setValueAtTime(1200,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.2); o.start(t); o.stop(t+0.2); }
        else if (type==='metal') { o.type='square'; o.frequency.setValueAtTime(1500,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.05); o.start(t); o.stop(t+0.05); }
    }
    playBGM(type) {
        if (!this.ctx || this.muted) return; // CHANGED: Check mute
        this.stopBGM();
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); const f = this.ctx.createBiquadFilter();
        o.connect(f); f.connect(g); g.connect(this.ctx.destination);
        o.type='sawtooth'; f.type='lowpass'; f.frequency.value=300;
        const t = this.ctx.currentTime;
        if(type==='battle'){ o.frequency.setValueAtTime(55,t); g.gain.value=0.05; }
        else if(type==='boss'){ o.frequency.setValueAtTime(40,t); g.gain.value=0.08; }
        else if(type==='awake'){ o.frequency.setValueAtTime(110,t); g.gain.value=0.08; f.frequency.setValueAtTime(600, t); o.type='square';}
        else if(type==='clear'){ o.frequency.setValueAtTime(440,t); g.gain.value=0.03; }
        o.start(); this.bgmOscs.push({o,g});
    }
    stopBGM() { this.bgmOscs.forEach(obj=>{try{obj.o.stop();obj.o.disconnect();}catch(e){}}); this.bgmOscs=[]; }
}

const SAVE_KEY = 'EQ_SAVE_INFLATION_V1';
const WEAPON_PREFIXES = [
    {t:"ÊúΩ„Å°„Åü",r:"„ÇØ„ÉÅ„Çø"}, {t:"ÈâÑÂ°ä„ÅÆ",r:"„ÉÜ„ÉÉ„Ç´„Ç§„Éé"}, {t:"ÁÖâÁçÑ„ÅÆ",r:"„É¨„É≥„Ç¥„ÇØ„Éé"}, {t:"ÂêçÂ∑•„ÅÆ",r:"„É°„Ç§„Ç≥„Ç¶„Éé"}, 
    {t:"ËôöÁÑ°„ÅÆ",r:"„É¥„Ç©„Ç§„Éâ"}, {t:"Áµ∂ÂØæÈõ∂Â∫¶",r:"„Ç¢„Éñ„ÇΩ„É™„É•„Éº„Éà"}, {t:"Èõ∑ÂÖâ„ÅÆ",r:"„É©„Ç§„Éà„Éã„É≥„Ç∞"}, {t:"ËÅñ„Å™„Çã",r:"„Éõ„Éº„É™„Éº"}, 
    {t:"Ê∑±Ê∑µ„ÅÆ",r:"„Ç¢„Éì„Çπ"}, {t:"Á•ûË©±„ÅÆ",r:"„Éü„ÇΩ„É≠„Ç∏„Éº"}, {t:"ÈªÑÊòè„ÅÆ",r:"„Éà„ÉØ„Ç§„É©„Ç§„Éà"}, {t:"ÁµÇÁÑâ„ÅÆ",r:"„Ç´„Çø„Çπ„Éà„É≠„Éï„Ç£"},
    {t:"Á•ûÊÆ∫„Åó„ÅÆ",r:"„Ç¥„ÉÉ„Éâ„Çπ„É¨„Ç§„É§„Éº"}, {t:"Á¶ÅÂøå„ÅÆ",r:"„Çø„Éñ„Éº"}, {t:"ÂπªÂΩ±„ÅÆ",r:"„Éï„Ç°„É≥„Éà„É†"}, {t:"Ë°ÄÂ°ó„Çâ„Çå„Åü",r:"„Éñ„É©„ÉÉ„Éá„Ç£"}
];
const WEAPON_COLORS = ["#888", "#abc", "#d44", "#da8", "#a4a", "#8df", "#fd0", "#ff8", "#808", "#f4f", "#f84", "#444", "#f00", "#606", "#88f", "#900"];

function generateSVG(data, colorOverride=null, metal=false) {
    if (!data || !data.pixels) return '<svg viewBox="0 0 16 16"></svg>';
    let rects = ""; const baseColor = colorOverride || data.color;
    data.pixels.forEach(p => { rects += `<rect x="${p.x}" y="${p.y}" width="${p.w}" height="${p.h}" fill="${p.c||baseColor}" shape-rendering="crispEdges"/>`; });
    let filter = "filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5));";
    if (metal) filter = "filter: drop-shadow(0 0 5px #fff) brightness(1.5) contrast(1.2);";
    return `<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" style="image-rendering: pixelated; width: 100%; height: 100%; ${filter}">${rects}</svg>`;
}

const SPRITES = {
    stick: { color: "#a84", pixels: [{x:6,y:11,w:4,h:4,c:"#753"},{x:7,y:3,w:2,h:10,c:"#964"},{x:8,y:2,w:1,h:2,c:"#bd6"}] },
    club: { color: "#953", pixels: [{x:6,y:11,w:4,h:4,c:"#531"},{x:7,y:8,w:2,h:3,c:"#853"},{x:5,y:2,w:6,h:6,c:"#742"},{x:5,y:2,w:2,h:2,c:"#b86"},{x:9,y:5,w:2,h:2,c:"#421"}] },
    sword: { color:"#ccc", pixels:[{x:6,y:12,w:4,h:4,c:"#531"},{x:4,y:11,w:8,h:1,c:"#daa520"},{x:7,y:11,w:2,h:2,c:"#daa520"},{x:6,y:1,w:4,h:10,c:"#aaa"},{x:6,y:1,w:2,h:10,c:"#eee"},{x:7,y:2,w:1,h:8,c:"#fff"}] },
    axe: { color:"#888", pixels:[{x:6,y:12,w:4,h:4,c:"#531"},{x:7,y:3,w:2,h:10,c:"#742"},{x:3,y:2,w:10,h:5,c:"#888"},{x:3,y:2,w:8,h:1,c:"#ccc"},{x:3,y:3,w:1,h:3,c:"#eee"},{x:11,y:3,w:2,h:3,c:"#444"}] },
    spear: { color:"#ccc", pixels:[{x:7,y:11,w:2,h:5,c:"#742"},{x:7,y:4,w:2,h:8,c:"#964"},{x:6,y:1,w:4,h:4,c:"#ccc"},{x:7,y:1,w:2,h:2,c:"#fff"}] },
    hammer: { color:"#654", pixels:[{x:7,y:7,w:2,h:9,c:"#532"},{x:3,y:2,w:10,h:5,c:"#444"},{x:3,y:2,w:10,h:1,c:"#888"},{x:4,y:3,w:8,h:3,c:"#222"}] },
    wand: { color:"#a4a", pixels:[{x:7,y:6,w:2,h:10,c:"#852"},{x:5,y:2,w:6,h:4,c:"#909"},{x:6,y:3,w:4,h:2,c:"#f0f"},{x:7,y:3,w:2,h:2,c:"#fff"}] },
    scythe: { color:"#a4e", pixels:[{x:8,y:3,w:2,h:13,c:"#422"},{x:2,y:2,w:10,h:2,c:"#ccc"},{x:2,y:2,w:2,h:8,c:"#eee"},{x:3,y:3,w:1,h:6,c:"#fff"}]},
    hero_w: { color: "#48f", pixels: [{x:6,y:11,w:4,h:5,c:"#222"},{x:3,y:10,w:10,h:2,c:"#d4af37"},{x:5,y:1,w:6,h:10,c:"#005"},{x:6,y:1,w:2,h:9,c:"#48f"},{x:6,y:2,w:1,h:8,c:"#aaf"},{x:7,y:10,w:2,h:2,c:"#f00"}] },
    metal_w: { color: "#444", pixels: [{x:7,y:11,w:2,h:5,c:"#111"},{x:4,y:10,w:8,h:2,c:"#444"},{x:6,y:1,w:4,h:10,c:"#666"},{x:6,y:1,w:2,h:10,c:"#aaa"},{x:5,y:7,w:6,h:1,c:"#f00"},{x:5,y:8,w:6,h:1,c:"#300"}] },
    a_cloth: { color: "#dca", pixels: [{x:3,y:3,w:10,h:11,c:"#b86"},{x:5,y:3,w:6,h:4,c:"#eeb"},{x:4,y:4,w:2,h:8,c:"#964"},{x:10,y:4,w:2,h:8,c:"#964"}] },
    a_leather: { color: "#a64", pixels: [{x:3,y:3,w:10,h:11,c:"#742"},{x:4,y:4,w:8,h:8,c:"#964"},{x:2,y:3,w:3,h:4,c:"#531"},{x:11,y:3,w:3,h:4,c:"#531"},{x:6,y:5,w:4,h:4,c:"#b86"}] },
    a_chain: { color: "#888", pixels: [{x:3,y:2,w:10,h:12,c:"#444"},{x:2,y:3,w:12,h:4,c:"#666"},{x:4,y:6,w:8,h:8,c:"#888"},{x:5,y:7,w:1,h:1,c:"#ccc"},{x:7,y:7,w:1,h:1,c:"#ccc"},{x:9,y:7,w:1,h:1,c:"#ccc"}] },
    a_iron: { color: "#abc", pixels: [{x:2,y:2,w:12,h:12,c:"#567"},{x:3,y:3,w:10,h:10,c:"#89a"},{x:4,y:4,w:8,h:6,c:"#bce"},{x:5,y:5,w:2,h:3,c:"#fff"}] },
    a_steel: { color: "#fff", pixels: [{x:2,y:2,w:12,h:12,c:"#789"},{x:3,y:3,w:10,h:10,c:"#abc"},{x:5,y:4,w:6,h:8,c:"#fff"},{x:6,y:5,w:2,h:4,c:"#eef"}] },
    a_dragon: { color: "#a44", pixels: [{x:1,y:2,w:14,h:12,c:"#500"},{x:3,y:3,w:10,h:10,c:"#900"},{x:5,y:5,w:6,h:6,c:"#d22"},{x:6,y:6,w:4,h:2,c:"#fb0"}] },
    a_hero: { color: "#48f", pixels: [{x:1,y:1,w:14,h:14,c:"#004"},{x:3,y:3,w:10,h:10,c:"#248"},{x:5,y:4,w:6,h:8,c:"#48c"},{x:6,y:6,w:4,h:4,c:"#fd0"},{x:7,y:7,w:2,h:2,c:"#f00"}] },
    ring: { color: "#fd0", pixels: [{x:4,y:3,w:8,h:10,c:"#d4af37"},{x:5,y:4,w:6,h:8,c:"#000"},{x:6,y:2,w:4,h:3,c:"#f00"},{x:7,y:3,w:1,h:1,c:"#fff"}] },
    amulet: { color: "#a8f", pixels: [{x:6,y:0,w:4,h:8,c:"#ccc"},{x:5,y:8,w:6,h:6,c:"#62a"},{x:6,y:9,w:4,h:4,c:"#a4d"},{x:7,y:10,w:2,h:2,c:"#fff"}] },
    soul: { color: "#0ff", pixels: [{x:6,y:2,w:4,h:8,c:"#0aa"},{x:4,y:5,w:8,h:6,c:"#0cc"},{x:7,y:4,w:2,h:2,c:"#fff"},{x:5,y:6,w:2,h:2,c:"#fff"},{x:9,y:6,w:2,h:2,c:"#fff"}] },
    slime: { color: "#48f", pixels: [{x:4,y:6,w:8,h:8,c:"#005"},{x:3,y:8,w:10,h:6,c:"#249"},{x:4,y:7,w:8,h:6,c:"#48f"},{x:5,y:9,w:1,h:2,c:"#000"},{x:10,y:9,w:1,h:2,c:"#000"},{x:6,y:9,w:1,h:1,c:"#fff"},{x:5,y:7,w:2,h:1,c:"#bef"},{x:11,y:9,w:1,h:1,c:"#fff"}]},
    bat: { color: "#222", pixels: [{x:1,y:2,w:6,h:4,c:"#404"},{x:9,y:2,w:6,h:4,c:"#404"},{x:5,y:5,w:6,h:6,c:"#222"},{x:4,y:4,w:2,h:3,c:"#111"},{x:10,y:4,w:2,h:3,c:"#111"},{x:6,y:7,w:1,h:1,c:"#f00"},{x:9,y:7,w:1,h:1,c:"#f00"},{x:7,y:9,w:2,h:1,c:"#fff"}]},
    rabbit: { color: "#da8", pixels: [{x:5,y:2,w:2,h:5,c:"#da8"},{x:9,y:2,w:2,h:5,c:"#da8"},{x:4,y:6,w:8,h:7,c:"#c96"},{x:6,y:8,w:1,h:2,c:"#000"},{x:9,y:8,w:1,h:2,c:"#000"},{x:7,y:10,w:2,h:2,c:"#fcc"}]},
    skeleton: { color: "#ddd", pixels: [{x:5,y:2,w:6,h:5,c:"#eee"},{x:6,y:4,w:1,h:1,c:"#000"},{x:9,y:4,w:1,h:1,c:"#000"},{x:6,y:7,w:4,h:5,c:"#ccc"},{x:4,y:8,w:8,h:2,c:"#aaa"},{x:4,y:8,w:1,h:4,c:"#ddd"},{x:11,y:8,w:1,h:4,c:"#ddd"},{x:1,y:4,w:2,h:8,c:"#888"}]},
    ghost: { color: "#eee", pixels: [{x:4,y:2,w:8,h:10,c:"#eef"},{x:2,y:5,w:12,h:8,c:"rgba(255,255,255,0.5)"},{x:5,y:6,w:2,h:2,c:"#000"},{x:9,y:6,w:2,h:2,c:"#000"},{x:6,y:10,w:4,h:2,c:"#f00"},{x:1,y:4,w:2,h:4,c:"#ccf"}]},
    knight: { color: "#889", pixels: [{x:5,y:1,w:6,h:6,c:"#667"},{x:7,y:3,w:2,h:1,c:"#000"},{x:4,y:7,w:8,h:7,c:"#889"},{x:2,y:7,w:2,h:6,c:"#667"},{x:12,y:7,w:2,h:6,c:"#667"},{x:5,y:14,w:2,h:2,c:"#222"},{x:9,y:14,w:2,h:2,c:"#222"},{x:13,y:2,w:2,h:10,c:"#aaa"},{x:1,y:5,w:3,h:8,c:"#445"}]},
    wizard: { color: "#808", pixels: [{x:5,y:2,w:6,h:4,c:"#404"},{x:4,y:5,w:8,h:8,c:"#606"},{x:2,y:5,w:12,h:2,c:"#808"},{x:5,y:6,w:6,h:3,c:"#000"},{x:6,y:7,w:1,h:1,c:"#ff0"},{x:9,y:7,w:1,h:1,c:"#ff0"},{x:1,y:4,w:2,h:10,c:"#a62"},{x:1,y:2,w:2,h:2,c:"#fb0"}]},
    golem: { color: "#b84", pixels: [{x:4,y:1,w:8,h:5,c:"#963"},{x:5,y:3,w:2,h:1,c:"#f00"},{x:9,y:3,w:2,h:1,c:"#f00"},{x:2,y:6,w:12,h:8,c:"#b84"},{x:1,y:6,w:3,h:8,c:"#852"},{x:12,y:6,w:3,h:8,c:"#852"},{x:4,y:14,w:3,h:2,c:"#631"},{x:9,y:14,w:3,h:2,c:"#631"}]},
    mimic: { color: "#d84", pixels: [{x:2,y:3,w:12,h:10,c:"#852"},{x:3,y:4,w:10,h:8,c:"#a63"},{x:1,y:5,w:1,h:6,c:"#d84"},{x:14,y:5,w:1,h:6,c:"#d84"},{x:4,y:8,w:8,h:2,c:"#600"},{x:5,y:8,w:1,h:1,c:"#fff"},{x:7,y:8,w:1,h:1,c:"#fff"},{x:9,y:8,w:1,h:1,c:"#fff"},{x:11,y:8,w:1,h:1,c:"#fff"},{x:5,y:5,w:2,h:2,c:"#ff0"},{x:9,y:5,w:2,h:2,c:"#ff0"}]},
    cerberus: { color: "#840", pixels: [{x:1,y:4,w:4,h:5,c:"#620"},{x:6,y:2,w:4,h:6,c:"#840"},{x:11,y:4,w:4,h:5,c:"#620"},{x:2,y:5,w:1,h:1,c:"#f00"},{x:7,y:4,w:1,h:1,c:"#f00"},{x:12,y:5,w:1,h:1,c:"#f00"},{x:4,y:8,w:8,h:6,c:"#510"},{x:3,y:14,w:2,h:2,c:"#300"},{x:11,y:14,w:2,h:2,c:"#300"}]},
    dullahan: { color: "#334", pixels: [{x:6,y:5,w:8,h:10,c:"#223"},{x:1,y:7,w:4,h:5,c:"#eeb"},{x:2,y:8,w:1,h:1,c:"#000"},{x:4,y:8,w:1,h:1,c:"#000"},{x:6,y:5,w:8,h:2,c:"#556"},{x:12,y:2,w:2,h:12,c:"#667"},{x:12,y:1,w:2,h:1,c:"#fff"}]},
    chimera: { color: "#d84", pixels: [{x:4,y:3,w:6,h:6,c:"#c62"},{x:10,y:2,w:4,h:5,c:"#282"},{x:12,y:3,w:1,h:1,c:"#ff0"},{x:2,y:2,w:4,h:5,c:"#d84"},{x:3,y:3,w:1,h:1,c:"#000"},{x:3,y:9,w:10,h:5,c:"#842"},{x:13,y:6,w:2,h:6,c:"#a00"}]},
    demon: { color: "#a22", pixels: [{x:5,y:1,w:6,h:6,c:"#800"},{x:4,y:2,w:1,h:3,c:"#fff"},{x:11,y:2,w:1,h:3,c:"#fff"},{x:6,y:3,w:1,h:1,c:"#ff0"},{x:9,y:3,w:1,h:1,c:"#ff0"},{x:3,y:7,w:10,h:7,c:"#600"},{x:1,y:4,w:4,h:6,c:"#303"},{x:11,y:4,w:4,h:6,c:"#303"}]},
    dragon: { color: "#62a", pixels: [{x:4,y:1,w:4,h:6,c:"#316"},{x:6,y:2,w:1,h:1,c:"#fc0"},{x:5,y:7,w:7,h:7,c:"#428"},{x:0,y:2,w:5,h:8,c:"#84a"},{x:11,y:2,w:5,h:8,c:"#84a"},{x:2,y:3,w:1,h:4,c:"#316"},{x:13,y:3,w:1,h:4,c:"#316"}]},
    lich: { color: "#426", pixels: [{x:6,y:2,w:4,h:4,c:"#eed"},{x:5,y:5,w:6,h:10,c:"#305"},{x:3,y:3,w:2,h:12,c:"#a84"},{x:3,y:2,w:3,h:2,c:"#b4d"},{x:6,y:6,w:4,h:6,c:"#203"},{x:6,y:3,w:1,h:1,c:"#0f0"},{x:9,y:3,w:1,h:1,c:"#0f0"}]},
    fallen: { color: "#222", pixels: [{x:6,y:2,w:4,h:4,c:"#ccc"},{x:5,y:6,w:6,h:8,c:"#111"},{x:1,y:2,w:5,h:10,c:"#000"},{x:10,y:2,w:5,h:10,c:"#000"},{x:7,y:3,w:2,h:1,c:"#f00"}]},
    angel: { color: "#eea", pixels: [{x:6,y:2,w:4,h:4,c:"#fcc"},{x:6,y:1,w:4,h:1,c:"#fe0"},{x:5,y:6,w:6,h:8,c:"#eee"},{x:1,y:2,w:4,h:8,c:"#fff"},{x:11,y:2,w:4,h:8,c:"#fff"},{x:7,y:3,w:2,h:1,c:"#0af"}]},
    reaper: { color: "#222", pixels: [{x:6,y:2,w:4,h:4,c:"#eee"},{x:5,y:4,w:6,h:10,c:"#111"},{x:2,y:6,w:12,h:2,c:"#111"},{x:12,y:1,w:2,h:14,c:"#888"},{x:12,y:1,w:3,h:3,c:"#ccc"}]},
    boss: { color: "#222", pixels: [{x:5,y:1,w:6,h:6,c:"#ddd"},{x:4,y:0,w:2,h:3,c:"#808"},{x:10,y:0,w:2,h:3,c:"#808"},{x:6,y:3,w:1,h:1,c:"#f00"},{x:9,y:3,w:1,h:1,c:"#f00"},{x:3,y:7,w:10,h:8,c:"#222"},{x:4,y:8,w:8,h:6,c:"#404"},{x:1,y:4,w:3,h:10,c:"#101"},{x:12,y:4,w:3,h:10,c:"#101"}]},
    asura: { color: "#a4e", pixels: [{x:6,y:1,w:4,h:5,c:"#c8c"},{x:4,y:6,w:8,h:8,c:"#626"},{x:2,y:4,w:2,h:4,c:"#c8c"},{x:12,y:4,w:2,h:4,c:"#c8c"},{x:2,y:9,w:2,h:4,c:"#c8c"},{x:12,y:9,w:2,h:4,c:"#c8c"},{x:2,y:3,w:1,h:4,c:"#888"},{x:13,y:3,w:1,h:4,c:"#888"}]},
    general: { color: "#667", pixels: [{x:5,y:0,w:6,h:6,c:"#223"},{x:6,y:2,w:4,h:2,c:"#000"},{x:6,y:2,w:1,h:1,c:"#f00"},{x:9,y:2,w:1,h:1,c:"#f00"},{x:3,y:6,w:10,h:9,c:"#445"},{x:1,y:6,w:3,h:7,c:"#889"},{x:12,y:6,w:3,h:7,c:"#889"},{x:5,y:8,w:6,h:6,c:"#223"}]},
    goldman: { color: "#fd0", pixels: [{x:4,y:2,w:8,h:6,c:"#fd0"},{x:5,y:3,w:6,h:4,c:"#ff8"},{x:2,y:4,w:3,h:6,c:"#db0"},{x:11,y:4,w:3,h:6,c:"#db0"},{x:5,y:9,w:2,h:5,c:"#b90"},{x:9,y:9,w:2,h:5,c:"#b90"},{x:6,y:4,w:1,h:1,c:"#000"},{x:9,y:4,w:1,h:1,c:"#000"}]},
    metal_s: { color: "#ccc", pixels: [{x:5,y:8,w:6,h:4,c:"#aaa"},{x:4,y:9,w:8,h:4,c:"#ccc"},{x:2,y:11,w:12,h:3,c:"#eee"},{x:6,y:10,w:1,h:1,c:"#000"},{x:9,y:10,w:1,h:1,c:"#000"},{x:5,y:9,w:1,h:1,c:"#fff"}]},
    npc_princess: { color: "#fca", pixels: [{x:5,y:2,w:6,h:5,c:"#fa8"},{x:6,y:1,w:4,h:2,c:"#f84"},{x:5,y:7,w:6,h:7,c:"#f8a"},{x:6,y:8,w:4,h:4,c:"#fce"},{x:4,y:7,w:2,h:4,c:"#fca"},{x:10,y:7,w:2,h:4,c:"#fca"}] },
    npc_king: { color: "#fca", pixels: [{x:4,y:2,w:8,h:5,c:"#eee"},{x:5,y:0,w:6,h:3,c:"#fc0"},{x:4,y:7,w:8,h:8,c:"#b22"},{x:6,y:7,w:4,h:6,c:"#fff"},{x:5,y:6,w:6,h:4,c:"#ddd"}] },
    npc_friend: { color: "#fca", pixels: [{x:5,y:2,w:6,h:5,c:"#642"},{x:5,y:1,w:6,h:2,c:"#420"},{x:5,y:7,w:6,h:6,c:"#468"},{x:6,y:8,w:4,h:4,c:"#68a"},{x:4,y:7,w:2,h:4,c:"#fca"}] },
    npc_healer: { color: "#fca", pixels: [{x:5,y:2,w:6,h:5,c:"#edb"},{x:5,y:1,w:6,h:2,c:"#dca"},{x:5,y:7,w:6,h:8,c:"#fff"},{x:7,y:8,w:2,h:4,c:"#8d8"},{x:4,y:7,w:2,h:4,c:"#fca"}] },
    npc_smith: { color: "#aaa", pixels: [{x:4,y:3,w:8,h:6,c:"#b86"},{x:3,y:3,w:2,h:4,c:"#531"},{x:11,y:3,w:2,h:4,c:"#531"},{x:5,y:2,w:6,h:2,c:"#ddd"},{x:4,y:9,w:8,h:5,c:"#642"},{x:6,y:10,w:4,h:3,c:"#864"}] },
    npc_gambler: { color: "#e6e", pixels: [{x:5,y:2,w:6,h:5,c:"#eac"},{x:4,y:1,w:8,h:3,c:"#606"},{x:5,y:7,w:6,h:7,c:"#808"},{x:6,y:8,w:1,h:1,c:"#ff0"},{x:9,y:8,w:1,h:1,c:"#ff0"},{x:3,y:7,w:2,h:4,c:"#eac"}] },
};

const SKILLS = [
    { id: "fire", name: "<ruby>Á¥ÖËìÆ<rt>„Ç∞„É¨„É≥</rt></ruby>„ÅÆ<ruby>ËÖï<rt>„Ç´„Ç§„Éä</rt></ruby>", mp: 3, dmg: 2.0, msg: "ÁÑº„ÅçÂ∞Ω„Åè„ÅõÔºÅ" },
    { id: "vac", name: "<ruby>Êñ≠Á©∫<rt>„ÉÄ„É≥„ÇØ„Ç¶</rt></ruby>„ÅÆ<ruby>Â§™ÂàÄ<rt>„Çø„ÉÅ</rt></ruby>", mp: 5, dmg: 2.5, msg: "Á©∫„ÇíÂàá„ÇãÔºÅ" },
    { id: "falcon", name: "<ruby>ÂπªÂΩ±<rt>„Ç≤„É≥„Ç®„Ç§</rt></ruby><ruby>ÈÄ£ÊíÉ<rt>„É¨„É≥„Ç≤„Ç≠</rt></ruby>", mp: 8, dmg: 1.0, times: 2, msg: "ÊÆãÂÉè„Å†..." },
    { id: "gigadein", name: "<ruby>Â§©Èõ∑<rt>„ÉÜ„É≥„É©„Ç§</rt></ruby><ruby>ÊãõÊù•<rt>„Ç∑„Éß„Ç¶„É©„Ç§</rt></ruby>", mp: 15, dmg: 5.0, msg: "Ê∂à„ÅàÂ§±„Åõ„ÇçÔºÅ" },
    { id: "heal", name: "<ruby>Âõ†Êûú<rt>„Ç§„É≥„Ç¨</rt></ruby><ruby>ÈÄÜËª¢<rt>„ÇÆ„É£„ÇØ„ÉÜ„É≥</rt></ruby>", mp: 5, heal: 60, type: "heal", msg: "ÊôÇ„ÇíÊàª„ÅôÔºÅ" },
    { id: "smash", name: "<ruby>ËÑ≥Â§©<rt>„Éé„Ç¶„ÉÜ„É≥</rt></ruby><ruby>ÂîêÁ´π<rt>„Ç´„É©„Çø„Ç±</rt></ruby>", mp: 4, dmg: 2.2, msg: "Á†ï„ÅëÊï£„ÇåÔºÅ" },
    { id: "all", name: "<ruby>ÊóãÈ¢®<rt>„Çª„É≥„Éó„Ç¶</rt></ruby><ruby>‰π±Ëàû<rt>„É©„É≥„Éñ</rt></ruby>", mp: 6, dmg: 1.8, msg: "‰∏ÄÁ∂≤ÊâìÂ∞ΩÔºÅ" },
    { id: "crit", name: "<ruby>Áû¨ÁçÑÊÆ∫<rt>„Ç∑„É•„É≥„Ç¥„ÇØ„Çµ„ÉÑ</rt></ruby>", mp: 4, dmg: 1.2, msg: "Ê≠ªËßí„Å™„ÅóÔºÅ" },
    { id: "magic", name: "<ruby>ÈªíÁÇéÂºæ<rt>„Ç≥„ÇØ„Ç®„É≥„ÉÄ„É≥</rt></ruby>", mp: 6, dmg: 3.0, msg: "Èóá„Å´È£≤„Åæ„Çå„ÇàÔºÅ" }
];

const ITEMS = [
    { id: "stick", type:"w", name: "<ruby>Âßã<rt>„Éè„Ç∏</rt></ruby>„Åæ„Çä„ÅÆ<ruby>Êûù<rt>„Ç®„ÉÄ</rt></ruby>", atk: 2, prob: 0.2, sprite: "stick", color: "#a84" },
    { id: "club", type:"w", name: "<ruby>ËõÆÊóè<rt>„Éê„É≥„Çæ„ÇØ</rt></ruby>„ÅÆ<ruby>Ê£çÊ£í<rt>„Ç≥„É≥„Éú„Ç¶</rt></ruby>", atk: 4, prob: 0.15, sprite: "club", color: "#953", skillId: "smash" },
    { id: "cloth", type:"a", name: "<ruby>ÊóÖ‰∫∫<rt>„Çø„Éì„Éì„Éà</rt></ruby>„ÅÆ<ruby>Â§ñÂ•ó<rt>„Ç¨„Ç§„Éà„Ç¶</rt></ruby>", def: 1, prob: 0.2, sprite: "a_cloth", color: "#dca" },
    { id: "leather", type:"a", name: "<ruby>Áç£<rt>„Ç±„É¢„Éé</rt></ruby>„ÅÆ<ruby>ÁöÆÈéß<rt>„Ç´„ÉØ„É®„É≠„Ç§</rt></ruby>", def: 3, prob: 0.15, sprite: "a_leather", color: "#a64" },
    { id: "ring_str", type:"acc", name: "<ruby>ÂâõÂäõ<rt>„Ç¥„Ç¶„É™„Ç≠</rt></ruby>„ÅÆ<ruby>ÊåáËº™<rt>„É™„É≥„Ç∞</rt></ruby>", atk: 5, prob: 0.1, sprite: "ring", color: "#f44" },
    { id: "amu_pro", type:"acc", name: "<ruby>ÂÆàË≠∑<rt>„Ç∑„É•„Ç¥</rt></ruby>„ÅÆ<ruby>Ë≠∑Á¨¶<rt>„Ç¢„Éü„É•„É¨„ÉÉ„Éà</rt></ruby>", def: 5, prob: 0.1, sprite: "amulet", color: "#48f" },
    { id: "acc_vamp", type:"acc", name: "<ruby>Âê∏Ë°ÄÈ¨º<rt>„É¥„Ç°„É≥„Éë„Ç§„Ç¢</rt></ruby>„ÅÆ<ruby>Áâô<rt>„Ç≠„Éê</rt></ruby>", atk: 10, prob: 0.05, sprite: "amulet", color: "#a00", effect: "drain", effectName: "Âê∏Ë°Ä" },
    { id: "acc_gold", type:"acc", name: "<ruby>Âº∑Ê¨≤<rt>„Ç∞„É™„Éº„Éâ</rt></ruby>„ÅÆ<ruby>Â£∫<rt>„ÉÑ„Éú</rt></ruby>", def: 0, prob: 0.05, sprite: "ring", color: "#fd0", effect: "greed", effectName: "ÂØåË±™" },
    { id: "acc_revive", type:"acc", name: "„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ„ÅÆ<ruby>Â∞æ<rt>„Ç™</rt></ruby>", def: 2, prob: 0.01, sprite: "soul", color: "#f80", effect: "rebirth", effectName: "ÂÜçË™ï" },
];
const W_TYPES = [{id:"sword",name:"Ââ£",base:8,sp:"sword",sk:"fire"},{id:"axe",name:"Êñß",base:10,sp:"axe",sk:"smash"},{id:"spear",name:"Êßç",base:9,sp:"spear",sk:"crit"},{id:"hammer",name:"Êßå",base:12,sp:"hammer",sk:"all"},{id:"wand",name:"Êùñ",base:6,sp:"wand",sk:"magic"}];
const A_TYPES = [{id:"chain",name:"ÈéñÂ∏∑Â≠ê",base:5,sp:"a_chain"},{id:"iron",name:"ÈâÑ„ÅÆÈéß",base:10,sp:"a_iron"},{id:"steel",name:"Èãº„ÅÆÈéß",base:15,sp:"a_steel"},{id:"dragon",name:"Á´ú„ÅÆÈéß",base:22,sp:"a_dragon"},{id:"hero",name:"ÂÖâ„ÅÆÈéß",base:30,sp:"a_hero"}];

W_TYPES.forEach(t=>{ 
    WEAPON_PREFIXES.forEach((pre,i)=>{ 
        const rName = `<ruby>${pre.t}<rt>${pre.r}</rt></ruby>${t.name}`;
        ITEMS.push({id:`${t.id}_${i}`,type:"w",name:rName,atk:t.base+(i*5),prob:0.1/(i+1),sprite:t.sp,color:WEAPON_COLORS[i],skillId:t.sk}); 
    }); 
});
A_TYPES.forEach(t=>{ 
    WEAPON_PREFIXES.forEach((pre,i)=>{ 
        const rName = `<ruby>${pre.t}<rt>${pre.r}</rt></ruby>${t.name}`;
        ITEMS.push({id:`${t.id}_${i}`,type:"a",name:rName,def:t.base+(i*3),prob:0.1/(i+1),sprite:t.sp,color:WEAPON_COLORS[i]}); 
    }); 
});

ITEMS.push(
    { id: "hero_w", type:"w", name: "„É©„Ç∞„Éä„É≠„ÇØ", atk: 80, prob: 0.005, sprite: "hero_w", color: "#48f", skillId: "gigadein" },
    { id: "metal_w", type:"w", name: "<ruby>È≠îÂâ£<rt>„Éû„Ç±„É≥</rt></ruby>„Ç™„É°„Ç¨", atk: 40, prob: 0.01, sprite: "metal_w", color: "#ccc", skillId: "falcon" },
);

const SOULS = {
    slime: { name: "„Çπ„É©„Ç§„É†„ÅÆ<ruby>È≠Ç<rt>„ÇΩ„Ç¶„É´</rt></ruby>", effect: "regen", effectName: "ÂÜçÁîü", color: "#48f" },
    bat: { name: "„Ç≥„Ç¶„É¢„É™„ÅÆ<ruby>È≠Ç<rt>„ÇΩ„Ç¶„É´</rt></ruby>", effect: "haste", effectName: "Á•ûÈÄü", color: "#222" },
    goldman: { name: "ÈªÑÈáë„ÅÆ<ruby>È≠Ç<rt>„ÇΩ„Ç¶„É´</rt></ruby>", effect: "greed", effectName: "ÂØåË±™", color: "#fd0" },
    dragon: { name: "<ruby>Á´ú<rt>„Éâ„É©„Ç¥„É≥</rt></ruby>„ÅÆ<ruby>È≠Ç<rt>„ÇΩ„Ç¶„É´</rt></ruby>", effect: "atk_up", effectName: "ÂâõËÖï", color: "#62a", val: 50 },
    mimic: { name: "<ruby>‰∫∫È£ü„ÅÑÁÆ±<rt>„Éü„Éü„ÉÉ„ÇØ</rt></ruby>„ÅÆ<ruby>È≠Ç<rt>„ÇΩ„Ç¶„É´</rt></ruby>", effect: "crit_up", effectName: "ÂøÖÊÆ∫", color: "#d84" },
    boss: { name: "<ruby>È≠îÁéã<rt>„ÉÄ„Éº„ÇØ„É≠„Éº„Éâ</rt></ruby>„ÅÆ<ruby>È≠Ç<rt>„ÇΩ„Ç¶„É´</rt></ruby>", effect: "all_up", effectName: "Ë¶áÁéã", color: "#f00", val: 100 },
    reaper: { name: "<ruby>Ê≠ªÁ•û<rt>„Éá„Çπ</rt></ruby>„ÅÆ<ruby>È≠Ç<rt>„ÇΩ„Ç¶„É´</rt></ruby>", effect: "drain", effectName: "Âê∏Ë°Ä", color: "#222" }
};

const FLAVOR_TEXTS = ["„ÇØ„ÇØ„ÇØ‚Ä¶<ruby>Âäõ<rt>„Éï„Ç©„Éº„Çπ</rt></ruby>„ÅåÊ∫¢„Çå„Å¶„Åè„Çã‚Ä¶", "Âè≥ËÖï„Åå‚Ä¶<ruby>Áñº<rt>„Ç¶„Ç∫</rt></ruby>„Åè‚Ä¶", "<ruby>È≠îÂäõ<rt>„Éû„Éä</rt></ruby>„ÅåÂÖ±È≥¥„Åó„Å¶„ÅÑ„Çã‚Ä¶", "„Åì„ÅÆÁóõ„Åø‚Ä¶ÂøÉÂú∞„Çà„ÅÑ‚Ä¶", "Êàë„Å´ÊΩú„ÇÄ<ruby>Èóá<rt>„ÉÄ„Éº„ÇØ„Éç„Çπ</rt></ruby>„ÅåÈ®í„Åê‚Ä¶", "Ë¶ã„Åà„Åü‚Ä¶Ê≠ª„ÅÆ<ruby>Á∑ö<rt>„É©„Ç§„É≥</rt></ruby>„Åå‚Ä¶", "<ruby>Â∞ÅÂç∞<rt>„Ç∑„Éº„É´</rt></ruby>„ÅåËß£„Åë„Åù„ÅÜ„Å†‚Ä¶", "‰∏ñÁïå„Åå‚Ä¶ÁßÅ„ÇíÊãíÁµ∂„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅãÔºü"];
const RATES = [ { name: "Áµ∂Êúõ", color: "#444", rate: 0.05 }, { name: "Âá°‰∫∫", color: "#fff", rate: 0.10 }, { name: "‰øÆÁæÖ", color: "#48f", rate: 0.20 }, { name: "Ëã±ÈõÑ", color: "#fd0", rate: 0.30 }, { name: "‰ºùË™¨", color: "#f44", rate: 0.50 }, { name: "Á•ûË©±", color: "magenta", rate: 0.65 } ];

const GUARD_TEXTS = [{t:"Ë¶ãÂàá",r:"„Éü„Ç≠„É™"},{t:"Áû¨Êñ≠",r:"„Ç∑„É•„É≥„ÉÄ„É≥"},{t:"Áµ∂ÁÑ°",r:"„Çº„ÉÑ„É†"},{t:"Áõ∏ÊÆ∫",r:"„ÇΩ„Ç¶„Çµ„Ç§"},{t:"ËôöÁ©∫",r:"„Ç≥„ÇØ„Ç¶"},{t:"Âá™",r:"„Éä„ÇÆ"}];
const TITLES = [
    { id: "t_survivor", name: "<ruby>ÁîüÂ≠òËÄÖ<rt>„Çµ„Éê„Ç§„Éê„Éº</rt></ruby>", cond: (g)=>g.generation>2, eff: "HP+20%" },
    { id: "t_godspeed", name: "<ruby>Á•ûÈÄü<rt>„ÇΩ„Éã„ÉÉ„ÇØ</rt></ruby>", cond: (g)=>g.fastClears>5, eff: "AGI+10%" },
    { id: "t_immortal", name: "<ruby>‰∏çÊ≠ªËÄÖ<rt>„Éé„Çπ„Éï„Çß„É©„Éà„Ç•</rt></ruby>", cond: (g)=>g.reviveCount>0, eff: "REVIVE+" },
    { id: "t_unscathed", name: "<ruby>ÁÑ°ÂÇ∑<rt>„Éë„Éº„Éï„Çß„ÇØ„Éà</rt></ruby>„ÅÆ<ruby>Â∏ùÁéã<rt>„Ç´„Ç§„Ç∂„Éº</rt></ruby>", cond: (g)=>g.noDamageStreak>5, eff: "LUCK+" }
];

// --- EXPANDED DIALOGUE ---
const TALK_PATTERNS = {
    start: [
        "Ë≤¥Êßò„ÅÆÂëΩÈÅã„ÅØÂ∞Ω„Åç„ÅüÔºÅ", "„Åù„ÅÆÈ≠Ç„ÄÅÊàë„ÅåÁ≥ß„Å®„Å™„ÇåÔºÅ", "Áµ∂Êúõ„ÇíÊïô„Åà„Å¶„ÇÑ„Çç„ÅÜ", "„Éï„Éï„Éï‚Ä¶Ê•Ω„Åó„Åæ„Åõ„Å¶„Åè„Çå„ÇàÔºü", "Êàë„ÅåÈóá„Å´Âπ≥‰ºè„ÅõÔºÅ", 
        "„Åì„ÅÆÈ†òÂüü„Å´Ë∏è„ÅøÂÖ•„Çã„Å®„ÅØ‚Ä¶", "Ê≠ª„Å∏„ÅÆ„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Å†", "ÊÅêÊÄñ„Å´Ê≠™„ÇÄÈ°î„ÅåË¶ã„Åü„ÅÑ‚Ä¶", "„ÇØ„ÇØ„ÇØ‚Ä¶È£õ„Çì„ÅßÁÅ´„Å´ÂÖ•„ÇãÂ§è„ÅÆËô´„Å®„ÅØ„Å™",
        "Ë≤¥Êßò„ÅÆÁµ∂Êúõ„ÄÅÊúÄÈ´ò„ÅÆ„ÅîÈ¶≥Ëµ∞„Å†ÔºÅ", "Êàë„ÅåÁú†„Çä„ÇíÂ¶®„Åí„ÇãÊÑö„ÅãËÄÖ„ÇÅ", "Èóá„ÅÆÁÇé„Å´Êä±„Åã„Çå„Å¶Ê∂à„Åà„ÇçÔºÅ", "Ë≤¥Êßò„ÅÆÂ≠òÂú®„Å™„Å©„ÄÅÂ°µ„Å´Á≠â„Åó„ÅÑ"
    ],
    hit: [
        "Ë≤¥Êßò‚Ä¶„ÇÑ„Çã„Å™Ôºü", "Ë®àÁÆóÂ§ñ„Å†‚Ä¶", "Âäπ„Åã„Å¨„ÇèÔºÅ", "„Åµ„Çì„ÄÅÂ∞èË≥¢„Åó„ÅÑ", "„Éê„Ç´„Å™‚Ä¶", "„Åì„ÅÆÁßÅ„Åå‚Ä¶Êäº„Åï„Çå„Å¶„ÅÑ„ÇãÔºü",
        "„Åê„ÅÇ„ÅÇ„Å£ÔºÅË≤¥Êßò„ÄÅ‰ΩïËÄÖ„Å†ÔºÅÔºü", "„Åª„ÅÜ„ÄÅÁßÅ„ÅÆAT„Éï„Ç£„Éº„É´„Éâ„ÇíÁ†¥„Çã„Å®„ÅØ", "„ÉÅ„ÉÉ„ÄÅË®àÁÆó„ÅåÁãÇ„Å£„Åü„ÇèÔºÅ", "„Åù„ÅÆÂäõ‚Ä¶„Åæ„Åï„ÅãÂãáËÄÖ„ÅãÔºü",
        "ÈÅä„Å≥„ÅØÁµÇ„Çè„Çä„Å†ÔºÅ", "„Å™„Åú„Å†‚Ä¶„Å™„ÅúÂãï„Åç„ÅåË™≠„ÇÅ„ÇãÔºÅÔºü", "ÁîüÊÑèÊ∞ó„Å™‚Ä¶ÔºÅ"
    ],
    pinch: [
        "„Åæ„Å†„Å†‚Ä¶„Åæ„Å†ÁµÇ„Çè„Çâ„Çì„ÇàÔºÅ", "Êú¨Ê∞ó„ÇíÂá∫„Åï„Åõ„Çã„Å®„ÅØ‚Ä¶", "ÂæåÊÇî„Åô„Çã„Åû‚Ä¶", "Èóá„ÅÆÂäõ„ÇàÔºÅÊàë„Å´ÈõÜ„ÅàÔºÅ", "Ë≤¥Êßò„ÇíÈÅìÈÄ£„Çå„Å´„Åó„Å¶„ÇÑ„ÇãÔºÅ",
        "ÁßÅ„ÅÆÁúü„ÅÆÂßø„ÇíË¶ã„Åõ„Å¶„ÇÑ„Çç„ÅÜ", "„É™„Éü„ÉÉ„Çø„ÉºËß£Èô§ÔºÅ", "Èù¢ÁôΩ„ÅÑ‚Ä¶ÂÆü„Å´Èù¢ÁôΩ„ÅÑ„ÅûÔºÅ", "Ë≤¥Êßò„Å†„Åë„ÅØ‚Ä¶Âú∞ÁçÑ„Å∏ÈÄÅ„ÇãÔºÅ",
        "Êàë„Ç¨È≠îÂäõ„ÄÅÊö¥Ëµ∞„Çπ‚Ä¶ÔºÅ"
    ],
    die: [
        "„Éê„Ç´„Å™‚Ä¶ÁßÅ„ÅåÊïó„Çå„Çã„Å®„ÅØ‚Ä¶", "Ë¶ã‰∫ã„Å†‚Ä¶", "„Åì„Çå„Åå‚Ä¶ÊïóÂåó„ÅÆÂë≥„Åã‚Ä¶", "Á¨¨‰∫åÂΩ¢ÊÖã„Å∏„ÅÆÂ∏ÉÁü≥„Å´ÈÅé„Åé„Çì‚Ä¶", "Èóá„ÅØ‚Ä¶ÊªÖ„Å≥„Å¨‚Ä¶", "„Ç∞„Éï„ÉÉ‚Ä¶ÔºÅ",
        "Ë≤¥Êßò„ÅÆÈ°î‚Ä¶Ë¶ö„Åà„Åü„Åû‚Ä¶", "ÂÖâ„ÅÇ„ÇãÊâÄ„Å´‚Ä¶ÂΩ±„Åæ„Åü„ÅÇ„Çä‚Ä¶", "Êàë„ÅåÂ±ç„ÇíË∂ä„Åà„Å¶„ÇÜ„Åë‚Ä¶", "„Åæ„Åï„Åã‚Ä¶„Çà„ÇÇ„ÇÑ‚Ä¶",
        "Ë¶ã‰∫ã„Å†‰∫∫Èñì„Çà‚Ä¶", "Ê¨°„ÅØ‚Ä¶Âãù„Å§‚Ä¶", "ÁÑ°Âøµ‚Ä¶"
    ]
};

let game = null;

class Game {
    constructor() {
        this.sound = new SoundManager();
        this.el = {}; 
        this.resetInternalState();
        this.targetLv = 30; 
        this.gaugeVal = 0; this.gaugeDir = 1; this.gaugeSpeed = 2;
        this.pendingItem = null;
        this.chain = 0;
        this.isDefenseMode = false;
        this.defenseTimer = null;
        this.isGuardWindow = false;
        this.guardStart = 0;
        this.timeScale = 1;
        this.skipLottery = false;
        this.acquiredTitles = new Set();
        this.fastClears = 0;
        this.reviveCount = 0;
        this.noDamageStreak = 0;
        this.shopMultiplier = 1; // Default x1
        this.isAutoMode = false; // ADDED: Auto mode flag
    }

    bindDOM() {
        this.el = {
            container: document.getElementById('game-container'),
            stage: document.getElementById('stage'),
            
            hp: document.getElementById('disp-hp'), mp: document.getElementById('disp-mp'),
            lv: document.getElementById('disp-lv'), atk: document.getElementById('disp-atk'), def: document.getElementById('disp-def'),
            gold: document.getElementById('disp-gold'), 
            // New Gen UI
            genHero: document.getElementById('gen-hero-num'), genDemon: document.getElementById('gen-demon-num'),

            weapon: document.getElementById('disp-weapon'), armor: document.getElementById('disp-armor'), acc: document.getElementById('disp-acc'),
            aura: document.getElementById('disp-aura'), chain: document.getElementById('disp-chain'), awakeTxt: document.getElementById('awake-txt'),
            title: document.getElementById('disp-title'),
            bar: document.getElementById('progress-bar'), txt: document.getElementById('progress-text'),

            log: document.getElementById('log'), enemy: document.getElementById('enemy-slot'),
            
            modalGo: document.getElementById('modal-go'), modalShop: document.getElementById('shop-modal'), modalLib: document.getElementById('lib-modal'),
            modalHelp: document.getElementById('help-modal'),
            
            drama: document.getElementById('drama-window'), flash: document.getElementById('flash'), flashInv: document.getElementById('flash-invert'), cutin: document.getElementById('cutin'),
            damagePop: document.getElementById('damage-pop'), chainPop: document.getElementById('chain-pop'),
            dangerOverlay: document.getElementById('danger-overlay'), itemPop: document.getElementById('item-pop'),
            
            menuBattle: document.getElementById('menu-battle'), menuSkills: document.getElementById('menu-skills'), menuChest: document.getElementById('menu-chest'),
            
            gaugeArea: document.getElementById('gauge-area'), gaugeCursor: document.getElementById('gauge-cursor'),
            
            btnMain: document.getElementById('btn-main'), btnStopWrapper: document.getElementById('btn-stop-wrapper'), btnStop: document.getElementById('btn-stop'),
            btnSpeed: document.getElementById('btn-speed'),
            // ADDED: Buttons
            btnAuto: document.getElementById('btn-auto'), btnMute: document.getElementById('btn-mute'),
            
            chestDisplay: document.getElementById('chest-display'),
            curI: { icon:document.getElementById('cur-icon'), name:document.getElementById('cur-name'), stat:document.getElementById('cur-stat'), sub:document.getElementById('cur-sub'), eff:document.getElementById('cur-effect') },
            newI: { icon:document.getElementById('new-icon'), name:document.getElementById('new-name'), stat:document.getElementById('new-stat'), sub:document.getElementById('new-sub'), eff:document.getElementById('new-effect') },
            btnGet: document.getElementById('btn-get'), btnDiscard: document.getElementById('btn-discard'),
            
            eventDisplay: document.getElementById('event-display'), eventTitle: document.getElementById('event-title'), eventDesc: document.getElementById('event-desc'), eventChoices: document.getElementById('event-choices'),
            dramaActor: document.getElementById('drama-actor-box'), dramaName: document.getElementById('drama-name'), dramaText: document.getElementById('drama-text'),

            shopMultBtns: {
                1: document.getElementById('shop-mult-1'),
                10: document.getElementById('shop-mult-10'),
                MAX: document.getElementById('shop-mult-max')
            },
            shopCostLabels: {
                hp: document.getElementById('cost-hp'),
                mp: document.getElementById('cost-mp'),
                atk: document.getElementById('cost-atk'),
                def: document.getElementById('cost-def'),
                luck: document.getElementById('cost-luck'),
            }
        };
    }
    
    resetInternalState() {
        let save = JSON.parse(localStorage.getItem(SAVE_KEY) || 'null');
        this.boosts = save?.boosts || { hp: 0, mp: 0, atk: 0, def: 0, luck: 0 };
        this.clears = save?.clears || 0; // Starts at 0 clears (Gen 1 Demon)
        this.acquiredTitles = new Set(save?.titles || []);
        if (save) {
            this.generation = save.generation || 1; this.gold = save.gold || 0; this.acquiredItems = new Set(save.library || []);
        } else {
            this.generation = 1; this.gold = 0; this.acquiredItems = new Set();
        }
        this.state = "INIT"; this.lv = 1;
        this.maxHp = 25 + this.boosts.hp; this.hp = this.maxHp;
        this.maxMp = 10 + this.boosts.mp; this.mp = this.maxMp;
        this.baseAtk = 3 + this.boosts.atk;
        this.weapon = null; this.armor = null; this.accessory = null;
        this.luckBonus = Math.min(0.30, this.boosts.luck * 0.02); 
        this.enemy = { name: "", hp: 0, maxHp: 0, atk: 0, type: "slime" };
        this.chain = 0;
        this.isDefenseMode = false;
        
        // Clear all timers
        if(this.defenseTimer) clearInterval(this.defenseTimer);
        if(this.dramaTimer) clearTimeout(this.dramaTimer);
        
        if(this.acquiredTitles.has("t_survivor")) this.maxHp = Math.floor(this.maxHp * 1.2);
    }
    
    saveData() {
        localStorage.setItem(SAVE_KEY, JSON.stringify({
            generation: this.generation + 1, gold: this.gold, library: Array.from(this.acquiredItems),
            boosts: this.boosts, clears: this.clears, titles: Array.from(this.acquiredTitles)
        }));
    }

    resetSaveData() {
        if(confirm("Ë®òÊÜ∂„ÇíÊ∂àÂéª„Åó„Åæ„Åô„ÅãÔºü\n(„Çª„Éº„Éñ„Éá„Éº„Çø„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô)")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }
    
    softReset() {
        this.resetInternalState();
        
        // Reset UI States
        this.el.modalGo.style.display = "none";
        this.el.modalShop.style.display = "none";
        this.el.chestDisplay.style.display = "none";
        this.el.eventDisplay.style.display = "none";
        this.el.menuBattle.style.display = "none";
        this.el.btnStopWrapper.style.display = "none";
        this.el.gaugeArea.style.display = "none";
        this.el.enemy.innerHTML = "";
        
        this.el.log.innerHTML = `<div class='log-entry system'>Á¨¨${this.generation}‰ª£ ÂãáËÄÖ„ÄÅÈÅãÂëΩ„ÅÆÂú∞„Å∏„ÄÇ</div>`;
        this.el.btnMain.textContent = "ÊäΩÈÅ∏„Å∏"; 
        this.el.btnMain.style.display = "block";
        this.el.btnMain.disabled = false;
        this.el.dangerOverlay.style.display = "none"; 
        this.el.aura.textContent = "READY"; 
        this.el.aura.style.color = "#555";
        
        this.updateHud();
        this.sound.playSE('select');
    }

    initAudio() {
        this.sound.init(); this.sound.playSE('select');
        document.getElementById('click-start').style.display = 'none';
        this.log(`Á¨¨${this.generation}‰ª£ ÂãáËÄÖ„ÄÅ<ruby>ÂÜíÈô∫„ÅÆÊõ∏<rt>„ÇØ„É≠„Éã„ÇØ„É´</rt></ruby>„ÇíÈñã„ÅÑ„Åü„ÄÇ`); this.updateHud();
    }
    
    toggleSpeed() {
        this.timeScale = this.timeScale === 1 ? 2 : 1;
        this.el.container.classList.toggle('speed-x2', this.timeScale === 2);
        this.el.btnSpeed.textContent = this.timeScale === 2 ? "x2" : "x1";
        this.el.btnSpeed.style.background = this.timeScale === 2 ? "#044" : "#000";
        this.sound.playSE('select');
    }

    // ADDED: Auto Toggle
    toggleAutoMode(forceVal = null) {
        if (forceVal !== null) {
            this.isAutoMode = forceVal;
        } else {
            this.isAutoMode = !this.isAutoMode;
        }
        
        this.el.btnAuto.classList.toggle('active', this.isAutoMode);
        if(this.isAutoMode) {
            this.log("[AUTO] Êà¶Èóò„ÉªË£ÖÂÇôÈÅ∏Êäû„ÇíËá™ÂãïÂåñ", "system");
        } else {
            this.log("[AUTO] Ëß£Èô§", "system");
        }
        this.sound.playSE('select');
    }

    // ADDED: Mute Toggle
    toggleMute() {
        const isMuted = this.sound.toggleMute();
        this.el.btnMute.textContent = isMuted ? "üîá" : "üîä";
        this.el.btnMute.style.color = isMuted ? "#888" : "#fff";
        this.el.btnMute.style.borderColor = isMuted ? "#888" : "#fff";
    }

    log(msg, type = "") {
        if (Math.random() < 0.15 && type === "") {
            const flavor = FLAVOR_TEXTS[Math.floor(Math.random() * FLAVOR_TEXTS.length)];
            const fd = document.createElement('div'); fd.className = "log-entry flavor"; fd.innerHTML = flavor;
            this.el.log.prepend(fd);
        }
        const d = document.createElement('div'); d.className = `log-entry ${type}`; d.innerHTML = msg;
        this.el.log.prepend(d);
        if (this.el.log.children.length > 20) this.el.log.removeChild(this.el.log.lastChild);
    }

    renderEnemy(t, metal, boss) { 
        let d = SPRITES[t] || SPRITES.slime; 
        let color = d.color;
        if (!metal && !boss) { const hues = [d.color, "#e74c3c", "#2ecc71", "#f1c40f", "#9b59b6", "#3498db"]; color = hues[this.lv % hues.length]; }
        if (t === "asura" || t === "demon") color = "#f0f"; 
        if (t === "general" || t === "knight") color = "#8af"; 
        if (boss && t === "boss") color = this.clears > 5 ? "#a00" : "#d44"; 
        this.el.enemy.innerHTML = generateSVG({...d, color: color}, null, metal);
    }

    get totalAtk() { 
        let a = this.baseAtk + (this.weapon ? this.weapon.atk : 0) + (this.accessory ? (this.accessory.atk||0) : 0);
        if(this.accessory && this.accessory.soulEffect === "atk_up") a += (this.accessory.val || 0);
        if(this.accessory && this.accessory.soulEffect === "all_up") a += (this.accessory.val || 0);
        return Math.floor(a);
    }
    get totalDef() { 
        return (this.armor ? this.armor.def : 0) + (this.accessory ? (this.accessory.def||0) : 0) + (this.boosts.def || 0); 
    }

    checkDefenseMode() {
        if (this.chain >= 5 && !this.isDefenseMode) {
            this.isDefenseMode = true;
            this.el.container.classList.add('defense-mode');
            this.el.awakeTxt.style.display = "inline";
            this.sound.playSE('revive');
            this.log("‚â™Áµ∂ÂØæÈò≤Âæ°Áïå‚â´ Â±ïÈñãÔºÅ", "block");
            this.showCutin("A. DEFENSE");
            
            if(this.defenseTimer) clearInterval(this.defenseTimer);
            this.defenseTimer = setInterval(() => {
                if(!this.isDefenseMode) return;
                this.mp = Math.max(0, this.mp - 1);
                this.updateHud();
                if(this.mp <= 0) this.breakDefenseMode();
            }, 1000 / this.timeScale);

        } else if (this.chain < 5 && this.isDefenseMode) {
            this.breakDefenseMode();
        }
    }
    
    breakDefenseMode() {
        this.isDefenseMode = false;
        this.el.container.classList.remove('defense-mode');
        this.el.awakeTxt.style.display = "none";
        if(this.defenseTimer) clearInterval(this.defenseTimer);
        if(this.mp <= 0) this.log("MPÊûØÊ∏á‚Ä¶ÁµêÁïåÊ∂àÂ§±„ÄÇ", "damage");
    }

    updateHud() {
        if(!this.el.hp) return;
        this.el.hp.textContent = this.hp; this.el.mp.textContent = this.mp;
        this.el.lv.textContent = this.lv; this.el.atk.textContent = this.totalAtk; this.el.def.textContent = this.totalDef;
        this.el.gold.textContent = this.gold; 
        
        // UI UPDATE: Gen Info
        this.el.genHero.textContent = this.generation;
        this.el.genDemon.textContent = this.clears + 1;

        this.el.weapon.textContent = this.weapon ? this.weapon.name.replace(/<rt>.*?<\/rt>/g,"") : "Á¥†Êâã";
        this.el.armor.textContent = this.armor ? this.armor.name.replace(/<rt>.*?<\/rt>/g,"") : "Êúç";
        this.el.acc.textContent = this.accessory ? this.accessory.name.replace(/<rt>.*?<\/rt>/g,"") : "„Å™„Åó";
        this.el.chain.textContent = this.chain;
        this.el.hp.className = this.hp <= this.maxHp * 0.2 ? "val-hp hp-danger" : "val-hp";
        this.el.dangerOverlay.style.display = this.hp <= this.maxHp * 0.25 ? "block" : "none";
        const prog = Math.min(100, (this.lv / this.targetLv) * 100);
        this.el.bar.style.width = `${prog}%`;
        this.el.txt.textContent = this.lv >= this.targetLv ? "Ê±∫Êà¶ÔºÅ È≠îÁéã„ÅÆÈñì" : `Âú∞‰∏ã ${this.lv} / ${this.targetLv} Èöé`;
        
        if(this.acquiredTitles.size > 0) {
            const last = Array.from(this.acquiredTitles).pop();
            const tData = TITLES.find(t=>t.id===last);
            if(tData){ this.el.title.innerHTML = tData.name; this.el.title.style.display="inline"; }
        }
    }

    async delay(ms) { return new Promise(r => setTimeout(r, ms / this.timeScale)); }

    handleMainBtn() { 
        this.sound.playSE('select'); 
        if (this.state === "INIT") this.startLottery(); 
        else if (this.state === "LOTTERY") this.skipLottery = true;
        else if (this.state === "BATTLE_WAIT") this.decideEncounter(); 
    }

    async startLottery() {
        this.state = "LOTTERY"; this.skipLottery = false;
        this.log("ÈÅãÂëΩ„ÅÆÊäΩÈÅ∏„ÇíÈñãÂßã... („ÇØ„É™„ÉÉ„ÇØ„Åß„Çπ„Ç≠„ÉÉ„Éó)"); this.sound.playBGM('boss');
        let sel = RATES[0];
        
        const rollCount = 15;
        for (let i = 0; i < rollCount; i++) {
            if (this.skipLottery) break; 
            sel = RATES[Math.floor(Math.random() * RATES.length)];
            this.el.aura.textContent = `${Math.floor(Math.random()*99)}%`;
            this.el.aura.style.color = sel.color;
            if(i%4===0) this.sound.playSE('attack');
            await this.delay(50);
        }
        
        const r = Math.random();
        if (r < 0.2) sel = RATES[0]; else if (r < 0.5) sel = RATES[1]; else if (r < 0.7) sel = RATES[2];
        else if (r < 0.9) sel = RATES[3]; else if (r < 0.98) sel = RATES[4]; else sel = RATES[5];
        this.revivalRate = Math.min(0.65, sel.rate + this.luckBonus); 
        
        if(this.acquiredTitles.has("t_unscathed")) this.revivalRate += 0.05;
        
        this.el.aura.textContent = `${Math.floor(this.revivalRate*100)}%`;
        this.el.aura.style.color = sel.color;
        this.el.stage.style.boxShadow = `inset 0 0 30px ${sel.color}`;
        this.showCutin(sel.name + " Á¢∫ÂÆö"); this.sound.playSE('crit');
        
        if(!this.skipLottery) await this.delay(1000);
        
        this.el.btnMain.textContent = "È≠îÁ™ü„Å∏"; 
        this.state = "BATTLE_WAIT"; this.sound.stopBGM();
    }
    
    decideEncounter() {
        const r = Math.random();
        if (this.lv < this.targetLv && r < 0.20) { // Slight bump to event rate
            this.triggerEvent();
        } else {
            this.startBattle();
        }
    }

    // --- EXPANDED EVENTS ---
    triggerEvent() {
        this.state = "EVENT"; this.el.btnMain.style.display="none";
        this.el.eventDisplay.style.display = "flex"; this.el.eventChoices.innerHTML = "";
        this.el.enemy.style.display = "none";
        
        const events = ["spring", "merchant", "devil", "blacksmith", "gambler", "mimic_trap", "altar"];
        const type = events[Math.floor(Math.random()*events.length)];
        let title="", desc="";
        
        const createBtn = (txt, cb) => {
            const b = document.createElement("button"); 
            b.className = "cmd-btn";
            b.style.textAlign = "center";
            b.textContent = txt;
            b.onclick = () => { this.sound.playSE('select'); cb(); if(this.state !== "BATTLE_CMD") this.endEvent(); };
            this.el.eventChoices.appendChild(b);
        };
        
        if (type === "spring") {
            title = "ÂõûÂæ©„ÅÆÊ≥â"; desc = "Ê∏Ö„Çâ„Åã„Å™Ê∞¥„ÅåÊπß„ÅçÂá∫„Å¶„ÅÑ„Çã...";
            createBtn("È£≤„ÇÄ (HPÂÖ®ÂõûÂæ©)", () => { this.hp = this.maxHp; this.log("‰ΩìÂäõ„ÅåÂÖ®ÂõûÂæ©„Åó„ÅüÔºÅ", "revive"); this.sound.playSE('revive'); });
            createBtn("Á´ã„Å°Âéª„Çã", () => {});
        } else if (type === "merchant") {
            title = "Ë¨é„ÅÆË°åÂïÜ‰∫∫"; desc = "„Äå„ÅÑ„ÅÑËñ¨„ÄÅ„ÅÇ„Çã„Çà...„Äç";
            // BALANCE UPDATE: Percentage based heal
            const healAmount = Math.floor(this.maxHp * 0.5);
            const cost = 500 * (1 + this.clears);
            createBtn(`Ëñ¨„ÇíË≤∑„ÅÜ (${cost}G)`, () => {
                if(this.gold >= cost) { 
                    this.gold -= cost; 
                    this.hp = Math.min(this.maxHp, this.hp + healAmount); 
                    this.log(`ÊÄ™„Åó„ÅÑËñ¨„ÇíÈ£≤„Çì„Åß‰ΩìÂäõ„Åå ${healAmount} ÂõûÂæ©„Åó„ÅüÔºÅ`); 
                } else { this.log("„ÅäÈáë„ÅåË∂≥„Çä„Å™„ÅÑ..."); }
            });
            createBtn("Á´ã„Å°Âéª„Çã", () => {});
        } else if (type === "devil") {
            title = "ÊÇ™È≠î„ÅÆÂ•ëÁ¥Ñ"; desc = "„ÄåHPÊúÄÂ§ßÂÄ§„ÇíÊçß„Åí„Çå„Å∞„ÄÅÂäõ„Çí„ÇÑ„Çç„ÅÜ...„Äç";
            // BALANCE UPDATE: Percentage based cost & scaling gain
            const hpCost = Math.floor(this.maxHp * 0.1);
            const atkGain = Math.floor(this.lv * 0.5) + 5;
            createBtn(`Â•ëÁ¥Ñ (ÊúÄÂ§ßHP -${hpCost} / Êîª+${atkGain})`, () => {
                if(this.maxHp > hpCost * 1.5) { 
                    this.maxHp -= hpCost; 
                    this.hp = Math.min(this.hp, this.maxHp); 
                    this.boosts.atk += atkGain; 
                    this.log("ÂØøÂëΩ„ÇíÂâä„ÇäÂäõ„ÇíÂæó„Åü...", "damage"); this.sound.playSE('crit'); 
                } else {
                    this.log("„Åì„Çå‰ª•‰∏äÂëΩ„ÇíÂâä„Çå„Å™„ÅÑ...");
                }
            });
            createBtn("ÊãíÁµ∂", () => {});
        } else if (type === "blacksmith") {
            title = "ÊµÅÊµ™„ÅÆÈçõÂÜ∂Â±ã"; desc = "„ÄåÊ≠¶Âô®„ÇíÈçõ„Åà„Å¶„ÇÑ„Çç„ÅÜ„ÅãÔºü„Äç";
            const cost = 1000 * (1 + this.clears);
            createBtn(`Èçõ„Åà„Çã (${cost}G)`, () => {
                if(this.gold >= cost) {
                    if(this.weapon) {
                        this.gold -= cost;
                        const boost = Math.floor(this.weapon.atk * 0.2) + 2;
                        this.weapon.atk += boost;
                        this.log(`Ê≠¶Âô®„ÅÆÊîªÊíÉÂäõ„Åå +${boost} ‰∏äÊòáÔºÅ`, "critical"); this.sound.playSE('metal');
                    } else {
                        this.log("Ê≠¶Âô®„ÇíÊåÅ„Å£„Å¶„ÅÑ„Å™„ÅÑÔºÅ");
                    }
                } else { this.log("Èáë„ÅåË∂≥„Çä„Å™„ÅÑ„Çà„ÅÜ„Å†„ÄÇ"); }
            });
            createBtn("Á´ã„Å°Âéª„Çã", () => {});
        } else if (type === "gambler") {
            title = "ÊÄ™„Åó„ÅÑ„ÇÆ„É£„É≥„Éñ„É©„Éº"; desc = "„ÄåÈáëË≤®„ÅÆË£èË°®„ÇíÂΩì„Å¶„Åü„ÇâÂÄç„Å´„Åó„Å¶„ÇÑ„Çã„Äç";
            const bet = Math.floor(this.gold / 2);
            if(bet > 0) {
                createBtn(`ÂãùË≤†„Åô„Çã (Ë≥≠„ÅëÈáë:${bet}G)`, () => {
                    if(Math.random() < 0.5) {
                        this.gold += bet;
                        this.log(`Âãù„Å£„ÅüÔºÅ ${bet}G Â¢ó„Åà„ÅüÔºÅ`, "critical"); this.sound.playSE('coin');
                    } else {
                        this.gold -= bet;
                        this.log(`Ë≤†„Åë„Åü... ${bet}G Â§±„Å£„Åü...`, "damage");
                    }
                });
            } else { desc = "„ÄåÈáë„ÅåÁÑ°„ÅÑÂ•¥„Å´Áî®„ÅØ„Å™„ÅÑ„Å™„Äç"; }
            createBtn("ËààÂë≥„Å™„ÅÑ", () => {});
        } else if (type === "mimic_trap") {
            title = "Ë±™ËèØ„Å™ÂÆùÁÆ±"; desc = "„Åó„Åã„Åó„ÄÅÊÆ∫Ê∞ó„ÇíÊÑü„Åò„Çã...";
            createBtn("Èñã„Åë„Çã (Âç±Èô∫)", () => {
                if(Math.random() < 0.7) {
                    this.el.eventDisplay.style.display = "none";
                    this.log("ÂÆùÁÆ±„ÅØ„Éü„Éü„ÉÉ„ÇØ„Å†„Å£„ÅüÔºÅ", "damage");
                    this.startMimicBattle(); // Start special battle
                } else {
                    this.log("‰∏≠Ë∫´„ÅØ„Ç¢„Ç§„ÉÜ„É†„Å†„Å£„ÅüÔºÅ");
                    this.checkDrop(true); // Force drop
                    this.endEvent();
                }
            });
            createBtn("ÁÑ°Ë¶ñ„Åô„Çã", () => {});
        } else if (type === "altar") {
            title = "Ë°Ä„ÅÆÁ•≠Â£á"; desc = "Êçß„Åí„Çà...„Åï„Çâ„Å∞‰∏é„Åà„Çâ„Çå„Çì...";
            const sac = Math.floor(this.maxHp / 2);
            createBtn(`Ë°Ä„ÇíÊçß„Åí„Çã (HPÂçäÊ∏õ / Êîª+20%)`, () => {
                if(sac > 5) {
                    this.maxHp -= sac; this.hp = Math.min(this.hp, this.maxHp);
                    const gain = Math.floor(this.baseAtk * 0.2) + 5;
                    this.baseAtk += gain;
                    this.log(`ÊúÄÂ§ßHP„Åå ${sac} Ê∏õ„Çä„ÄÅÂäõ„Åå ${gain} ‰∏ä„Åå„Å£„ÅüÔºÅ`, "critical"); this.sound.playSE('crit');
                }
            });
            createBtn("Á´ã„Å°Âéª„Çã", () => {});
        }
        
        this.el.eventTitle.textContent = title;
        this.el.eventDesc.textContent = desc;

        // MODIFIED: Auto Event
        if (this.isAutoMode) {
            setTimeout(() => {
                // Ensure state is still EVENT (user didn't manually click)
                if (this.state === "EVENT" && this.el.eventChoices.children.length > 0) {
                    this.el.eventChoices.children[0].click();
                }
            }, 1000);
        }
    }
    
    endEvent() {
        this.el.eventDisplay.style.display = "none";
        this.el.enemy.style.display = "block";
        this.updateHud();
        if(this.state !== "BATTLE_CMD") {
            this.state = "BATTLE_WAIT"; this.el.btnMain.style.display = "block";
            
            // MODIFIED: Auto Event
            if (this.isAutoMode) {
                setTimeout(() => {
                    if (this.state === "BATTLE_WAIT") {
                        this.handleMainBtn();
                    }
                }, 800);
            }
        }
    }

    startBattle() {
        this.state = "BATTLE_CMD"; this.el.btnMain.style.display = "none"; this.el.menuBattle.style.display = "flex"; this.el.itemPop.style.display = "none";
        this.noDamageNow = true;
        if (this.lv >= this.targetLv) { this.startBossBattle("boss"); return; }
        if (this.lv === 10 || this.lv === 20) { this.startBossBattle("mid"); return; }
        if(!this.isDefenseMode) this.sound.playBGM('battle');
        
        let type = "slime", eName = "„Çπ„É©„Ç§„É†", gauge="normal", metal=false, goldMult=1, expMult=1;
        const tier = Math.floor((this.lv - 1) / 3);
        
        if (Math.random() < 0.1) { 
            if (Math.random() < 0.5) { type="metal_s"; eName="„É°„Çø„É´„Çπ„É©„Ç§„É†"; gauge="fast"; metal=true; expMult=20; }
            else { type="goldman"; eName="„Ç¥„Éº„É´„Éâ„Éû„É≥"; gauge="normal"; goldMult=30; }
        } else {
            const types = ["slime", "bat", "rabbit", "skeleton", "ghost", "knight", "wizard", "golem", "mimic", "cerberus", "dullahan", "chimera", "demon", "dragon", "lich", "fallen", "angel", "reaper"];
            type = types[Math.min(tier, types.length-1)] || "slime";
            const pres = ["", "<ruby>Âá∂Êö¥<rt>„Éû„ÉÉ„Éâ</rt></ruby>„Å™", "<ruby>Ê≠¥Êà¶<rt>„Éô„ÉÜ„É©„É≥</rt></ruby>„ÅÆ", "<ruby>ÊöóÈªí<rt>„ÉÄ„Éº„ÇØ</rt></ruby>„ÅÆ", "<ruby>Áúü<rt>„Ç∑„É≥</rt></ruby>„Éª", "<ruby>Ê•µ<rt>„Ç¢„É´„ÉÜ„Ç£„É°„ÉÉ„Éà</rt></ruby>„Éª", "<ruby>ÁçÑÁÇé<rt>„Ç§„É≥„Éï„Çß„É´„Éé</rt></ruby>„ÅÆ"];
            const pre = pres[Math.min(Math.floor(this.lv/5) + Math.floor(this.generation/2), 6)];
            
            const nameMap = {
                slime: "„Çπ„É©„Ç§„É†", bat: "„Éê„ÉÉ„Éà", rabbit: "„É©„Éì„ÉÉ„Éà", skeleton: "„Çπ„Ç±„É´„Éà„É≥", ghost: "„Ç¥„Éº„Çπ„Éà",
                knight: "„Éä„Ç§„Éà", wizard: "„Ç¶„Ç£„Ç∂„Éº„Éâ", golem: "„Ç¥„Éº„É¨„É†", mimic: "<ruby>‰∫∫È£ü„ÅÑÁÆ±<rt>„Éü„Éü„ÉÉ„ÇØ</rt></ruby>",
                cerberus: "„Ç±„É´„Éô„É≠„Çπ", dullahan: "„Éá„É•„É©„Éè„É≥", chimera: "„Ç≠„É°„É©", demon: "„Éá„Éº„É¢„É≥",
                dragon: "„Éâ„É©„Ç¥„É≥", lich: "„É™„ÉÉ„ÉÅ", fallen: "<ruby>Â†ïÂ§©‰Ωø<rt>„Éï„Ç©„Éº„É´„É≥</rt></ruby>", angel: "<ruby>Â§©‰Ωø<rt>„Ç®„É≥„Ç∏„Çß„É´</rt></ruby>", reaper: "<ruby>Ê≠ªÁ•û<rt>„Ç∞„É™„É†„É™„Éº„Éë„Éº</rt></ruby>"
            };

            eName = pre + (nameMap[type] || type);
            gauge = tier > 4 ? (tier > 8 ? "super_fast" : "fast") : "normal";
            
            if (type === "ghost" || type === "fallen") gauge = "blink";
            if (type === "mimic" || type === "dullahan") gauge = "stop_go";
            if (type === "reaper" || type === "lich") gauge = "reverse";
            if (tier > 7 && Math.random() < 0.3) gauge = "wavy";
        }
        
        // BALANCE UPDATE: Inflation based on Clears (Demon Gen)
        const inflation = Math.pow(1.5, this.clears);
        let diff = inflation * (1 + (this.lv * 0.1));
        
        this.enemy = { 
            name: eName, type: type, 
            maxHp: Math.floor((20 + Math.pow(this.lv, 1.8)) * diff), 
            hp: Math.floor((20 + Math.pow(this.lv, 1.8)) * diff),
            atk: Math.floor((5 + Math.pow(this.lv, 1.5)) * diff), 
            gaugeType: gauge, isMetal: metal, expMult, goldMult 
        };
        
        this.renderEnemy(type, metal);
        this.el.enemy.style.opacity = 0;
        this.el.enemy.style.transform = "scale(0.5)";
        this.el.enemy.style.display = "block"; // Ensure visible
        requestAnimationFrame(() => { 
             this.el.enemy.style.opacity = 1; 
             this.el.enemy.style.transform = "scale(1)";
        });
        
        if (Math.random() < 0.6) { 
            const line = TALK_PATTERNS.start[Math.floor(Math.random() * TALK_PATTERNS.start.length)];
            this.showBattleTalk(line, 2000);
        }
        
        this.log(`${this.enemy.name} „Åå„ÅÇ„Çâ„Çè„Çå„ÅüÔºÅ`);
        
        // ADDED: Auto Attack Logic
        if(this.isAutoMode) {
             setTimeout(() => {
                 // Check if still in battle command state (player didn't manually intervene)
                 if(this.state === "BATTLE_CMD") {
                     this.selectAttack();
                 }
             }, 400); // Small delay to let animations finish
        }
    }

    // Special Battle for Mimic Trap
    startMimicBattle() {
        this.state = "BATTLE_CMD"; this.el.btnMain.style.display = "none"; this.el.menuBattle.style.display = "flex";
        this.noDamageNow = true;
        
        const inflation = Math.pow(1.5, this.clears) * 2; // Stronger than normal
        this.enemy = {
            name: "<ruby>Ë≤™Ê¨≤<rt>„Ç∞„É™„Éº„Éâ</rt></ruby>„Éü„Éü„ÉÉ„ÇØ", type: "mimic",
            maxHp: Math.floor((50 + Math.pow(this.lv, 1.9)) * inflation),
            hp: Math.floor((50 + Math.pow(this.lv, 1.9)) * inflation),
            atk: Math.floor((10 + Math.pow(this.lv, 1.6)) * inflation),
            gaugeType: "stop_go", isMetal: false, expMult: 5, goldMult: 5, isMimicEvent: true
        };
        
        this.renderEnemy("mimic", false);
        this.el.enemy.style.display = "block";
        this.showCutin("TRAP!!");
        this.log("„Éü„Éü„ÉÉ„ÇØ„ÅåË•≤„ÅÑ„Åã„Åã„Å£„Å¶„Åç„ÅüÔºÅ");
        
        // ADDED: Auto Attack Logic
        if(this.isAutoMode) {
             setTimeout(() => { if(this.state === "BATTLE_CMD") this.selectAttack(); }, 800);
        }
    }
    
    async startBossBattle(type) {
        // ADDED: Safety Stop for Boss (Demon King)
        if(type === 'boss' && this.isAutoMode) {
            this.toggleAutoMode(false);
            this.log("È≠îÁéã„ÅÆÊ∞óËø´„Å´ÂúßÂÄí„Åï„Çå„ÄÅAUTO„É¢„Éº„Éâ„ÅåËß£Èô§„Åï„Çå„ÅüÔºÅ", "damage");
        }

        if(!this.isDefenseMode) this.sound.playBGM('boss');
        const isMaou = type === "boss";
        
        // BALANCE UPDATE: Boss Inflation
        const inflation = Math.pow(1.5, this.clears);
        
        let name = isMaou ? `Á¨¨${this.clears+1}‰ª£ <ruby>È≠îÁéã<rt>„ÉÄ„Éº„ÇØ„É≠„Éº„Éâ</rt></ruby>` : "<ruby>È≠îÁïå<rt>„Ç¢„Éì„Çπ</rt></ruby>„ÅÆ<ruby>Áï™‰∫∫<rt>„Ç¨„Éº„Éá„Ç£„Ç¢„É≥</rt></ruby>";
        let eType = isMaou ? "boss" : (Math.random() < 0.5 ? "asura" : "general");
        
        const baseHp = isMaou ? 1000 : 500;
        const baseAtk = isMaou ? 50 : 30;

        this.enemy = { 
            name: name, type: eType, 
            maxHp: Math.floor(baseHp * inflation * (1+this.lv*0.1)), 
            hp: Math.floor(baseHp * inflation * (1+this.lv*0.1)), 
            atk: Math.floor(baseAtk * inflation * (1+this.lv*0.05)), 
            gaugeType: "super_fast", isMetal: false, expMult: 3, goldMult: 100 
        };
        
        this.renderEnemy(this.enemy.type, false, true);
        this.el.enemy.style.display = "block";
        this.el.enemy.style.opacity = 0;
        this.el.enemy.style.transform = "scale(2)";
        requestAnimationFrame(() => { 
             this.el.enemy.style.opacity = 1; 
             this.el.enemy.style.transform = "scale(1.2)";
        });
        
        const line = isMaou ? "„Çà„Åè„Åû„Åì„Åì„Åæ„ÅßÊù•„Åü‚Ä¶Ë§í„ÇÅ„Å¶„ÇÑ„Çç„ÅÜ" : "„Åì„Åì„ÇíÈÄö„Åô„Çè„Åë„Å´„ÅØ„ÅÑ„Åã„Çì‚Ä¶";
        setTimeout(() => this.showBattleTalk(line, 3000), 1000);

        this.showCutin(isMaou ? "È≠îÁéã ÈôçËá®" : "Âº∑Êïµ Âá∫Áèæ");

        // ADDED: Auto Attack Logic (For Mid-Boss only, as Boss stops auto)
        if(this.isAutoMode) {
             setTimeout(() => { if(this.state === "BATTLE_CMD") this.selectAttack(); }, 1200);
        }
    }
    
    showBattleTalk(text, duration, actorKey = null, nameOverride = null) {
        this.el.drama.style.display = "flex";
        const key = actorKey || this.enemy.type;
        const name = nameOverride || this.enemy.name;
        this.el.dramaActor.innerHTML = generateSVG(SPRITES[key] || SPRITES.slime);
        this.el.dramaName.innerHTML = name;
        this.el.dramaText.textContent = text;
        if (this.dramaTimer) clearTimeout(this.dramaTimer);
        this.dramaTimer = setTimeout(() => { this.el.drama.style.display = "none"; }, duration);
    }

    selectAttack() { this.sound.playSE('select'); this.selectedSkill = null; this.el.menuBattle.style.display = "none"; this.startGauge(); }
    selectHeal() { this.sound.playSE('select'); if(this.mp<5){this.log("MP‰∏çË∂≥ÔºÅ");return;} this.useSkill(SKILLS.find(s=>s.id==="heal")); }
    
    openSkills() {
        this.sound.playSE('select'); this.el.menuBattle.style.display = "none"; this.el.menuSkills.style.display = "flex"; this.el.menuSkills.innerHTML = "";
        const addBtn = (s) => {
            const b = document.createElement('button'); 
            b.className = "cmd-btn";
            b.innerHTML = `${s.name} <span style="font-size:0.8rem;color:#88f">(MP:${s.mp})</span>`;
            b.onclick = () => this.useSkill(s); if(this.mp<s.mp) { b.disabled=true; b.style.color="#555"; } 
            this.el.menuSkills.appendChild(b);
        };
        if(this.weapon && this.weapon.skillId) addBtn(SKILLS.find(s=>s.id===this.weapon.skillId));
        if(this.lv>=3) addBtn(SKILLS.find(s=>s.id==="heal"));
        
        const back = document.createElement('button'); back.className="cmd-btn"; back.textContent="„ÇÇ„Å©„Çã"; back.onclick=()=>{this.sound.playSE('select');this.el.menuSkills.style.display="none";this.el.menuBattle.style.display="flex";};
        this.el.menuSkills.appendChild(back);
    }
    
    useSkill(skill) {
        this.sound.playSE('select'); this.mp -= skill.mp; this.updateHud();
        if(skill.type==="heal") {
            let h = skill.heal + Math.floor(Math.random()*10) + this.boosts.atk;
            this.hp = Math.min(this.maxHp, this.hp+h); this.updateHud(); this.showDamage(h, 'heal', false);
            this.log(`${skill.name}ÔºÅ ‰ΩìÂäõ„Åå ${h} ÂõûÂæ©„Åó„ÅüÔºÅ`, "revive"); this.sound.playSE('revive');
            this.el.menuSkills.style.display="none"; setTimeout(()=>this.enemyTurn(),800);
        } else {
            this.selectedSkill = skill; this.el.menuSkills.style.display="none"; this.startGauge();
        }
    }

    handleActionBtn() {
        if(this.state === "GAUGE") this.stopGauge();
        else if(this.state === "ENEMY_TURN" && this.isGuardWindow) this.attemptGuard();
    }

    startGauge() {
        this.state = "GAUGE"; 
        this.el.btnStopWrapper.style.display="block"; 
        this.el.btnStop.className = "btn-big-action btn-stop";
        this.el.btnStop.textContent = "STOP!";
        
        this.el.gaugeArea.style.display="block";
        this.gaugeVal=0; this.gaugeDir=1;
        this.gaugeSpeed = (2 + (this.lv*0.1)) * (this.enemy.gaugeType==="fast"?1.5:(this.enemy.gaugeType==="super_fast"?2.5:1));
        if(this.enemy.gaugeType === "slow") this.gaugeSpeed = 0.5;
        
        if(this.weapon && this.weapon.effect === "slow") this.gaugeSpeed *= 0.7;
        if(this.accessory && this.accessory.effect === "haste") this.gaugeSpeed *= 0.8;

        this.el.gaugeCursor.style.opacity = 1;

        // ADDED: Calculate Auto Target
        if (this.isAutoMode) {
            // Luck influences precision. High Luck -> closer to 50.
            // Variance: 15 (Great) ~ 2 (Perfect)
            const baseVariance = Math.max(2, 15 - (this.boosts.luck * 0.5) - (this.accessory?.effect === 'lucky' ? 5 : 0));
            const randomVariance = Math.random() * baseVariance;
            const sign = Math.random() < 0.5 ? 1 : -1;
            this.autoTarget = 50 + (randomVariance * sign);
            
            // Limit target to reasonable bounds (e.g. 35-65) to avoid misses if variance is high
            this.autoTarget = Math.max(35, Math.min(65, this.autoTarget));
        } else {
            this.autoTarget = null;
        }

        this.runGauge();
    }
    runGauge() {
        if(this.state!=="GAUGE") return;
        let spd = this.gaugeSpeed;
        const t = this.enemy.gaugeType;
        if (t === "stop_go") { if (Math.random() < 0.1) spd = 0; }
        else if (t === "blink") { this.el.gaugeCursor.style.opacity = (Math.floor(Date.now() / 100) % 2) ? 0 : 1; }
        else if (t === "wavy") { spd = this.gaugeSpeed * (Math.sin(Date.now() / 200) + 1.5); }
        if (t === "reverse") { if (this.gaugeDir === 1) this.gaugeVal -= spd; else this.gaugeVal += spd; } else { this.gaugeVal += spd * this.gaugeDir; }

        if(this.gaugeVal>=100){this.gaugeVal=100;this.gaugeDir=-1;} if(this.gaugeVal<=0){this.gaugeVal=0;this.gaugeDir=1;}
        this.el.gaugeCursor.style.left = this.gaugeVal+"%"; 
        
        // ADDED: Auto Trigger
        if (this.isAutoMode && this.autoTarget !== null) {
            // Since we usually hit on the way UP (dir=1), trigger if we cross the target
            // Only trigger if we are in the "sweet spot" range (30-70) to avoid early misfires if target is weird
            if (this.gaugeDir === 1 && this.gaugeVal >= this.autoTarget) {
                this.stopGauge();
                return; // Stop recursion
            }
        }
        
        requestAnimationFrame(()=>this.runGauge());
    }
    
    async stopGauge() {
        if(this.state!=="GAUGE") return; this.state="ANIM"; this.el.btnStopWrapper.style.display="none";
        this.sound.playSE('attack');
        let dist = Math.abs(50-this.gaugeVal), mult=1.0, isCrit=false;
        
        let safeZone = 5;
        if (this.weapon && this.weapon.effect === "scope") safeZone = 10;
        if (this.acquiredTitles.has("t_godspeed")) safeZone += 2;

        if(dist <= safeZone) {
            this.chain++; isCrit = true; mult = 1.2 + (this.chain * 0.3); 
            if(this.accessory && this.accessory.effect === "crit_up") mult += 0.5;
            this.showChainPop(`${this.chain}ÈÄ£ÊíÉ`);
            this.checkDefenseMode(); 
        } else if (dist <= 15) { 
            if (this.enemy.isMetal && Math.random() < 0.5) { isCrit = true; this.log("Á•ûÈÄü„ÅÆÂâ£ÈñÉÔºÅ", "critical"); }
            mult = 1.0; this.chain = 0; this.checkDefenseMode(); 
        } else {
            if(this.chain > 0) this.log("ÈõÜ‰∏≠Âäõ„ÅåÈÄîÂàá„Çå„Åü...", "damage");
            this.chain = 0; mult = 0.5; this.checkDefenseMode(); 
        }
        
        await this.delay(300); this.el.gaugeArea.style.display="none";
        await this.performAttack(mult, isCrit);
    }

    async performAttack(mult, isCrit) {
        this.el.enemy.classList.add("anim-shake"); 
        let dmgBase = this.totalAtk * (this.selectedSkill ? this.selectedSkill.dmg : 1.0);
        let times = this.selectedSkill && this.selectedSkill.times ? this.selectedSkill.times : 1;
        
        for(let i=0; i<times; i++) {
            let dmg = Math.floor(dmgBase * mult);
            if(this.enemy.isMetal) {
                dmg = (isCrit || (this.weapon&&this.weapon.id==="metal_w")) ? this.enemy.maxHp : (Math.random()<0.5 ? 0 : 1);
                if(dmg>0) this.sound.playSE('metal');
            } else {
                if(isCrit) { this.showCutin("‰ºöÂøÉ„ÅÆ‰∏ÄÊíÉ"); this.sound.playSE('crit'); } else { this.sound.playSE('hit'); }
            }
            if(dmg>0) { 
                this.log(`${this.enemy.name}„Å´ ${dmg} „ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`, isCrit ? "critical" : "");
                this.showDamage(dmg, 'deal', isCrit); this.enemy.hp-=dmg; 
                
                if (this.enemy.hp < this.enemy.maxHp * 0.3 && Math.random() < 0.4) {
                    this.showBattleTalk(TALK_PATTERNS.pinch[Math.floor(Math.random()*TALK_PATTERNS.pinch.length)], 1000);
                } else if (Math.random() < 0.2) {
                    this.showBattleTalk(TALK_PATTERNS.hit[Math.floor(Math.random()*TALK_PATTERNS.hit.length)], 1000);
                }

                if ((this.weapon && this.weapon.effect === "drain") || (this.accessory && this.accessory.effect === "drain")) {
                     let drain = Math.floor(dmg * 0.2);
                     if(drain > 0) {
                         this.hp = Math.min(this.maxHp, this.hp + drain);
                         this.log(`Ë°Ä„ÇíÂïú„Çä ${drain} ÂõûÂæ©ÔºÅ`, "revive");
                     }
                }
            } else { 
                this.log(`„Éü„ÇπÔºÅ ${this.enemy.name}„Å´„ÉÄ„É°„Éº„Ç∏„Çí‰∏é„Åà„Çâ„Çå„Å™„ÅÑÔºÅ`); this.showDamage("Miss", 'miss', false); 
            }
            await this.delay(200);
        }
        this.updateHud(); 
        setTimeout(() => this.el.enemy.classList.remove("anim-shake"), 200);
        if(this.enemy.hp<=0) this.winBattle(); else this.enemyTurn();
    }

    async enemyTurn() {
        this.state = "ENEMY_TURN";
        await this.delay(400);
        
        if (this.enemy.isMetal && Math.random() < 0.5) {
            this.log(`${this.enemy.name}„ÅØÈÄÉ„ÅíÂá∫„Åó„ÅüÔºÅ`, "system");
            this.el.enemy.style.opacity = 0;
            await this.delay(1000);
            this.state = "BATTLE_WAIT"; 
            this.el.btnMain.style.display = "block"; 
            this.el.btnMain.textContent = "„Åï„Çâ„Å´Â••„Å∏";
            // Auto Continue
            if (this.isAutoMode) { setTimeout(()=>this.handleMainBtn(), 500); }
            return;
        }

        this.log(`${this.enemy.name}„ÅÆÊîªÊíÉÔºÅ`, "damage");
        this.el.enemy.style.transform = "scale(1.2)";
        
        this.el.btnStopWrapper.style.display = "block";
        this.el.btnStop.className = "btn-big-action btn-guard";
        this.el.btnStop.textContent = "GUARD!";
        
        this.isGuardWindow = true;
        this.guardStart = Date.now();
        this.guardSuccess = false;
        
        // Auto Guard Logic (Simple: 50% chance, or higher based on luck/speed?)
        // Let's make Auto Guard 50% chance to be fair, or it becomes too OP.
        // Or make it rely on Titles. For now, no Auto Guard requested, so just let it take damage or rely on Defense Mode.
        
        await this.delay(600);
        
        this.isGuardWindow = false;
        this.el.btnStopWrapper.style.display = "none";
        this.el.enemy.style.transform = "scale(1)";

        if (this.isDefenseMode) {
             this.sound.playSE('metal');
             this.log(`Áµ∂ÂØæÈò≤Âæ°Áïå„Åå„ÉÄ„É°„Éº„Ç∏„ÇíÁÑ°ÂäπÂåñ„Åó„ÅüÔºÅ`, "block");
             this.showDamage("BLOCK", 'block', false);
             this.mp = Math.max(0, this.mp - 2); 
             if(this.mp <= 0) this.breakDefenseMode();
             this.updateHud();
             this.state = "BATTLE_CMD"; this.el.menuBattle.style.display = "flex";
             // Auto Attack Next Round
             if (this.isAutoMode) setTimeout(() => this.selectAttack(), 500);
             return;
        }

        if (this.guardSuccess) {
            let counterDmg = Math.floor(this.totalAtk * 1.5);
            this.log(`„Ç´„Ç¶„É≥„Çø„ÉºÔºÅ ${this.enemy.name}„Å´ ${counterDmg} „ÅÆ„ÉÄ„É°„Éº„Ç∏ÔºÅ`, "critical");
            this.showDamage(counterDmg, 'deal', true);
            this.enemy.hp -= counterDmg;
            this.sound.playSE('crit');
            if(this.enemy.hp<=0) { this.winBattle(); return; }
        } else {
            this.noDamageNow = false;
            let dmg = Math.max(1, this.enemy.atk - Math.floor(Math.random()*3));
            
            if (this.armor && this.armor.effect === "reflect") {
                 let ref = Math.floor(dmg * 0.3);
                 if(ref > 0) { this.enemy.hp -= ref; this.log(`Âë™Ë©õËøî„ÅóÔºÅÊïµ„Å´ ${ref} „ÉÄ„É°„Éº„Ç∏ÔºÅ`, "damage"); }
            }

            dmg = Math.max(1, Math.floor(dmg - (this.totalDef / 2)));
            if(Math.random()<0.15 && !this.enemy.isMetal) { dmg=Math.floor(dmg*1.5); this.log("ÁóõÊÅ®„ÅÆ‰∏ÄÊíÉÔºÅ","damage"); }
            
            this.hp-=dmg; this.updateHud(); 
            this.log(`${dmg} „ÅÆ„ÉÄ„É°„Éº„Ç∏„ÇíÂèó„Åë„ÅüÔºÅ`, "damage"); this.showDamage(dmg, 'take', false); this.sound.playSE('hit');
            this.el.stage.style.transform = "translate(5px, 5px)"; setTimeout(() => this.el.stage.style.transform = "translate(0, 0)", 100);
        }

        if ((this.armor && this.armor.effect === "regen") || (this.accessory && this.accessory.effect === "regen")) {
            let reg = Math.floor(this.maxHp * 0.05);
            if(reg>0 && this.hp > 0) { this.hp = Math.min(this.maxHp, this.hp+reg); this.updateHud(); }
        }

        if (this.hp <= 0) {
            if(this.accessory && this.accessory.effect === "rebirth") {
                this.hp = Math.floor(this.maxHp * 0.5);
                this.log("„Éï„Çß„Éã„ÉÉ„ÇØ„Çπ„ÅÆÂ∞æ„ÅåËºù„Åç„ÄÅËòá„ÇãÔºÅ", "revive");
                this.accessory = null;
                this.updateHud();
                this.sound.playSE('revive');
                this.showCutin("Âæ© Ê¥ª");
                this.state = "BATTLE_CMD"; this.el.menuBattle.style.display = "flex";
                if(this.isAutoMode) setTimeout(() => this.selectAttack(), 500);
            } else {
                this.sound.stopBGM();
                await this.tryRevival();
            }
        } else {
            this.state = "BATTLE_CMD"; this.el.menuBattle.style.display = "flex";
            if(this.isAutoMode) setTimeout(() => this.selectAttack(), 500);
        }
    }
    
    attemptGuard() {
        if(!this.isGuardWindow) return;
        const now = Date.now();
        if (now - this.guardStart <= 250) {
            this.guardSuccess = true;
            this.isGuardWindow = false;
            this.sound.playSE('parry');
            this.el.flashInv.classList.add("anim-invert");
            setTimeout(() => this.el.flashInv.classList.remove("anim-invert"), 300);
            
            const txtObj = GUARD_TEXTS[Math.floor(Math.random()*GUARD_TEXTS.length)];
            const rubyHtml = `<ruby>${txtObj.t}<rt>${txtObj.r}</rt></ruby>`;
            
            this.el.cutin.innerHTML = rubyHtml;
            this.el.cutin.classList.add("just");
            this.el.cutin.style.transform="translate(-50%,-50%) scale(1)";
            setTimeout(()=>{
                this.el.cutin.style.transform="translate(-50%,-50%) scale(0)";
                this.el.cutin.classList.remove("just");
            }, 1000);
            this.log("Ë¶ãÂàá„Å£„ÅüÔºÅ", "critical");
        } else {
            this.log("Èò≤Âæ°„ÅåÈÅÖ„Çå„ÅüÔºÅ");
        }
    }

    async winBattle() {
        if (this.noDamageNow) {
            this.noDamageStreak++;
            if (this.noDamageStreak >= 5 && !this.acquiredTitles.has("t_unscathed")) {
                this.acquiredTitles.add("t_unscathed");
                this.log("Áß∞Âè∑‚â™ÁÑ°ÂÇ∑„ÅÆÂ∏ùÁéã‚â´„ÇíÁç≤ÂæóÔºÅ(ÈÅãUP)", "critical");
                this.saveData();
            }
        } else {
            this.noDamageStreak = 0;
        }

        if (this.enemy.type === "boss") {
            this.sound.stopBGM();
            this.sound.playBGM('clear');
            this.log(`È≠îÁéã„ÇíË®é‰ºê„Åó„ÅüÔºÅ`, "critical");
            this.showBattleTalk(TALK_PATTERNS.die[Math.floor(Math.random()*TALK_PATTERNS.die.length)], 2000);
            
            this.el.enemy.style.transition = "all 2s";
            this.el.enemy.style.opacity = 0;
            this.el.enemy.style.filter = "brightness(5)";
            this.showCutin("ÂÆåÂÖ®ÂãùÂà©");
            await this.delay(3000);
            
            this.clears++;
            this.gold += 10000 * (1 + this.clears);
            this.saveData();
            
            this.log("‰∏ñÁïå„Å´Âπ≥Âíå„ÅåÊàª„Å£„Åü...", "revive");
            this.log(`„ÇØ„É™„Ç¢ÂõûÊï∞: ${this.clears}`, "revive");
            await this.delay(2000);
            
            this.openShop();
            return;
        }

        this.log(`${this.enemy.name}„ÇíÂÄí„Åó„Åü„ÄÇ`, "critical");
        if (Math.random() < 0.3) {
            this.showBattleTalk(TALK_PATTERNS.die[Math.floor(Math.random()*TALK_PATTERNS.die.length)], 1000);
        }

        this.sound.playSE('select'); 
        this.el.enemy.style.transition = "opacity 1s, transform 1s";
        this.el.enemy.style.opacity = 0;
        this.el.enemy.style.transform = "scale(0.1) rotate(180deg)";
        await this.delay(1000);
        
        this.lv += 1;
        const mult = this.enemy.expMult;
        
        // BALANCE: Stat gain
        this.maxHp += 4 * mult; this.hp = Math.min(this.maxHp, this.hp + 20);
        this.baseAtk += 1 * mult; this.maxMp += 2 * mult; this.mp += 2 * mult;
        
        let goldRate = 1.0;
        if(this.armor && this.armor.effect === "greed") goldRate += 0.5;
        if(this.weapon && this.weapon.effect === "greed") goldRate += 0.5;
        if(this.accessory && this.accessory.effect === "greed") goldRate += 0.5;

        let g = Math.floor((10 + this.lv*2)*this.enemy.goldMult * goldRate * (1 + this.clears * 0.5)); 
        this.gold+=g;
        
        this.updateHud(); 
        this.log(mult > 1 ? `${g}G Âº∑Â•™„ÄÇËé´Â§ß„Å™ÁµåÈ®ìÂÄ§„ÇíÂæó„Åü„ÄÇ(Lv+1)` : `${g}G Áç≤Âæó„ÄÇLv${this.lv}„Å´Âà∞ÈÅî„ÄÇ`);
        this.sound.playSE('coin');
        await this.checkDrop(this.enemy.isMimicEvent);
    }

    async checkDrop(forceDrop = false) {
        if (Math.random() < 0.05 && SOULS[this.enemy.type]) {
            const soulData = SOULS[this.enemy.type];
            const soulItem = { 
                id: `soul_${this.enemy.type}`, type: "acc", 
                name: soulData.name, atk: 0, def: 0, 
                prob: 0, sprite: "soul", color: soulData.color,
                soulEffect: soulData.effect, effectName: soulData.effectName, val: soulData.val
            };
            this.acquiredItems.add(soulItem.id);
            this.pendingItem = soulItem;
            this.log("Êïµ„ÅÆÈ≠Ç„ÅåÂÖ∑ÁèæÂåñ„Åó„Åü...", "revive");
            
            // Auto Equip check for Soul
            if (this.isAutoMode) {
                 await this.autoEquipCheck(soulItem);
            } else {
                 await this.showItemCompare(soulItem);
            }
            return;
        }

        if (forceDrop || Math.random() < 0.4) { 
            let drop = ITEMS[Math.floor(Math.random()*ITEMS.length)]; 
            
            // BALANCE UPDATE: Item Inflation
            const inflation = Math.pow(1.5, this.clears);
            
            let scale = Math.pow(1.15, this.lv/5) * (1 + this.generation * 0.5) * inflation;
            let newI = JSON.parse(JSON.stringify(drop)); 
            if(newI.atk) newI.atk = Math.floor(newI.atk * scale);
            if(newI.def) newI.def = Math.floor(newI.def * scale);

            this.acquiredItems.add(drop.id);
            this.pendingItem = newI;
            
            // ADDED: Auto Equip Check
            if (this.isAutoMode) {
                 await this.autoEquipCheck(newI);
            } else {
                 await this.showItemCompare(newI);
            }
        } else {
            this.state="BATTLE_WAIT"; 
            this.el.btnMain.textContent="„Åï„Çâ„Å´Â••„Å∏"; 
            this.el.btnMain.style.display="block"; 
            if(!this.isDefenseMode) this.sound.playBGM('battle');
            // Auto Continue
            if (this.isAutoMode) { setTimeout(()=>this.handleMainBtn(), 500); }
        }
    }

    // ADDED: Auto Equip Logic
    async autoEquipCheck(item) {
        let cur = null;
        if (item.type === "acc") cur = this.accessory;
        else if (item.type === "a") cur = this.armor;
        else cur = this.weapon;

        const getStat = (i) => (i ? (i.atk||0) + (i.def||0) : 0);
        const curVal = getStat(cur);
        const newVal = getStat(item);

        // Simple logic: If new item is stronger or equal, take it. Else sell.
        // Also prioritize Souls if slot is empty or weak? 
        // For simplicity, stick to raw stat sum.
        const take = newVal >= curVal;
        
        this.decideItem(take);
        
        // No promise resolve needed as decideItem continues flow, but for consistency:
        return Promise.resolve();
    }
    
    showItemCompare(item) {
        return new Promise(resolve => {
            this.el.menuBattle.style.display = "none";
            this.el.chestDisplay.style.display = "flex";
            this.el.enemy.style.display = "none";
            
            this.el.menuChest.style.display = "flex";
            this.el.btnGet.style.opacity = 0.3; this.el.btnGet.style.pointerEvents = "none";
            this.el.btnDiscard.style.opacity = 0.3; this.el.btnDiscard.style.pointerEvents = "none";
            
            setTimeout(()=>{
                this.el.btnGet.style.opacity = 1; this.el.btnGet.style.pointerEvents = "auto";
                this.el.btnDiscard.style.opacity = 1; this.el.btnDiscard.style.pointerEvents = "auto";
            }, 800);

            const isArmor = item.type === "a";
            const isAcc = item.type === "acc";
            
            let cur;
            if (isAcc) cur = this.accessory || {name:"„Å™„Åó", sprite:"soul", color:"#333"};
            else if (isArmor) cur = this.armor || {name:"ÊóÖ‰∫∫„ÅÆÊúç", def:0, sprite:"a_cloth", color:"#fff"};
            else cur = this.weapon || {name:"Á¥†Êâã", atk:0, skillId:null, sprite:"stick", color:"#fff"};
            
            this.renderCard(this.el.curI, cur, item.type);
            this.renderCard(this.el.newI, item, item.type);
            this.resolveItem = resolve;
        });
    }
    
    renderCard(els, item, type) {
        if(!els.name) return;
        els.name.innerHTML = item.name;
        const sp = SPRITES[item.sprite] || SPRITES.stick;
        els.icon.innerHTML = generateSVG(sp, item.color);
        
        let statTxt = "";
        if (type === "acc") statTxt = `Êîª+${item.atk||0} ÂÆà+${item.def||0}`;
        else if (type === "a") statTxt = `ÂÆà+${item.def}`;
        else statTxt = `Êîª+${item.atk}`;
        els.stat.textContent = statTxt;
        
        let sText = "";
        if (item.skillId) { const s = SKILLS.find(k => k.id === item.skillId); if (s) sText = `ÊäÄ:${s.name.replace(/<rt>.*?<\/rt>/g,"")}`; }
        els.sub.textContent = sText;
        els.eff.textContent = item.effectName ? `‚òÖ${item.effectName}` : "";
    }
    
    calcPrice(item) {
        if(!item || !item.id) return 0;
        let base = (item.atk || 0) + (item.def || 0);
        return Math.floor(Math.max(10, base * 15) * (1 + this.generation * 0.1));
    }

    decideItem(take) {
        // Only play sound if UI is shown (manual mode) or just force it (auto mode)
        // Actually sound is fine in auto too for feedback
        if (!this.isAutoMode) this.sound.playSE('select');
        
        let soldPrice = 0;
        let soldName = "";

        if(take) {
            // Sell old
            let old;
            if(this.pendingItem.type === "acc") old = this.accessory;
            else if(this.pendingItem.type === "a") old = this.armor;
            else old = this.weapon;

            if(old) {
                soldPrice = this.calcPrice(old);
                soldName = old.name.replace(/<rt>.*?<\/rt>/g,"");
                this.gold += soldPrice;
                this.log(`${soldName}„Çí‰∏ãÂèñ„Çä (+${soldPrice}G)`, "system");
                if(!this.isAutoMode) this.sound.playSE('coin');
            }

            if (this.pendingItem.type === "acc") this.accessory = this.pendingItem;
            else if (this.pendingItem.type === "a") this.armor = this.pendingItem; 
            else this.weapon = this.pendingItem;
            this.log(`${this.pendingItem.name.replace(/<rt>.*?<\/rt>/g,"")}„ÇíË£ÖÂÇôÔºÅ`, "item"); 
            if(!this.isAutoMode) this.sound.playSE('revive');
        } else { 
            // Sell new (discarded)
            soldPrice = this.calcPrice(this.pendingItem);
            soldName = this.pendingItem.name.replace(/<rt>.*?<\/rt>/g,"");
            this.gold += soldPrice;
            this.log(`${soldName}„ÇíÂ£≤Âç¥ (+${soldPrice}G)`, "system");
            if(!this.isAutoMode) this.sound.playSE('coin');
        }
        
        this.el.chestDisplay.style.display = "none"; 
        this.el.menuChest.style.display = "none";
        this.el.enemy.style.display = "block";
        
        this.updateHud(); 
        
        this.state="BATTLE_WAIT"; 
        this.el.btnMain.textContent="„Åï„Çâ„Å´Â••„Å∏"; 
        this.el.btnMain.style.display="block"; 
        if(!this.isDefenseMode) this.sound.playBGM('battle');
        
        // Auto Continue
        if (this.isAutoMode) { setTimeout(()=>this.handleMainBtn(), 500); }
        
        if(this.resolveItem) this.resolveItem();
    }

    async tryRevival() {
        this.state="REVIVAL"; this.log("ÂãáËÄÖ„ÅØÂäõÂ∞Ω„Åç„Åü...","damage"); await this.delay(1500);
        this.log("ÈÅãÂëΩ„ÅÆÂ§©Áß§„ÅåÊè∫„Çå„Çã...", "system"); await this.delay(1000);
        
        if (Math.random() < this.revivalRate) {
            await this.playRevivalDrama();
            this.reviveCount++;
            if(this.reviveCount >= 1 && !this.acquiredTitles.has("t_immortal")) {
                this.acquiredTitles.add("t_immortal");
            }
            this.hp = Math.floor(this.maxHp * 0.6);
            this.updateHud();
            if(!this.isDefenseMode) this.sound.playBGM('boss');
            this.state = "BATTLE_CMD";
            this.el.menuBattle.style.display = "flex";
            if(this.isAutoMode) setTimeout(() => this.selectAttack(), 500);
        } else {
            this.log("......", "system");
            await this.delay(1000);
            this.gameOver();
        }
    }

    async playRevivalDrama() {
        const dramas = [
            [{a:"npc_princess",n:"ÁéãÂ•≥",t:"ÂãáËÄÖÊßòÔºÅ Ê≠ª„Å™„Å™„ÅÑ„ÅßÔºÅ"},{a:"npc_princess",n:"ÁéãÂ•≥",t:"ÁßÅ„ÅÆÁ•à„Çä„Çà...Â±ä„ÅëÔºÅÔºÅ"}],
            [{a:"npc_friend",n:"Êà¶Âèã",t:"„Åä„ÅÑÔºÅ „Åì„Åì„Åß„Åè„Åü„Å∞„Çã„ÅÆ„ÅãÔºü"},{a:"npc_friend",n:"Êà¶Âèã",t:"Á´ã„Å¶ÔºÅ ‰ø∫„ÅåÁõæ„Å´„Å™„ÇãÔºÅÔºÅ"}],
            [{a:"npc_king",n:"ÁéãÊßò",t:"„Åà„Åà„ÅÑÔºÅ ÊÉÖ„Åë„Å™„ÅÑ„ÇÑ„Å§„ÇÅÔºÅ"},{a:"npc_king",n:"ÁéãÊßò",t:"ÁâπÂà•„Å´„ÇÇ„ÅÜ‰∏ÄÂ∫¶ „ÉÅ„É£„É≥„Çπ„Çí„ÇÑ„Çç„ÅÜ..."}],
            [{a:"npc_healer",n:"Á•ûÁà∂",t:"„Åä„ÅäÁ•û„Çà..."},{a:"npc_healer",n:"Á•ûÁà∂",t:"„Åì„ÅÆËÄÖ„Å´ Âä†Ë≠∑„Çí‰∏é„Åà„Åü„Åæ„ÅàÔºÅ"}]
        ];
        const scene = dramas[Math.floor(Math.random() * dramas.length)];
        
        this.el.drama.style.display = "flex";
        for (const step of scene) {
             this.el.dramaActor.innerHTML = generateSVG(SPRITES[step.a] || SPRITES.slime);
             this.el.dramaName.textContent = step.n;
             this.el.dramaText.textContent = step.t;
             this.sound.playSE('select');
             await this.delay(2500);
        }
        this.el.drama.style.display = "none";
        this.el.flash.style.opacity = 1; 
        this.sound.playSE('revive'); 
        this.showCutin("„Åµ„ÄÄ„Å£„ÄÄ„Åã„ÄÄ„Å§");
        this.log("Â•áË∑°„ÅåËµ∑„Åç„ÅüÔºÅ", "revive");
        await this.delay(500); 
        this.el.flash.style.opacity = 0;
    }

    gameOver() {
        this.state = "GAMEOVER";
        this.sound.stopBGM();
        this.saveData();
        document.getElementById('final-score').textContent = this.lv;
        this.el.modalGo.style.display = "flex";
    }

    showDamage(val, t, c){
        const el = this.el.damagePop; el.textContent = val; el.className = "damage-pop";
        if (t === 'deal') { el.classList.add('deal'); if (c) el.classList.add('crit'); }
        else if (t === 'take') el.classList.add('take'); else if (t === 'heal') el.classList.add('heal'); 
        else if (t === 'block') el.classList.add('block');
        else el.classList.add('miss');
        el.style.animation = "none"; el.offsetHeight; el.style.animation = "pop-damage 0.5s forwards";
    }
    showCutin(t){
        this.el.cutin.innerHTML=t;
        this.el.cutin.style.transform="translate(-50%,-50%) scale(1)";
        setTimeout(()=>this.el.cutin.style.transform="translate(-50%,-50%) scale(0)",1500);
    }
    showChainPop(t) {
        this.el.chainPop.textContent = t;
        this.el.chainPop.style.transform = "translate(-50%,-50%) scale(1.5)";
        this.el.chainPop.style.opacity = 1;
        setTimeout(() => {
             this.el.chainPop.style.transform = "translate(-50%,-50%) scale(1)";
             this.el.chainPop.style.opacity = 0;
        }, 500);
    }
    openHelp() { this.sound.playSE('select'); this.el.modalHelp.style.display="flex"; }
    closeHelp() { this.sound.playSE('select'); this.el.modalHelp.style.display="none"; }
    
    openShop() { 
        this.el.modalGo.style.display="none"; 
        this.el.modalShop.style.display="flex"; 
        this.shopMultiplier = 1; // Reset to 1 on open
        this.updateShopUI();
    }

    setShopMultiplier(val) {
        this.shopMultiplier = val;
        this.sound.playSE('select');
        this.updateShopUI();
    }

    updateShopUI() {
        document.getElementById('shop-gold').textContent = this.gold;
        
        // Update Buttons Visual
        Object.keys(this.el.shopMultBtns).forEach(k => {
             const btn = this.el.shopMultBtns[k];
             if(String(k) === String(this.shopMultiplier)) btn.classList.add('selected');
             else btn.classList.remove('selected');
        });

        // Update Price Labels (Optional Visual Feedback)
        const basePrices = { hp: 500, mp: 500, atk: 1000, def: 1000, luck: 2000 };
        Object.keys(basePrices).forEach(type => {
            const base = basePrices[type];
            let label = `${base}G`;
            if (this.shopMultiplier === 10) label = `${base*10}G`;
            if (this.shopMultiplier === 'MAX') label = `${base}G~`;
            if (this.el.shopCostLabels[type]) this.el.shopCostLabels[type].textContent = label;
        });
    }

    buyBoost(t) {
        let baseCost=0, inc=0; 
        if(t==='hp'){baseCost=500;inc=5;}
        else if(t==='mp'){baseCost=500;inc=2;}
        else if(t==='atk'){baseCost=1000;inc=1;}
        else if(t==='def'){baseCost=1000;inc=1;}
        else if(t==='luck'){baseCost=2000;inc=1;}
        
        let amount = 0;
        if (this.shopMultiplier === 1) amount = 1;
        else if (this.shopMultiplier === 10) amount = 10;
        else if (this.shopMultiplier === 'MAX') {
            amount = Math.floor(this.gold / baseCost);
            if(amount === 0) amount = 1; // Let it fail below naturally
        }

        const totalCost = baseCost * amount;

        if(this.gold >= totalCost){
            this.gold -= totalCost;
            this.boosts[t] += (inc * amount);
            
            // Immediate effect for HP/MP
            if(t === 'hp') { this.maxHp += (inc * amount); this.hp += (inc * amount); }
            if(t === 'mp') { this.maxMp += (inc * amount); this.mp += (inc * amount); }

            this.updateShopUI();
            this.updateHud(); // Reflect maxHp/mp changes immediately
            this.sound.playSE('coin');
            this.saveData();
            
            // Visual feedback
            const label = t.toUpperCase();
            this.log(`${label}„Çí +${inc*amount} Âº∑Âåñ„Åó„ÅüÔºÅ`, "item");

        } else {
            this.sound.playSE('hit'); // Error sound
        }
    }
    
    openLibrary() {
        this.sound.playSE('select'); 
        this.el.modalHelp.style.display = "none"; // Close help if coming from there
        this.el.modalLib.style.display="flex"; 
        document.getElementById('lib-grid').innerHTML="";
        
        const allItems = [...ITEMS];
        Object.keys(SOULS).forEach(key => {
            const s = SOULS[key];
            allItems.push({id:`soul_${key}`, type:"acc", name:s.name, prob:0, sprite:"soul", color:s.color, isSoul:true});
        });

        const total = allItems.length;
        const current = this.acquiredItems.size;
        const percent = Math.floor((current / total) * 100);
        document.getElementById('lib-comp').textContent = `ÂèéÈõÜÁéá: ${percent}%`;

        allItems.forEach(i=>{
            const div=document.createElement('div'); const has=this.acquiredItems.has(i.id);
            div.className=`list-item ${has?'got':''} ${i.isSoul?'soul':''}`;
            let label = "";
            if(i.type==="w") label=`Êîª${i.atk}`; else if(i.type==="a") label=`ÂÆà${i.def}`; else label="Ë£ÖÈ£æ";
            
            // Masking
            const name = has ? i.name.replace(/<rt>.*?<\/rt>/g,"") : "ÔºüÔºüÔºü";
            const icon = has ? generateSVG(SPRITES[i.sprite], i.color) : generateSVG(SPRITES.stick, "#222");
            const stat = has ? label : "---";

            div.innerHTML=`${icon}<div>${name}</div><div>${stat}</div>`;
            document.getElementById('lib-grid').appendChild(div);
        });
    }
    closeLibrary() { this.sound.playSE('select'); this.el.modalLib.style.display="none"; }
}
window.onload = () => { game = new Game(); game.bindDOM(); };
</script>
</body>
</html>
