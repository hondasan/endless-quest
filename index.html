<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ENDLESS QUEST - 宿命の連闘 XXVII -</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #050505;
            --text: #e0e0e0;
            --border: #fff;
            --font: 'DotGothic16', sans-serif;
            --accent-red: #e53935;
            --accent-blue: #1e88e5;
            --accent-yellow: #fdd835;
            --accent-green: #43a047;
            --accent-purple: #9c27b0;
            --window-border: 2px solid #fff;
            --window-radius: 4px;
        }

        body {
            background: var(--bg); color: var(--text); font-family: var(--font);
            margin: 0; display: flex; justify-content: center; align-items: center;
            height: 100vh; overflow: hidden; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .game-container {
            width: 100%; max-width: 600px; height: 100%; max-height: 95vh;
            border: 4px double var(--border); border-radius: 8px; padding: 5px;
            box-sizing: border-box; display: flex; flex-direction: column;
            position: relative; background: #000;
        }

        /* Header & Progress */
        .header-row { display: flex; gap: 5px; align-items: center; margin-bottom: 5px; flex-shrink: 0; }
        .help-btn {
            width: 30px; height: 30px; border: 1px solid #fff; border-radius: 50%;
            background: #222; color: #fff; font-weight: bold;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
        }
        .progress-container {
            flex-grow: 1; height: 10px; background: #222; border: 1px solid #555;
            position: relative; overflow: hidden;
        }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, #333, var(--accent-red));
            width: 0%; transition: width 0.5s;
        }
        .progress-text {
            position: absolute; top: -3px; left: 5px; font-size: 0.7rem; color: #fff; z-index: 2;
        }

        /* HUD */
        .hud {
            display: flex; flex-direction: column; border: var(--window-border);
            border-radius: var(--window-radius); padding: 5px 10px; margin-bottom: 5px;
            font-size: 0.9rem; background: #000; flex-shrink: 0;
        }
        .status-row { display: flex; justify-content: space-between; align-items: center; line-height: 1.3; }
        .val-hp { color: var(--accent-green); font-weight: bold; }
        .val-mp { color: var(--accent-blue); }
        .val-atk { color: var(--accent-red); }
        .val-def { color: var(--accent-blue); }
        .val-gold { color: var(--accent-yellow); }
        .chain-val { color: var(--accent-yellow); font-weight: bold; text-shadow: 0 0 5px orange; }
        .gen-info { 
            font-size: 0.8rem; color: #aaa; border-top: 1px dashed #333; margin-top: 2px; padding-top: 2px;
            display: flex; justify-content: space-between;
        }
        .hp-danger { color: var(--accent-red); animation: blink 0.2s infinite alternate; }
        .aura-indicator { font-size: 0.9rem; font-weight: bold; color: #fff; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }

        /* Stage */
        .stage {
            flex-grow: 1; display: flex; justify-content: center; align-items: center;
            position: relative; background: #111; border: var(--window-border);
            border-radius: var(--window-radius); margin-bottom: 5px; overflow: hidden;
            background-image: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)),
                repeating-linear-gradient(0deg, transparent 0, transparent 2px, #1a1a1a 2px, #1a1a1a 4px),
                repeating-linear-gradient(90deg, transparent 0, transparent 2px, #1a1a1a 2px, #1a1a1a 4px);
            background-size: cover; box-shadow: inset 0 0 50px #000;
        }

        .character {
            width: 160px; height: 160px; position: relative;
            transition: transform 0.2s, filter 0.2s, opacity 0.5s;
            z-index: 5; filter: drop-shadow(0 10px 10px rgba(0,0,0,0.8));
        }

        /* Stage Overlays */
        .flash { position: absolute; top:0; left:0; width:100%; height:100%; background: white; opacity:0; pointer-events:none; z-index:99; transition: opacity 0.1s; }
        .danger-overlay {
            position: absolute; top:0; left:0; right:0; bottom:0;
            box-shadow: inset 0 0 80px 30px rgba(200, 0, 0, 0.6);
            pointer-events: none; z-index: 90;
            animation: pulse-danger 0.8s infinite alternate; display: none;
        }
        @keyframes pulse-danger { from { opacity: 0.3; } to { opacity: 1; } }
        .cutin {
            position: absolute; top:50%; left:50%; transform:translate(-50%,-50%) scale(0);
            font-size: 3rem; color:var(--accent-yellow); -webkit-text-stroke: 2px #000;
            text-shadow: 4px 4px 0 #d32f2f; background:rgba(0,0,0,0.8); padding:10px 30px; border:2px solid #fff;
            z-index:100; transition: transform 0.1s; white-space: nowrap; pointer-events: none;
        }
        .chain-pop {
             position: absolute; top:30%; left:50%; transform:translate(-50%,-50%) scale(0);
             font-size: 4rem; color:var(--accent-yellow); font-weight: bold; font-style: italic;
             text-shadow: 0 0 10px red; pointer-events: none; z-index: 95; opacity: 0;
             transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .damage-pop {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-weight: bold; pointer-events: none; z-index: 20; opacity: 0; text-shadow: 2px 2px 0 #000;
        }
        .damage-pop.deal { top: 40%; font-size: 4rem; color: #fff; }
        .damage-pop.deal.crit { font-size: 5rem; color: #ffeb3b; text-shadow: 3px 3px 0 #d32f2f; z-index: 25; }
        .damage-pop.take { top: 60%; font-size: 4rem; color: #e53935; }
        .damage-pop.heal { top: 50%; font-size: 3rem; color: #43a047; }
        .damage-pop.miss { top: 45%; font-size: 2rem; color: #aaa; }
        @keyframes pop-damage { 0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; } 15% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -60px) scale(1); opacity: 0; } }

        /* Chest Display (In Stage) */
        #chest-display {
            position: absolute; top:0; left:0; width:100%; height:100%;
            display: none; justify-content: center; align-items: center;
            z-index: 40; background: rgba(0,0,0,0.8);
            gap: 10px; padding: 10px; box-sizing: border-box;
        }
        .chest-card {
            background: #111; border: 2px solid #555; border-radius: 6px; padding: 10px;
            width: 45%; max-width: 200px; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 0 10px #000;
        }
        .chest-card.new { border-color: var(--accent-yellow); background: #2a2200; box-shadow: 0 0 15px rgba(255,235,59,0.3); }
        .chest-label { font-size: 0.7rem; color: #aaa; background: #333; padding: 2px 5px; border-radius: 4px; margin-bottom: 5px; width: 100%; text-align: center; }
        .new .chest-label { color: #000; background: var(--accent-yellow); font-weight: bold; }
        .chest-icon { width: 48px; height: 48px; border: 1px solid #444; background: #000; margin-bottom: 5px; display: flex; justify-content: center; align-items: center; }
        .chest-name { font-size: 0.9rem; font-weight: bold; color: #fff; margin-bottom: 2px; text-align: center; height: 2.2em; overflow: hidden; }
        .chest-stat { font-size: 1rem; color: #fff; font-weight: bold; }
        .chest-sub { font-size: 0.7rem; color: #ccc; }
        .chest-arrow { font-size: 2rem; color: #888; }

        /* Gauge */
        .gauge-area {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; height: 30px; background: #000; border: 2px solid #fff; border-radius: 4px;
            display: none; overflow: hidden; box-shadow: 0 0 15px #000; z-index: 30;
        }
        .gauge-bar { width: 100%; height: 100%; background: linear-gradient(90deg, #1e88e5 0%, #fdd835 42%, #e53935 48%, #e53935 52%, #fdd835 58%, #1e88e5 100%); }
        .gauge-cursor { position: absolute; top: 0; bottom: 0; width: 4px; background: #fff; box-shadow: 0 0 8px #fff; left: 0%; }
        .gauge-message { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); color: #f44; font-weight: bold; text-shadow: 1px 1px 0 #000; display: none; }

        /* Log */
        .log-area {
            height: 80px; background: #000; border: var(--window-border); border-radius: var(--window-radius);
            margin-bottom: 5px; padding: 5px; overflow-y: hidden; font-size: 0.85rem; line-height: 1.4;
            display: flex; flex-direction: column-reverse; flex-shrink: 0;
        }
        .log-entry { border-bottom: 1px dashed #333; padding: 1px 0; }
        .log-entry.damage { color: var(--accent-red); }
        .log-entry.critical { color: var(--accent-yellow); font-weight: bold; }
        .log-entry.revive { color: var(--accent-green); }
        .log-entry.item { color: var(--accent-yellow); border: 1px solid #555; background: #222; text-align: center; }

        /* Controls */
        .controls { display: flex; flex-direction: column; height: 120px; flex-shrink: 0; }
        .main-btn { width: 100%; height: 100%; display: none; }
        .command-menu { display: none; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 5px; width: 100%; height: 100%; }

        button {
            border: 2px solid #fff; border-radius: 6px; background: #000; color: #fff;
            font-family: var(--font); font-size: 1.1rem; cursor: pointer; transition: all 0.1s; position: relative;
        }
        button:hover { background: #111; }
        button:active { transform: translateY(2px); }
        button:disabled { border-color: #555; color: #555; pointer-events: none; }
        
        .btn-stop { background: rgba(200, 0, 0, 0.4); color: #fff; font-weight: bold; font-size: 2rem; text-shadow: 2px 2px 0 #000; z-index: 50; }
        
        /* Chest Command Buttons */
        #menu-chest { display: none; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; height: 100%; }
        .btn-get { border-color: var(--accent-yellow); color: var(--accent-yellow); background: #332200; font-weight: bold; font-size: 1.3rem; }
        .btn-discard { border-color: #666; color: #888; background: #111; font-size: 1rem; }

        /* Global Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center; padding: 20px;
            box-sizing: border-box; overflow-y: auto;
        }
        .modal-content { width: 100%; max-width: 500px; background: #111; border: 2px solid #fff; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; gap: 15px; }
        
        .scroll-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 5px; max-height: 300px; overflow-y: auto; }
        .lib-item { border: 1px solid #555; padding: 2px; text-align: center; font-size: 0.6rem; opacity: 0.3; }
        .lib-item.got { border-color: var(--accent-yellow); opacity: 1; background: #111; }
        .shop-btn { padding: 10px; border: 2px solid #fff; text-align: center; cursor: pointer; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.9rem;}
        
        /* Drama */
        .drama-window {
            position: absolute; top: 10px; left: 10px; right: 10px;
            background: rgba(0,0,0,0.95); border: 2px solid #fff; border-radius: 8px;
            padding: 10px; z-index: 80; display: none;
            flex-direction: row; align-items: center; gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
        }
        .drama-window::after { content: ""; position: absolute; bottom: -10px; left: 50%; transform: translateX(-50%); border-width: 10px 10px 0; border-style: solid; border-color: #fff transparent transparent; }
        .drama-actor-box { width: 48px; height: 48px; border: 1px solid #555; background: #222; flex-shrink: 0; }
        .drama-text-box { flex-grow: 1; display: flex; flex-direction: column; text-align: left; }
        .drama-name-label { color: var(--accent-yellow); font-weight: bold; font-size: 0.8rem; margin-bottom: 2px; }
        .drama-lines { font-size: 0.9rem; line-height: 1.3; color: #fff; }

        .click-start { position: absolute; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.9); color: #fff; display: flex; justify-content: center; align-items: center; z-index: 300; font-size: 1.5rem; cursor: pointer; flex-direction:column; gap:20px; text-align:center;}
        .item-get-pop {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: #000; border: var(--window-border); border-radius: var(--window-radius);
            padding: 20px; text-align: center; z-index: 60; width: 80%; box-shadow: 0 0 20px #000; transition: transform 0.3s;
        }

        /* Help */
        .help-content { text-align: left; height: 100%; overflow-y: auto; padding:10px; font-size: 0.9rem; line-height: 1.6; }
        .help-section { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .help-title { color: var(--accent-yellow); font-weight: bold; margin-bottom: 5px; font-size: 1.1rem;}
        .reset-btn { margin-top: 10px; border-color: var(--accent-red); color: var(--accent-red); width: 100%; padding: 10px; }
        
        .anim-shake { animation: shake 0.4s; }
        .anim-lunge { animation: lunge 0.15s; }
        @keyframes shake { 0%{transform:translate(0,0)} 25%{transform:translate(-8px,8px)} 50%{transform:translate(8px,-8px)} 75%{transform:translate(-8px,8px)} 100%{transform:translate(0,0)} }
        @keyframes lunge { 0%{transform: scale(1);} 50% { transform: scale(1.3); } 100%{transform: scale(1);} }
    </style>
</head>
<body>

<div class="game-container">
    <div class="header-row">
        <button class="help-btn" onclick="game.openHelp()">?</button>
        <div class="progress-container">
            <div class="progress-bar" id="progress-bar"></div>
            <div class="progress-text" id="progress-text">魔王城まで ???</div>
        </div>
    </div>

    <div class="hud">
        <div class="status-row">
            <span>第<span id="disp-gen">1</span>代 (Lv<span id="disp-lv">1</span>)</span>
            <span class="gold-val"><span id="disp-gold">0</span> G</span>
        </div>
        <div class="status-row">
            <span>HP:<span id="disp-hp" class="val-hp">30</span></span>
            <span>MP:<span id="disp-mp" class="val-mp">10</span></span>
            <span>攻:<span id="disp-atk" class="val-atk">5</span> 守:<span id="disp-def" class="val-def">0</span></span>
        </div>
        <div class="gen-info">
            <span>E:<span id="disp-weapon">素手</span> / <span id="disp-armor">服</span></span>
            <span class="chain-val">CHAIN: <span id="disp-chain">0</span></span>
        </div>
        <div class="status-row" style="margin-top:2px;">
            <span style="font-size:0.8rem; color:#888;">対: 第<span id="disp-dlv">1</span>代 魔王</span>
            <span class="aura-indicator" id="disp-aura">READY</span>
        </div>
    </div>

    <div class="stage" id="stage">
        <div class="flash" id="flash"></div>
        <div class="danger-overlay" id="danger-overlay"></div>
        <div class="cutin" id="cutin"></div>
        <div class="chain-pop" id="chain-pop"></div>
        
        <!-- Drama Overlay -->
        <div id="drama-window" class="drama-window">
            <div id="drama-actor-box" class="drama-actor-box character"></div>
            <div class="drama-text-box">
                <div id="drama-name" class="drama-name-label">???</div>
                <div id="drama-text" class="drama-lines">...</div>
            </div>
        </div>

        <div class="gauge-area" id="gauge-area">
            <div class="gauge-bar"></div>
            <div class="gauge-cursor" id="gauge-cursor"></div>
            <div class="gauge-message" id="gauge-msg"></div>
        </div>

        <div id="damage-pop" class="damage-pop">0</div>
        <div id="enemy-slot" class="character"></div>

        <!-- NEW Chest Display (In-Stage) -->
        <div id="chest-display">
            <div class="chest-card current">
                <div class="chest-label">装備中</div>
                <div id="cur-icon" class="chest-icon"></div>
                <div id="cur-name" class="chest-name">素手</div>
                <div id="cur-stat" class="chest-stat">攻+0</div>
                <div id="cur-sub" class="chest-sub">なし</div>
            </div>
            <div class="chest-arrow">➡</div>
            <div class="chest-card new">
                <div class="chest-label">宝箱</div>
                <div id="new-icon" class="chest-icon"></div>
                <div id="new-name" class="chest-name">???</div>
                <div id="new-stat" class="chest-stat">攻+?</div>
                <div id="new-sub" class="chest-sub">???</div>
            </div>
        </div>

        <div id="item-pop" class="item-get-pop">
            <div class="item-name">GET!</div>
            <div id="item-icon-slot" class="character" style="margin: 0 auto 10px; width: 64px; height: 64px;"></div>
            <div id="item-name-disp" class="item-name" style="font-size:1.2rem;"></div>
            <div style="color:#fff;">を手に入れた！</div>
        </div>
    </div>

    <div class="log-area" id="log">
        <div class="log-entry system">クリックして冒険の書を開く</div>
    </div>

    <div class="controls">
        <button id="btn-main" class="main-btn" onclick="game.handleMainBtn()">運命の抽選へ</button>
        
        <div id="menu-battle" class="command-menu">
            <button onclick="game.selectAttack()">こうげき</button>
            <button onclick="game.openSkills()">とくぎ</button>
            <button onclick="game.selectHeal()">じゅもん</button>
            <button style="border-color:var(--accent-blue); color:var(--accent-blue);" onclick="game.openLibrary()">ずかん</button>
        </div>
        
        <!-- Chest Menu (Displayed in controls area) -->
        <div id="menu-chest" class="command-menu">
            <button class="btn-get" onclick="game.decideItem(true)">交換して装備</button>
            <button class="btn-discard" onclick="game.decideItem(false)">そのまま進む</button>
        </div>

        <div id="menu-skills" class="command-menu" style="display:none;"></div>

        <button id="btn-stop" class="main-btn btn-stop" style="display:none;" onmousedown="game.stopGauge()" ontouchstart="game.stopGauge()">たたかう！</button>
    </div>

    <!-- Library -->
    <div id="lib-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; width:100%; border-bottom:2px solid #fff; padding-bottom:10px; margin-bottom:10px;">
                <span>冒険の記録</span>
                <button style="width:auto; padding:5px 20px;" onclick="game.closeLibrary()">閉じる</button>
            </div>
            <div id="lib-grid" class="scroll-grid"></div>
        </div>
    </div>
    
    <!-- Help -->
    <div id="help-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; width:100%; border-bottom:2px solid #fff; padding-bottom:10px; margin-bottom:10px;">
                <span>冒険の心得</span>
                <button style="width:auto; padding:5px 20px;" onclick="game.closeHelp()">閉じる</button>
            </div>
            <div class="help-content">
                <div class="help-section"><div class="help-title">目的</div>地下30階の魔王を討伐せよ。</div>
                <div class="help-section"><div class="help-title">CHAIN</div>赤エリアで止めると攻撃力UP＆連鎖。</div>
                <div class="help-section"><div class="help-title">メタル</div>黄色エリアでも50%で撃破可能。</div>
                <div class="help-section">
                    <button class="reset-btn" onclick="game.resetSaveData()">セーブデータを削除して最初から</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Shop -->
    <div id="shop-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="text-align:center; font-size:1.5rem; color:var(--accent-purple);">闇市 - 魂の継承 -</div>
            <div style="text-align:center; margin-bottom:10px;">所持金: <span id="shop-gold" class="gold-val">0</span> G</div>
            <div class="scroll-grid" style="grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="shop-btn" onclick="game.buyBoost('hp')"><div>HP+5</div><div style="color:var(--accent-yellow);">500G</div></div>
                <div class="shop-btn" onclick="game.buyBoost('mp')"><div>MP+2</div><div style="color:var(--accent-yellow);">500G</div></div>
                <div class="shop-btn" onclick="game.buyBoost('atk')"><div>攻+1</div><div style="color:var(--accent-yellow);">1000G</div></div>
                <div class="shop-btn" onclick="game.buyBoost('luck')"><div>運+2%</div><div style="color:var(--accent-yellow);">2000G</div></div>
            </div>
            <button style="margin-top:20px; width:100%; padding:15px;" onclick="game.softReset()">次世代へ託す</button>
        </div>
    </div>

    <div class="game-over-modal modal-overlay" id="modal-go">
        <h1 style="color:red; margin:0; font-size:3rem; text-shadow:2px 2px #fff;">GAME OVER</h1>
        <p>到達: 地下 <span id="final-score">0</span> 階</p>
        <button onclick="game.openShop()" style="padding:15px 40px; margin-top:20px; font-size:1.2rem;">闇市へ</button>
    </div>

    <div class="click-start" id="click-start" onclick="game.initAudio()">
        <div>ENDLESS QUEST XXVII<br>- 悠久の戦記 -</div>
        <div style="font-size:1rem; margin-top:20px;">画面をクリックしてスタート<br>(※音が出ます)</div>
    </div>
</div>

<script>
/** AUDIO */
class SoundManager {
    constructor() { this.ctx = null; this.bgmOscs = []; }
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
    playSE(type) {
        if (!this.ctx) return;
        const t = this.ctx.currentTime; const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
        o.connect(g); g.connect(this.ctx.destination);
        if (type==='select') { o.type='square'; o.frequency.setValueAtTime(440,t); o.frequency.exponentialRampToValueAtTime(880,t+0.05); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.05); o.start(t); o.stop(t+0.05); }
        else if (type==='attack') { o.type='sawtooth'; o.frequency.setValueAtTime(150,t); o.frequency.exponentialRampToValueAtTime(50,t+0.1); g.gain.setValueAtTime(0.1,t); g.gain.exponentialRampToValueAtTime(0.001,t+0.1); o.start(t); o.stop(t+0.1); }
        else if (type==='hit') { o.type='square'; o.frequency.setValueAtTime(100,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.1); o.start(t); o.stop(t+0.1); }
        else if (type==='crit') { o.type='square'; o.frequency.setValueAtTime(880,t); o.frequency.setValueAtTime(1760,t+0.1); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.3); o.start(t); o.stop(t+0.3); }
        else if (type === 'revive') {
            const freqs = [523.25, 659.25, 783.99, 1046.50, 1318.51, 2093.00]; 
            freqs.forEach((f, i) => {
                const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.connect(gain); gain.connect(this.ctx.destination); osc.type = 'triangle'; osc.frequency.value = f;
                gain.gain.setValueAtTime(0, t); gain.gain.linearRampToValueAtTime(0.1, t + i*0.05 + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, t + i*0.05 + 1.5);
                osc.start(t + i*0.05); osc.stop(t + i*0.05 + 1.5);
            });
            o.disconnect();
        } else if (type==='coin') { o.type='sine'; o.frequency.setValueAtTime(1200,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.2); o.start(t); o.stop(t+0.2); }
        else if (type==='metal') { o.type='square'; o.frequency.setValueAtTime(1500,t); g.gain.setValueAtTime(0.1,t); g.gain.linearRampToValueAtTime(0,t+0.05); o.start(t); o.stop(t+0.05); }
    }
    playBGM(type) {
        if (!this.ctx) return; this.stopBGM();
        const o = this.ctx.createOscillator(); const g = this.ctx.createGain(); const f = this.ctx.createBiquadFilter();
        o.connect(f); f.connect(g); g.connect(this.ctx.destination);
        o.type='sawtooth'; f.type='lowpass'; f.frequency.value=300;
        const t = this.ctx.currentTime;
        if(type==='battle'){ o.frequency.setValueAtTime(55,t); g.gain.value=0.05; }
        else if(type==='boss'){ o.frequency.setValueAtTime(40,t); g.gain.value=0.08; }
        else if(type==='clear'){ o.frequency.setValueAtTime(440,t); g.gain.value=0.03; }
        o.start(); this.bgmOscs.push({o,g});
    }
    stopBGM() { this.bgmOscs.forEach(obj=>{try{obj.o.stop();obj.o.disconnect();}catch(e){}}); this.bgmOscs=[]; }
}

/** DATA */
const SAVE_KEY = 'EQ_SAVE_V27';
const WEAPON_PREFIXES = ["古びた", "鉄の", "鋼の", "名工の", "炎の", "氷の", "雷の", "光の", "暗黒の", "神話の"];
const WEAPON_COLORS = ["#888", "#abc", "#fff", "#da8", "#f44", "#48f", "#fd0", "#ff8", "#808", "#4f4"];

function generateSVG(data, colorOverride=null, metal=false) {
    if (!data || !data.pixels) return '<svg viewBox="0 0 16 16"></svg>';
    let rects = ""; const baseColor = colorOverride || data.color;
    data.pixels.forEach(p => { rects += `<rect x="${p.x}" y="${p.y}" width="${p.w}" height="${p.h}" fill="${p.c||baseColor}" shape-rendering="crispEdges"/>`; });
    let filter = "filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.5));";
    if (metal) filter = "filter: drop-shadow(0 0 5px #fff) brightness(1.5) contrast(1.2);";
    return `<svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg" style="image-rendering: pixelated; width: 100%; height: 100%; ${filter}">${rects}</svg>`;
}

const SPRITES = {
    stick: { color: "#a84", pixels: [{x:7,y:3,w:2,h:10}] },
    club: { color: "#953", pixels: [{x:6,y:2,w:4,h:8},{x:7,y:10,w:2,h:3}] },
    copper: { color: "#c84", pixels: [{x:7,y:12,w:2,h:3},{x:5,y:11,w:6,h:1},{x:7,y:1,w:2,h:10,c:"#da8"}] },
    sword: { color:"#ccc", pixels:[{x:7,y:12,w:2,h:3,c:"#444"},{x:5,y:11,w:6,h:1,c:"#666"},{x:6,y:1,w:4,h:10},{x:7,y:2,w:2,h:9,c:"#fff"}] },
    axe: { color:"#888", pixels:[{x:7,y:12,w:2,h:3},{x:7,y:3,w:2,h:9},{x:4,y:2,w:8,h:4},{x:4,y:2,w:1,h:2,c:"#fff"}] },
    spear: { color:"#ccc", pixels:[{x:7,y:12,w:2,h:3},{x:7,y:4,w:2,h:8,c:"#642"},{x:6,y:1,w:4,h:4}] },
    hammer: { color:"#654", pixels:[{x:7,y:6,w:2,h:8,c:"#642"},{x:3,y:2,w:10,h:4}] },
    wand: { color:"#a4a", pixels:[{x:7,y:6,w:2,h:8,c:"#642"},{x:5,y:2,w:6,h:4},{x:6,y:3,w:4,h:2,c:"#fff"}] },
    a_cloth: { color: "#dca", pixels: [{x:4,y:3,w:8,h:10},{x:3,y:4,w:2,h:4},{x:11,y:4,w:2,h:4}] },
    a_leather: { color: "#a64", pixels: [{x:4,y:3,w:8,h:10},{x:3,y:4,w:2,h:4},{x:11,y:4,w:2,h:4},{x:6,y:4,w:4,h:6,c:"#842"}] },
    a_chain: { color: "#888", pixels: [{x:4,y:2,w:8,h:11,c:"#666"},{x:2,y:3,w:12,h:4,c:"#888"},{x:5,y:5,w:6,h:6,c:"#aaa"}] },
    a_iron: { color: "#abc", pixels: [{x:3,y:2,w:10,h:10},{x:2,y:3,w:12,h:4},{x:5,y:4,w:6,h:8,c:"#def"}] },
    a_steel: { color: "#fff", pixels: [{x:3,y:2,w:10,h:11},{x:1,y:3,w:14,h:4},{x:6,y:4,w:4,h:6,c:"#888"}] },
    a_dragon: { color: "#a44", pixels: [{x:2,y:2,w:12,h:12},{x:4,y:4,w:8,h:8,c:"#f84"},{x:6,y:6,w:4,h:4,c:"#fd0"}] },
    a_hero: { color: "#48f", pixels: [{x:2,y:2,w:12,h:12},{x:4,y:4,w:8,h:8,c:"#da0"},{x:6,y:6,w:4,h:4,c:"#f00"}] },
    slime: { color: "#48f", pixels: [{x:7,y:4,w:2,h:2},{x:5,y:6,w:6,h:3},{x:3,y:9,w:10,h:5},{x:2,y:12,w:12,h:2},{x:5,y:8,w:2,h:2,c:"#fff"},{x:6,y:9,w:1,h:1,c:"#000"},{x:9,y:8,w:2,h:2,c:"#fff"},{x:10,y:9,w:1,h:1,c:"#000"},{x:6,y:11,w:4,h:1,c:"#a00"}] },
    bat: { color: "#222", pixels: [{x:2,y:2,w:4,h:4,c:"#404"},{x:10,y:2,w:4,h:4,c:"#404"},{x:5,y:5,w:6,h:6},{x:6,y:6,w:1,h:2,c:"#fff"},{x:9,y:6,w:1,h:2,c:"#fff"}] },
    skeleton: { color: "#ddd", pixels: [{x:6,y:2,w:4,h:4,c:"#fff"},{x:6,y:3,w:1,h:1,c:"#000"},{x:9,y:3,w:1,h:1,c:"#000"},{x:7,y:7,w:2,h:5},{x:5,y:8,w:6,h:1},{x:12,y:5,w:2,h:7,c:"#888"}] },
    knight: { color: "#889", pixels: [{x:6,y:1,w:4,h:5,c:"#aaa"},{x:4,y:6,w:8,h:6},{x:2,y:6,w:2,h:5,c:"#aaa"},{x:12,y:6,w:2,h:5,c:"#aaa"},{x:5,y:12,w:2,h:4,c:"#444"},{x:1,y:4,w:2,h:8,c:"#ccc"}] },
    dragon: { color: "#62a", pixels: [{x:4,y:1,w:3,h:5,c:"#4a2"},{x:6,y:2,w:1,h:1,c:"#fc0"},{x:2,y:3,w:2,h:4,c:"#4a2"},{x:5,y:6,w:6,h:6},{x:0,y:2,w:4,h:8,c:"#a4e"},{x:12,y:2,w:4,h:8,c:"#a4e"},{x:8,y:9,w:6,h:2,c:"#4a2"}] },
    boss: { color: "#222", pixels: [{x:5,y:0,w:6,h:6,c:"#ddd"},{x:6,y:3,w:1,h:1,c:"#f00"},{x:9,y:3,w:1,h:1,c:"#f00"},{x:3,y:6,w:10,h:8},{x:3,y:6,w:10,h:2,c:"#808"},{x:1,y:6,w:2,h:8,c:"#ccc"},{x:13,y:6,w:2,h:8,c:"#ccc"}] },
    goldman: { color: "#fd0", pixels: [{x:4,y:2,w:8,h:6},{x:2,y:4,w:2,h:6},{x:12,y:4,w:2,h:6},{x:5,y:9,w:2,h:5},{x:9,y:9,w:2,h:5},{x:6,y:4,w:1,h:1,c:"#000"},{x:9,y:4,w:1,h:1,c:"#000"}] },
    rabbit: { color: "#da8", pixels: [{x:6,y:2,w:1,h:4},{x:9,y:2,w:1,h:4},{x:5,y:6,w:6,h:5},{x:6,y:7,w:1,h:1,c:"#000"},{x:9,y:7,w:1,h:1,c:"#000"},{x:7,y:9,w:2,h:1,c:"#f88"}] },
    wizard: { color: "#808", pixels: [{x:6,y:2,w:4,h:3,c:"#d0d"},{x:5,y:5,w:6,h:4,c:"#fcc"},{x:4,y:7,w:8,h:7,c:"#808"},{x:12,y:4,w:2,h:8,c:"#a62"},{x:2,y:8,w:2,h:4,c:"#fcc"}] },
    golem: { color: "#b84", pixels: [{x:5,y:1,w:6,h:5,c:"#c96"},{x:6,y:3,w:1,h:1,c:"#000"},{x:9,y:3,w:1,h:1,c:"#000"},{x:2,y:6,w:12,h:6,c:"#c96"},{x:1,y:6,w:2,h:8,c:"#a75"},{x:13,y:6,w:2,h:8,c:"#a75"}] },
    demon: { color: "#a22", pixels: [{x:4,y:1,w:2,h:3,c:"#fff"},{x:10,y:1,w:2,h:3,c:"#fff"},{x:4,y:4,w:8,h:5,c:"#d22"},{x:3,y:9,w:10,h:5,c:"#a22"},{x:0,y:2,w:4,h:6,c:"#202"},{x:12,y:2,w:4,h:6,c:"#202"}] },
    metal_s: { color: "#ccc", pixels: [{x:7,y:5,w:2,h:2,c:"#eee"},{x:5,y:7,w:6,h:3,c:"#ccc"},{x:3,y:10,w:10,h:4,c:"#aaa"},{x:5,y:9,w:2,h:2,c:"#fff"},{x:6,y:10,w:1,h:1,c:"#000"},{x:9,y:9,w:2,h:2,c:"#fff"},{x:10,y:10,w:1,h:1,c:"#000"}] },
    metal_k: { color: "#ddd", pixels: [{x:6,y:1,w:4,h:3,c:"#fd0"},{x:5,y:4,w:6,h:8,c:"#ccc"},{x:3,y:6,w:2,h:6,c:"#ccc"},{x:11,y:6,w:2,h:6,c:"#ccc"},{x:6,y:7,w:1,h:2,c:"#000"},{x:9,y:7,w:1,h:2,c:"#000"},{x:6,y:10,w:4,h:1,c:"#a00"}] },
    asura: { color: "#a4e", pixels: [{x:5,y:1,w:6,h:5,c:"#d8d"},{x:4,y:6,w:8,h:6},{x:2,y:4,w:2,h:4},{x:12,y:4,w:2,h:4},{x:2,y:9,w:2,h:4},{x:12,y:9,w:2,h:4},{x:5,y:12,w:2,h:4,c:"#444"},{x:9,y:12,w:2,h:4,c:"#444"}] },
    general: { color: "#667", pixels: [{x:5,y:0,w:6,h:6,c:"#889"},{x:3,y:6,w:10,h:8,c:"#445"},{x:1,y:6,w:2,h:6,c:"#aaa"},{x:13,y:6,w:2,h:6,c:"#aaa"},{x:5,y:14,w:2,h:2,c:"#222"},{x:9,y:14,w:2,h:2,c:"#222"}] },
    mimic: { color: "#d84", pixels: [{x:3,y:4,w:10,h:8},{x:2,y:4,w:1,h:8},{x:13,y:4,w:1,h:8},{x:4,y:3,w:8,h:1},{x:6,y:6,w:1,h:2,c:"#fff"},{x:9,y:6,w:1,h:2,c:"#fff"},{x:4,y:9,w:8,h:2,c:"#800"}] },
    ghost: { color: "#eee", pixels: [{x:5,y:2,w:6,h:8,c:"#fff"},{x:3,y:6,w:10,h:6,c:"#eee"},{x:5,y:5,w:2,h:2,c:"#000"},{x:9,y:5,w:2,h:2,c:"#000"},{x:6,y:9,w:4,h:2,c:"#f00"}] },
    reaper: { color: "#222", pixels: [{x:6,y:2,w:4,h:4,c:"#fff"},{x:5,y:6,w:6,h:8},{x:2,y:4,w:12,h:2},{x:12,y:2,w:2,h:12,c:"#888"}] },
    chimera: { color: "#d4a", pixels: [{x:4,y:3,w:8,h:6},{x:2,y:4,w:12,h:2},{x:6,y:2,w:4,h:4,c:"#f84"},{x:5,y:9,w:2,h:4},{x:9,y:9,w:2,h:4}] },
    hydra: { color: "#4a4", pixels: [{x:3,y:2,w:3,h:4},{x:7,y:1,w:3,h:5},{x:11,y:2,w:3,h:4},{x:4,y:6,w:9,h:6},{x:3,y:12,w:10,h:3}] },
    dullahan: { color: "#446", pixels: [{x:5,y:6,w:6,h:8},{x:2,y:7,w:2,h:6},{x:12,y:7,w:2,h:6},{x:1,y:8,w:3,h:3,c:"#eec"},{x:10,y:2,w:2,h:10,c:"#888"}] },
    // NPC
    npc_princess: { color: "#fca", pixels: [{x:6,y:2,w:4,h:4,c:"#fa8"},{x:5,y:6,w:6,h:8,c:"#f8a"},{x:4,y:7,w:2,h:4,c:"#fca"},{x:10,y:7,w:2,h:4,c:"#fca"}] },
    npc_king: { color: "#fca", pixels: [{x:5,y:1,w:6,h:5,c:"#fff"},{x:6,y:0,w:4,h:2,c:"#fd0"},{x:4,y:6,w:8,h:8,c:"#a22"},{x:6,y:7,w:4,h:6,c:"#fff"}] },
    npc_friend: { color: "#fca", pixels: [{x:6,y:2,w:4,h:4,c:"#642"},{x:5,y:6,w:6,h:6,c:"#48a"},{x:4,y:7,w:2,h:4,c:"#fca"}] },
    npc_healer: { color: "#fca", pixels: [{x:6,y:2,w:4,h:4,c:"#fcc"},{x:5,y:6,w:6,h:6,c:"#fff"},{x:7,y:8,w:2,h:2,c:"#8f8"},{x:4,y:7,w:2,h:4,c:"#fca"}] },
    npc_mom: { color: "#fca", pixels: [{x:6,y:2,w:4,h:4,c:"#e88"},{x:5,y:6,w:6,h:8,c:"#d44"},{x:4,y:7,w:2,h:4,c:"#fca"},{x:4,y:1,w:8,h:2,c:"#d44"}] },
    npc_cat: { color: "#fff", pixels: [{x:6,y:2,w:4,h:4},{x:5,y:6,w:6,h:6},{x:4,y:7,w:2,h:4},{x:2,y:1,w:2,h:3},{x:12,y:1,w:2,h:3},{x:7,y:4,w:2,h:1,c:"#f88"}] },
    npc_death: { color: "#222", pixels: [{x:5,y:1,w:6,h:6,c:"#ddd"},{x:4,y:5,w:8,h:8,c:"#222"},{x:2,y:4,w:12,h:2,c:"#222"},{x:12,y:2,w:2,h:10,c:"#888"},{x:11,y:2,w:4,h:2,c:"#ccc"}] },
    npc_angel: { color: "#fca", pixels: [{x:6,y:2,w:4,h:4,c:"#fe8"},{x:6,y:6,w:4,h:6,c:"#fff"},{x:2,y:4,w:4,h:6,c:"#fff"},{x:10,y:4,w:4,h:6,c:"#fff"},{x:6,y:0,w:4,h:1,c:"#fd0"}] }
};

const SKILLS = [
    { id: "fire", name: "火炎斬り", mp: 3, dmg: 2.0, msg: "炎が包み込む！" },
    { id: "vac", name: "しんくう斬り", mp: 5, dmg: 2.5, msg: "カマイタチ！" },
    { id: "falcon", name: "はやぶさ斬り", mp: 8, dmg: 1.0, times: 2, msg: "超高速連撃！" },
    { id: "gigadein", name: "ギガデイン", mp: 15, dmg: 5.0, msg: "雷の究極呪文！" },
    { id: "heal", name: "ベホイミ", mp: 5, heal: 60, type: "heal", msg: "傷が癒える！" },
    { id: "smash", name: "兜割り", mp: 4, dmg: 2.2, msg: "脳天直撃！" },
    { id: "all", name: "ぶんまわし", mp: 6, dmg: 1.8, msg: "なぎ払う！" },
    { id: "crit", name: "きゅうしょ突き", mp: 4, dmg: 1.2, msg: "急所を狙う！" },
    { id: "magic", name: "メラミ", mp: 6, dmg: 3.0, msg: "火の玉！" }
];

const ITEMS = [
    { id: "stick", type:"w", name: "ひのきの棒", atk: 2, prob: 0.2, sprite: "stick", color: "#a84" },
    { id: "club", type:"w", name: "こんぼう", atk: 4, prob: 0.15, sprite: "club", color: "#953", skillId: "smash" },
    { id: "cloth", type:"a", name: "布の服", def: 1, prob: 0.2, sprite: "a_cloth", color: "#dca" },
    { id: "leather", type:"a", name: "皮の鎧", def: 3, prob: 0.15, sprite: "a_leather", color: "#a64" },
];
const W_TYPES = [{id:"sword",name:"剣",base:8,sp:"sword",sk:"fire"},{id:"axe",name:"斧",base:10,sp:"axe",sk:"smash"},{id:"spear",name:"槍",base:9,sp:"spear",sk:"crit"},{id:"hammer",name:"槌",base:12,sp:"hammer",sk:"all"},{id:"wand",name:"杖",base:6,sp:"wand",sk:"magic"}];
const A_TYPES = [{id:"chain",name:"鎖帷子",base:5,sp:"a_chain"},{id:"iron",name:"鉄の鎧",base:10,sp:"a_iron"},{id:"steel",name:"鋼の鎧",base:15,sp:"a_steel"},{id:"dragon",name:"竜の鎧",base:22,sp:"a_dragon"},{id:"hero",name:"光の鎧",base:30,sp:"a_hero"}];

W_TYPES.forEach(t=>{ WEAPON_PREFIXES.forEach((pre,i)=>{ ITEMS.push({id:`${t.id}_${i}`,type:"w",name:`${pre}${t.name}`,atk:t.base+(i*5),prob:0.1/(i+1),sprite:t.sp,color:WEAPON_COLORS[i],skillId:t.sk}); }); });
A_TYPES.forEach(t=>{ WEAPON_PREFIXES.forEach((pre,i)=>{ ITEMS.push({id:`${t.id}_${i}`,type:"a",name:`${pre}${t.name}`,def:t.base+(i*3),prob:0.1/(i+1),sprite:t.sp,color:WEAPON_COLORS[i]}); }); });

ITEMS.push(
    { id: "hero_w", type:"w", name: "勇者のつるぎ", atk: 80, prob: 0.005, sprite: "sword", color: "#48f", skillId: "gigadein" },
    { id: "metal_w", type:"w", name: "メタル殺し", atk: 40, prob: 0.01, sprite: "sword", color: "#ccc", skillId: "falcon" }
);

const RATES = [ { name: "絶望", color: "#444", rate: 0.05 }, { name: "旅人", color: "#fff", rate: 0.10 }, { name: "戦士", color: "#48f", rate: 0.20 }, { name: "勇者", color: "#fd0", rate: 0.30 }, { name: "伝説", color: "#f44", rate: 0.50 }, { name: "神話", color: "magenta", rate: 0.65 } ];
const MID_BOSS_NAMES = ["煉獄", "深淵", "絶望", "暴虐", "虚無"];
const MID_BOSS_TITLES = ["の守護者", "の番人", "の四天王", "の騎士", "の魔人"];
const ENEMY_LINES = ["ここを通すわけにはいかん！", "我が剣の錆にしてくれる！", "ほう、ここまで来るとは...", "貴様の運もここまでだ！", "痛みを感じる間もなく終わるぞ", "今日の晩飯は何かな...", "シフト交代まであと少し...", "最近肩こりが酷くてな...", "ローンの支払いが...", "戦いたくないのだが...", "ククク...我は四天王の中でも最弱...", "我が倒れても第二の私が...", "闇の力を見るがいい！", "深淵を覗くとき、深淵もまた...", "我が名は...忘れた！", "ヒャッハー！", "汚物は消毒だー！", "命乞いをするなら今だぞ？", "全力でかかってこい！", "手加減はせんぞ！", "俺のターン！", "ずっと俺のターン！", "その装備、いい値段で売れそうだな", "回復薬は持ったか？", "セーブはこまめにしとけよ", "フフフ...怖いか？", "震えているぞ？", "見切った！", "甘い！", "遅い！", "母ちゃんごめん...", "やめて！HPはもうゼロよ！", "これ以上いじめないで", "平和的解決を望む！", "話せばわかる！"];

let game = null;

class Game {
    constructor() {
        this.sound = new SoundManager();
        this.el = {}; 
        this.resetInternalState();
        this.targetLv = 30; 
        this.gaugeVal = 0; this.gaugeDir = 1; this.gaugeSpeed = 2;
        this.pendingItem = null;
        this.chain = 0;
    }

    bindDOM() {
        this.el = {
            hp: document.getElementById('disp-hp'), mp: document.getElementById('disp-mp'),
            lv: document.getElementById('disp-lv'), atk: document.getElementById('disp-atk'), def: document.getElementById('disp-def'),
            gold: document.getElementById('disp-gold'), gen: document.getElementById('disp-gen'), dlv: document.getElementById('disp-dlv'),
            weapon: document.getElementById('disp-weapon'), armor: document.getElementById('disp-armor'),
            aura: document.getElementById('disp-aura'), chain: document.getElementById('disp-chain'),
            log: document.getElementById('log'), stage: document.getElementById('stage'), enemy: document.getElementById('enemy-slot'),
            bar: document.getElementById('progress-bar'), txt: document.getElementById('progress-text'),
            
            modalGo: document.getElementById('modal-go'), modalShop: document.getElementById('shop-modal'), modalLib: document.getElementById('lib-modal'),
            modalHelp: document.getElementById('help-modal'),
            drama: document.getElementById('drama-window'), flash: document.getElementById('flash'), cutin: document.getElementById('cutin'),
            damagePop: document.getElementById('damage-pop'), chainPop: document.getElementById('chain-pop'),
            dangerOverlay: document.getElementById('danger-overlay'), itemPop: document.getElementById('item-pop'),
            
            menuBattle: document.getElementById('menu-battle'), menuSkills: document.getElementById('menu-skills'), menuChest: document.getElementById('menu-chest'),
            gaugeArea: document.getElementById('gauge-area'), gaugeCursor: document.getElementById('gauge-cursor'), gaugeMsg: document.getElementById('gauge-msg'),
            
            btnMain: document.getElementById('btn-main'), btnStop: document.getElementById('btn-stop'),
            
            chestDisplay: document.getElementById('chest-display'),
            curI: { icon:document.getElementById('cur-icon'), name:document.getElementById('cur-name'), stat:document.getElementById('cur-stat'), sub:document.getElementById('cur-sub') },
            newI: { icon:document.getElementById('new-icon'), name:document.getElementById('new-name'), stat:document.getElementById('new-stat'), sub:document.getElementById('new-sub') },
            
            dramaActor: document.getElementById('drama-actor-box'), dramaName: document.getElementById('drama-name'), dramaText: document.getElementById('drama-text')
        };
    }
    
    resetInternalState() {
        let save = JSON.parse(localStorage.getItem(SAVE_KEY) || 'null');
        if (!save) {
             const oldSave = JSON.parse(localStorage.getItem('EQ_SAVE_V26') || 'null');
             if(oldSave) save = oldSave;
        }

        this.boosts = save?.boosts || { hp: 0, mp: 0, atk: 0, luck: 0 };
        this.clears = save?.clears || 1; 
        if (save) {
            this.generation = save.generation || 1; this.gold = save.gold || 0; this.acquiredItems = new Set(save.library || []);
        } else {
            this.generation = 1; this.gold = 0; this.acquiredItems = new Set();
        }
        this.state = "INIT"; this.lv = 1;
        this.maxHp = 25 + this.boosts.hp; this.hp = this.maxHp;
        this.maxMp = 10 + this.boosts.mp; this.mp = this.maxMp;
        this.baseAtk = 3 + this.boosts.atk;
        this.weapon = null; this.armor = null;
        this.luckBonus = Math.min(0.30, this.boosts.luck * 0.02); 
        this.enemy = { name: "", hp: 0, maxHp: 0, atk: 0, type: "slime" };
        this.chain = 0;
    }
    
    saveData() {
        localStorage.setItem(SAVE_KEY, JSON.stringify({
            generation: this.generation + 1, gold: this.gold, library: Array.from(this.acquiredItems), boosts: this.boosts, clears: this.clears
        }));
    }

    resetSaveData() {
        if(confirm("本当にリセットしますか？この操作は取り消せません。")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }
    
    softReset() {
        this.resetInternalState();
        this.el.log.innerHTML = `<div class='log-entry system'>第${this.generation}代 勇者、魔王討伐へ！</div>`;
        this.el.modalGo.style.display = "none"; this.el.modalShop.style.display = "none";
        this.el.btnMain.textContent = "運命の抽選へ"; this.el.btnMain.style.display = "block";
        this.el.menuBattle.style.display = "none"; this.el.enemy.innerHTML = "";
        this.el.dangerOverlay.style.display = "none"; this.updateHud();
        this.el.aura.textContent = "READY"; this.el.aura.style.color = "#fff";
        this.el.stage.style.boxShadow = "inset 0 0 50px #000";
        this.sound.playSE('select');
    }

    initAudio() {
        this.sound.init(); this.sound.playSE('select');
        document.getElementById('click-start').style.display = 'none';
        this.el.btnMain.style.display = "block";
        this.log(`第${this.generation}代 勇者、冒険の書を開いた！`); this.updateHud();
    }

    log(msg, type = "") {
        const d = document.createElement('div'); d.className = `log-entry ${type}`; d.innerHTML = msg;
        this.el.log.prepend(d);
        if (this.el.log.children.length > 20) this.el.log.removeChild(this.el.log.lastChild);
    }

    renderEnemy(t, metal, boss) { 
        let d = SPRITES[t] || SPRITES.slime; 
        let color = d.color;
        if (!metal && !boss) { const hues = [d.color, "#f44", "#4f4", "#fd0", "#f0f", "#48f"]; color = hues[this.lv % hues.length]; }
        if (t === "asura") color = "#f4f"; if (t === "general") color = "#8af"; 
        if (boss && t === "boss") color = this.clears > 5 ? "#a00" : "#d44"; 
        this.el.enemy.innerHTML = generateSVG({...d, color: color}, null, metal);
    }

    get totalAtk() { return this.baseAtk + (this.weapon ? this.weapon.atk : 0); }
    get totalDef() { return (this.armor ? this.armor.def : 0); }

    updateHud() {
        if(!this.el.hp) return;
        this.el.hp.textContent = this.hp; this.el.mp.textContent = this.mp;
        this.el.lv.textContent = this.lv; this.el.atk.textContent = this.totalAtk; this.el.def.textContent = this.totalDef;
        this.el.gold.textContent = this.gold; this.el.gen.textContent = this.generation; this.el.dlv.textContent = this.clears;
        this.el.weapon.textContent = this.weapon ? this.weapon.name : "素手";
        this.el.armor.textContent = this.armor ? this.armor.name : "服";
        this.el.chain.textContent = this.chain;
        this.el.hp.className = this.hp <= this.maxHp * 0.2 ? "val-hp hp-danger" : "val-hp";
        this.el.dangerOverlay.style.display = this.hp <= this.maxHp * 0.25 ? "block" : "none";
        const prog = Math.min(100, (this.lv / this.targetLv) * 100);
        this.el.bar.style.width = `${prog}%`;
        this.el.txt.textContent = this.lv >= this.targetLv ? "決戦！ 魔王の間" : `魔王城まで あと${this.targetLv - this.lv}階`;
    }

    async delay(ms) { return new Promise(r => setTimeout(r, ms)); }

    // --- MAIN FLOW ---
    handleMainBtn() { this.sound.playSE('select'); if (this.state === "INIT") this.startLottery(); else if (this.state === "BATTLE_WAIT") this.startBattle(); }

    async startLottery() {
        this.state = "LOTTERY"; this.el.btnMain.disabled = true;
        this.log("神の加護を求めて祈る..."); this.sound.playBGM('boss');
        let sel = RATES[0];
        for (let i = 0; i < 15; i++) {
            sel = RATES[Math.floor(Math.random() * RATES.length)];
            this.el.aura.textContent = `${Math.floor(Math.random()*99)}%`;
            this.el.aura.style.color = sel.color;
            if(i%4===0) this.sound.playSE('attack');
            await this.delay(50);
        }
        const r = Math.random();
        if (r < 0.2) sel = RATES[0]; else if (r < 0.5) sel = RATES[1]; else if (r < 0.7) sel = RATES[2];
        else if (r < 0.9) sel = RATES[3]; else if (r < 0.98) sel = RATES[4]; else sel = RATES[5];
        this.revivalRate = Math.min(0.65, sel.rate + this.luckBonus); 
        this.el.aura.textContent = `${Math.floor(this.revivalRate*100)}%`;
        this.el.stage.style.boxShadow = `inset 0 0 30px ${sel.color}`;
        this.showCutin("加護 確定"); this.sound.playSE('crit');
        await this.delay(1000);
        this.el.btnMain.textContent = "魔窟へ"; this.el.btnMain.disabled = false;
        this.state = "BATTLE_WAIT"; this.sound.stopBGM();
    }

    startBattle() {
        this.state = "BATTLE_CMD"; this.el.btnMain.style.display = "none"; this.el.menuBattle.style.display = "grid"; this.el.itemPop.style.transform = "scale(0)";
        if (this.lv >= this.targetLv) { this.startBossBattle("boss"); return; }
        if (this.lv === 10 || this.lv === 20) { this.startBossBattle("mid"); return; }
        this.sound.playBGM('battle');
        let type = "slime", eName = "スライム", gauge="normal", metal=false, goldMult=1, expMult=1;
        const tier = Math.floor((this.lv - 1) / 3);
        if (Math.random() < 0.1) { 
            if (Math.random() < 0.5) { type="metal_s"; eName="メタルスライム"; gauge="fast"; metal=true; expMult=20; }
            else { type="goldman"; eName="ゴールドマン"; gauge="normal"; goldMult=30; }
        } else {
            const types = ["slime", "bat", "rabbit", "skeleton", "knight", "wizard", "golem", "demon", "dragon", "ghost", "mimic", "reaper"];
            type = types[Math.min(tier, types.length-1)] || "slime";
            const pres = ["", "凶暴な", "歴戦の", "暗黒の", "真・"];
            const pre = pres[Math.min(Math.floor(this.lv/6), 4)];
            eName = pre + (type === "slime" ? "スライム" : (type==="mimic"?"人食い箱": (type==="reaper"?"死神": (type==="ghost"?"ゴースト":type))));
            gauge = tier > 2 ? (tier > 5 ? "super_fast" : "fast") : "normal";
            
            if (type === "ghost") gauge = "blink";
            if (type === "mimic") gauge = "stop_go";
            if (type === "reaper") gauge = "reverse";
            if (tier > 7 && Math.random() < 0.3) gauge = "wavy";
        }
        let diff = 1 + (this.clears * 0.2); 
        this.enemy = { name: eName, type: type, maxHp: Math.floor((10+this.lv*5)*diff), hp: Math.floor((10+this.lv*5)*diff), atk: Math.floor((3+this.lv*2)*diff), gaugeType: gauge, isMetal: metal, expMult, goldMult };
        this.renderEnemy(type, metal);
        this.el.enemy.style.opacity = 0;
        this.el.enemy.style.transform = "scale(0.5)";
        requestAnimationFrame(() => { 
             this.el.enemy.style.transition = "all 0.5s";
             this.el.enemy.style.opacity = 1; 
             this.el.enemy.style.transform = "scale(1)";
        });
        
        if (Math.random() < 0.6) { 
            const line = ENEMY_LINES[Math.floor(Math.random() * ENEMY_LINES.length)];
            this.showBattleTalk(line, 2000);
        }
        
        this.log(`${this.enemy.name} があらわれた！`);
    }
    
    async startBossBattle(type) {
        this.sound.playBGM('boss');
        const isMaou = type === "boss";
        const diff = 1 + (this.clears * 0.5); 
        let name = isMaou ? `第${this.clears}代 魔王` : "魔界の番人";
        let eType = isMaou ? "boss" : (Math.random() < 0.5 ? "asura" : "general");
        if (!isMaou) {
             const n1 = MID_BOSS_NAMES[Math.floor(Math.random()*MID_BOSS_NAMES.length)];
             const n2 = MID_BOSS_TITLES[Math.floor(Math.random()*MID_BOSS_TITLES.length)];
             name = `${n1}${n2}`;
        }
        // Fixed: Reduced EXP mult for bosses to prevent skipping floors
        this.enemy = { name: name, type: eType, maxHp: Math.floor((isMaou?500:250)*diff), hp: Math.floor((isMaou?500:250)*diff), atk: Math.floor((isMaou?50:35)*diff), gaugeType: "super_fast", isMetal: false, expMult: 3, goldMult: 100 };
        
        this.renderEnemy(this.enemy.type, false, true);
        this.el.stage.style.background = "#301";
        this.el.enemy.style.opacity = 0;
        this.el.enemy.style.transform = "scale(2)";
        requestAnimationFrame(() => { 
             this.el.enemy.style.transition = "all 2s";
             this.el.enemy.style.opacity = 1; 
             this.el.enemy.style.transform = "scale(1.2)";
        });
        
        const lines = isMaou ? ["よくぞ来た、人間よ...", "我が代で貴様らを根絶やしにする！", "力の差を教えてやろう..."] : ["ククク…奴は四天王の中でも最弱…", "ここを通すわけにはいかん！", "貴様の首、貰い受ける！", "シフト交代の時間なのだが...", "トイレに行ってる隙をつくとは..."];
        this.showBattleTalk(lines[Math.floor(Math.random()*lines.length)], 4000);
        this.showCutin(isMaou ? "魔王 降臨" : "強敵 出現");
    }
    
    showBattleTalk(text, duration, actorKey = null, nameOverride = null) {
        this.el.drama.style.display = "flex";
        const key = actorKey || this.enemy.type;
        const name = nameOverride || this.enemy.name;
        this.el.dramaActor.innerHTML = generateSVG(SPRITES[key] || SPRITES.slime);
        this.el.dramaName.textContent = name;
        this.el.dramaText.textContent = text;
        if (this.dramaTimer) clearTimeout(this.dramaTimer);
        this.dramaTimer = setTimeout(() => { this.el.drama.style.display = "none"; }, duration);
    }

    // --- COMBAT ---
    selectAttack() { this.sound.playSE('select'); this.selectedSkill = null; this.el.menuBattle.style.display = "none"; this.startGauge(); }
    selectHeal() { this.sound.playSE('select'); if(this.mp<5){this.log("MP不足！");return;} this.useSkill(SKILLS.find(s=>s.id==="heal")); }
    
    openSkills() {
        this.sound.playSE('select'); this.el.menuBattle.style.display = "none"; this.el.menuSkills.style.display = "grid"; this.el.menuSkills.innerHTML = "";
        const addBtn = (s) => {
            const b = document.createElement('button'); b.innerHTML = `${s.name}<br><span style="font-size:0.8rem">MP:${s.mp}</span>`;
            b.onclick = () => this.useSkill(s); if(this.mp<s.mp) b.disabled=true; this.el.menuSkills.appendChild(b);
        };
        if(this.weapon && this.weapon.skillId) addBtn(SKILLS.find(s=>s.id===this.weapon.skillId));
        if(this.lv>=3) addBtn(SKILLS.find(s=>s.id==="heal"));
        const back = document.createElement('button'); back.textContent="もどる"; back.onclick=()=>{this.sound.playSE('select');this.el.menuSkills.style.display="none";this.el.menuBattle.style.display="grid";};
        this.el.menuSkills.appendChild(back);
    }
    
    useSkill(skill) {
        this.sound.playSE('select'); this.mp -= skill.mp; this.updateHud();
        if(skill.type==="heal") {
            let h = skill.heal + Math.floor(Math.random()*10) + this.boosts.atk;
            this.hp = Math.min(this.maxHp, this.hp+h); this.updateHud(); this.showDamage(h, 'heal', false);
            this.log(`${skill.name}！ 体力が ${h} 回復した！`, "revive"); this.sound.playSE('revive');
            this.el.menuSkills.style.display="none"; setTimeout(()=>this.enemyTurn(),800);
        } else {
            this.selectedSkill = skill; this.el.menuSkills.style.display="none"; this.startGauge();
        }
    }

    startGauge() {
        this.state = "GAUGE"; this.el.btnStop.style.display="block"; this.el.gaugeArea.style.display="block";
        this.gaugeVal=0; this.gaugeDir=1;
        this.gaugeSpeed = (2 + (this.lv*0.1)) * (this.enemy.gaugeType==="fast"?1.5:(this.enemy.gaugeType==="super_fast"?2.5:1));
        if(this.enemy.gaugeType === "slow") this.gaugeSpeed = 0.5;
        this.el.gaugeCursor.style.opacity = 1;
        this.runGauge();
    }
    runGauge() {
        if(this.state!=="GAUGE") return;
        let spd = this.gaugeSpeed;
        const t = this.enemy.gaugeType;
        if (t === "stop_go") { if (Math.random() < 0.1) spd = 0; }
        else if (t === "blink") { this.el.gaugeCursor.style.opacity = (Math.floor(Date.now() / 100) % 2) ? 0 : 1; }
        else if (t === "wavy") { spd = this.gaugeSpeed * (Math.sin(Date.now() / 200) + 1.5); }
        if (t === "reverse") { if (this.gaugeDir === 1) this.gaugeVal -= spd; else this.gaugeVal += spd; } else { this.gaugeVal += spd * this.gaugeDir; }

        if(this.gaugeVal>=100){this.gaugeVal=100;this.gaugeDir=-1;} if(this.gaugeVal<=0){this.gaugeVal=0;this.gaugeDir=1;}
        this.el.gaugeCursor.style.left = this.gaugeVal+"%"; requestAnimationFrame(()=>this.runGauge());
    }
    
    // MODIFIED CHAIN SYSTEM
    async stopGauge() {
        if(this.state!=="GAUGE") return; this.state="ANIM"; this.el.btnStop.style.display="none";
        this.sound.playSE('attack');
        let dist = Math.abs(50-this.gaugeVal), mult=1.0, isCrit=false;
        
        // Strict Chain Rule: Only Perfect (<5) counts
        if(dist <= 5) {
            this.chain++; 
            isCrit = true;
            mult = 1.2 + (this.chain * 0.3); // High scaling
            this.showChainPop(`${this.chain} CHAIN!`);
        } else if (dist <= 15) { // Yellow zone
            // New logic: Metal Killer Chance
            if (this.enemy.isMetal && Math.random() < 0.5) {
                isCrit = true; // Upgrade to crit (instakill for metal)
                this.log("ラッキー！急所に当たった！", "critical");
            }
            mult = 1.0; 
            this.chain = 0;
        } else {
            if(this.chain > 0) this.log("CHAINが途切れた...", "damage");
            this.chain = 0;
            mult = 0.5;
        }
        
        await this.delay(300); this.el.gaugeArea.style.display="none";
        await this.performAttack(mult, isCrit);
    }

    async performAttack(mult, isCrit) {
        this.el.enemy.classList.add("anim-shake"); 
        let dmgBase = this.totalAtk * (this.selectedSkill ? this.selectedSkill.dmg : 1.0);
        let times = this.selectedSkill && this.selectedSkill.times ? this.selectedSkill.times : 1;
        
        for(let i=0; i<times; i++) {
            let dmg = Math.floor(dmgBase * mult);
            if(this.enemy.isMetal) {
                // Instakill if crit (even from yellow zone luck)
                dmg = (isCrit || (this.weapon&&this.weapon.id==="metal_w")) ? this.enemy.maxHp : (Math.random()<0.5 ? 0 : 1);
                if(dmg>0) this.sound.playSE('metal');
            } else {
                if(isCrit) { this.showCutin("会心の一撃"); this.sound.playSE('crit'); } else { this.sound.playSE('hit'); }
            }
            if(dmg>0) { 
                this.log(`${this.enemy.name}に ${dmg} のダメージ！`, isCrit ? "critical" : "");
                this.showDamage(dmg, 'deal', isCrit); this.enemy.hp-=dmg; 
            } else { 
                this.log(`ミス！ ${this.enemy.name}にダメージを与えられない！`); this.showDamage("Miss", 'miss', false); 
            }
            await this.delay(200);
        }
        this.updateHud(); this.el.enemy.classList.remove("anim-shake");
        if(this.enemy.hp<=0) this.winBattle(); else this.enemyTurn();
    }

    async enemyTurn() {
        await this.delay(400);
        
        if (this.enemy.isMetal && Math.random() < 0.5) {
            this.log(`${this.enemy.name}は逃げ出した！`, "system");
            this.el.enemy.style.opacity = 0;
            await this.delay(1000);
            this.state = "BATTLE_WAIT"; 
            this.el.btnMain.style.display = "block";
            this.el.btnMain.textContent = "さらに奥へ";
            return;
        }

        this.log(`${this.enemy.name}のこうげき！`, "damage");
        this.el.enemy.classList.add("anim-lunge");
        
        let dmg = Math.max(1, this.enemy.atk - Math.floor(Math.random()*3));
        // Defense Calc
        dmg = Math.max(1, Math.floor(dmg - (this.totalDef / 2)));
        if(Math.random()<0.15 && !this.enemy.isMetal) { dmg=Math.floor(dmg*1.5); this.log("痛恨の一撃！","damage"); }
        this.hp-=dmg; this.updateHud(); 
        this.log(`${dmg} のダメージを受けた！`, "damage"); this.showDamage(dmg, 'take', false); this.sound.playSE('hit');
        this.el.stage.style.transform = "translate(5px, 5px)"; setTimeout(() => this.el.stage.style.transform = "translate(0, 0)", 100);
        this.el.enemy.classList.remove("anim-lunge");

        if (this.hp <= 0) {
            this.sound.stopBGM();
            await this.tryRevival();
        } else {
            this.state = "BATTLE_CMD";
            this.el.menuBattle.style.display = "grid";
        }
    }

    // --- WIN & DROP ---
    async winBattle() {
        if (this.enemy.type === "boss") {
            this.sound.stopBGM();
            this.sound.playBGM('clear');
            this.log(`魔王を倒した！`, "critical");
            this.el.enemy.style.transition = "all 2s";
            this.el.enemy.style.opacity = 0;
            this.el.enemy.style.filter = "brightness(5)";
            this.showCutin("完全勝利");
            await this.delay(3000);
            
            this.clears++;
            this.gold += 10000;
            this.saveData();
            
            this.log("世界に平和が戻った...", "revive");
            this.log(`クリア回数: ${this.clears}`, "revive");
            await this.delay(2000);
            
            this.el.stage.style.background = "#111"; 
            this.openShop();
            return;
        }

        this.log(`${this.enemy.name}をやっつけた！`, "critical");
        this.sound.playSE('select'); 
        this.el.enemy.style.transition = "opacity 1s, transform 1s";
        this.el.enemy.style.opacity = 0;
        this.el.enemy.style.transform = "scale(0.1) rotate(180deg)";
        await this.delay(1000);
        
        // FIXED: Only advance 1 floor
        this.lv += 1;
        
        // Status gains use multiplier
        const mult = this.enemy.expMult;
        this.maxHp += 4 * mult; 
        this.hp = Math.min(this.maxHp, this.hp + 20);
        this.baseAtk += 1 * mult; 
        this.maxMp += 2 * mult; 
        this.mp += 2 * mult;
        
        let g = Math.floor((10 + this.lv*2)*this.enemy.goldMult); this.gold+=g;
        this.updateHud(); 
        if (mult > 1) {
             this.log(`${g}G 獲得。大量の経験値を得た！(Lv+1)`);
        } else {
             this.log(`${g}G 獲得。Lv${this.lv}に！`);
        }
        this.sound.playSE('coin');
        await this.checkDrop();
        // NOTE: state transition handled in decideItem or here if no drop?
        // Logic: checkDrop calls showItemCompare -> decideItem -> BATTLE_WAIT
        // BUT checkDrop is async and only shows if drop. So if no drop...
    }

    async checkDrop() {
        if (Math.random() < 0.4) { 
            let drop = ITEMS[Math.floor(Math.random()*ITEMS.length)]; 
            this.acquiredItems.add(drop.id);
            this.pendingItem = drop;
            await this.showItemCompare(drop);
        } else {
            this.state="BATTLE_WAIT"; this.el.btnMain.textContent="さらに奥へ"; this.el.btnMain.style.display="block"; this.sound.playBGM('battle');
        }
    }
    
    showItemCompare(item) {
        return new Promise(resolve => {
            this.el.menuBattle.style.display = "none";
            this.el.chestDisplay.style.display = "flex";
            this.el.enemy.style.display = "none"; // Hide enemy slot
            
            // Show Chest Command Menu
            this.el.menuChest.style.display = "grid";
            
            const isArmor = item.type === "a";
            const cur = isArmor ? (this.armor || {name:"服", def:0, sprite:"a_cloth", color:"#fff"}) : (this.weapon || {name:"素手", atk:0, skillId:null, sprite:"stick", color:"#fff"});
            
            this.renderCard(this.el.curI, cur, isArmor);
            this.renderCard(this.el.newI, item, isArmor);
            
            this.resolveItem = resolve;
        });
    }
    
    renderCard(els, item, isArmor) {
        if(!els.name) return; // Guard
        els.name.textContent = item.name;
        els.icon.innerHTML = generateSVG(SPRITES[item.sprite], item.color);
        if (isArmor) {
            els.stat.textContent = `守+${item.def}`; els.stat.className = "chest-stat";
            if(els.sub) els.sub.textContent = "";
        } else {
            els.stat.textContent = `攻+${item.atk}`; els.stat.className = "chest-stat";
            // Safe skill lookup
            let sName = "なし";
            if (item.skillId) {
                const s = SKILLS.find(k => k.id === item.skillId);
                if (s) sName = `特技:${s.name}`;
            }
            if(els.sub) els.sub.textContent = sName;
        }
    }
    
    decideItem(take) {
        if(take) {
            if (this.pendingItem.type === "a") this.armor = this.pendingItem; else this.weapon = this.pendingItem;
            this.log(`${this.pendingItem.name}を装備した！`, "item"); this.sound.playSE('revive');
        } else { this.log("宝箱をあきらめた。", "system"); }
        
        this.el.chestDisplay.style.display = "none"; 
        this.el.menuChest.style.display = "none";
        this.el.enemy.style.display = "block"; // Restore enemy slot for next battle
        
        this.updateHud(); 
        
        // Go to Next
        this.state="BATTLE_WAIT"; this.el.btnMain.textContent="さらに奥へ"; this.el.btnMain.style.display="block"; this.sound.playBGM('battle');
        
        if(this.resolveItem) this.resolveItem();
    }

    async tryRevival() {
        this.state="REVIVAL"; this.log("勇者は力尽きた...","damage"); await this.delay(1500);
        this.log("運命の判定...", "system"); await this.delay(1000);
        if (Math.random() < this.revivalRate) {
            await this.playRevivalDrama();
            this.hp = Math.floor(this.maxHp * 0.6);
            this.updateHud();
            this.sound.playBGM('boss');
            this.state = "BATTLE_CMD";
            this.el.menuBattle.style.display = "grid";
        } else {
            this.log("......", "system");
            await this.delay(1000);
            this.gameOver();
        }
    }

    async playRevivalDrama() {
        const dramas = [
            [{a:"npc_princess",n:"王女",t:"勇者様！ 死なないで！"},{a:"npc_princess",n:"王女",t:"私の祈りよ...届け！！"}],
            [{a:"npc_friend",n:"戦友",t:"おい！ ここでくたばるのか？"},{a:"npc_friend",n:"戦友",t:"立て！ 俺が盾になる！！"}],
            [{a:"npc_king",n:"王様",t:"ええい！ 情けないやつめ！"},{a:"npc_king",n:"王様",t:"特別にもう一度 チャンスをやろう..."}],
            [{a:"npc_healer",n:"神父",t:"おお神よ..."},{a:"npc_healer",n:"神父",t:"この者に 加護を与えたまえ！"}]
        ];
        const scene = dramas[Math.floor(Math.random() * dramas.length)];
        
        // Show Drama Window
        this.el.drama.style.display = "flex";
        
        for (const step of scene) {
             this.el.dramaActor.innerHTML = generateSVG(SPRITES[step.a] || SPRITES.slime);
             this.el.dramaName.textContent = step.n;
             this.el.dramaText.textContent = step.t;
             this.sound.playSE('select');
             await this.delay(2500);
        }
        
        this.el.drama.style.display = "none";
        this.el.flash.style.opacity = 1; 
        this.sound.playSE('revive'); 
        this.showCutin("ふ　っ　か　つ");
        this.log("奇跡が起きた！", "revive");
        await this.delay(500); 
        this.el.flash.style.opacity = 0;
    }

    gameOver() {
        this.state = "GAMEOVER";
        this.sound.stopBGM();
        this.saveData();
        document.getElementById('final-score').textContent = this.lv;
        this.el.modalGo.style.display = "flex";
    }

    showDamage(val, t, c){
        const el = this.el.damagePop; el.textContent = val; el.className = "damage-pop";
        if (t === 'deal') { el.classList.add('deal'); if (c) el.classList.add('crit'); }
        else if (t === 'take') el.classList.add('take'); else if (t === 'heal') el.classList.add('heal'); else el.classList.add('miss');
        el.style.animation = "none"; el.offsetHeight; el.style.animation = "pop-damage 0.5s forwards";
    }
    showCutin(t){this.el.cutin.textContent=t;this.el.cutin.style.transform="translate(-50%,-50%) scale(1)";setTimeout(()=>this.el.cutin.style.transform="translate(-50%,-50%) scale(0)",1500);}
    showChainPop(t) {
        this.el.chainPop.textContent = t;
        this.el.chainPop.style.transform = "translate(-50%,-50%) scale(1.5)";
        this.el.chainPop.style.opacity = 1;
        setTimeout(() => {
             this.el.chainPop.style.transform = "translate(-50%,-50%) scale(1)";
             this.el.chainPop.style.opacity = 0;
        }, 500);
    }
    openHelp() { this.sound.playSE('select'); this.el.modalHelp.style.display="flex"; }
    closeHelp() { this.sound.playSE('select'); this.el.modalHelp.style.display="none"; }
    
    // Add openShop/buyBoost methods
    openShop() { this.el.modalGo.style.display="none"; this.el.modalShop.style.display="flex"; document.getElementById('shop-gold').textContent=this.gold; }
    buyBoost(t) {
        let c=0,i=0; if(t==='hp'){c=500;i=5;}if(t==='mp'){c=500;i=2;}if(t==='atk'){c=1000;i=1;}if(t==='luck'){c=2000;i=1;}
        if(this.gold>=c){this.gold-=c;this.boosts[t]+=i;document.getElementById('shop-gold').textContent=this.gold;this.sound.playSE('coin');this.saveData();} else this.sound.playSE('hit');
    }
    openLibrary() {
        this.sound.playSE('select'); this.el.modalLib.style.display="flex"; document.getElementById('lib-grid').innerHTML="";
        ITEMS.forEach(i=>{
            const div=document.createElement('div'); const has=this.acquiredItems.has(i.id);
            div.className=`lib-item ${has?'got':''}`;
            const label = i.type === "w" ? `攻${i.atk}` : `守${i.def}`;
            div.innerHTML=`${has?generateSVG(SPRITES[i.sprite],i.color):generateSVG(SPRITES.stick,"#333")}<div>${has?i.name:"???"}</div><div>${label}</div>`;
            document.getElementById('lib-grid').appendChild(div);
        });
    }
    closeLibrary() { this.sound.playSE('select'); this.el.modalLib.style.display="none"; }
}
window.onload = () => { game = new Game(); game.bindDOM(); };
</script>
</body>
</html>
